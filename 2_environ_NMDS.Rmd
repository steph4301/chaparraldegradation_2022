
### library
```{r install libraries, message=FALSE}

library(tidyverse) # includes ggplot2 - data visulization, dplyr, tidyr, readr, purr, tibble, stringr, forcats
library(ggpubr) # customize ggplot2 for publication
library(broom)
library(AICcmodavg)
library(vegan)
library(readxl) # for .xls and .xlsx sheets
library(janitor)
library(calecopal) 
library(multcompView)
library(plotly)
if (!require(devtools)) {
  install.packages("devtools")
}
devtools::install_github("gavinsimpson/ggvegan")
library(here)
library(ggpmisc)
```


#### load data

```{r load data}
extracted_load <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022/chaparraldegradation_2022/Extracted_Elevation_Slope_Aspect_Hillshade_20m.csv", header = TRUE, na.strings=c("","NA")) 

# names(extracted_load)

extracted_prep <- extracted_load%>% 
  dplyr::select(c(elevation, slope, hillshade, system_ind, southwestness, lat, long)) %>% # twi, fire history
    rename(site_rep = system_ind) %>% 
 filter(site_rep != "1.03") %>% 
# “southwest-ness” is calculated using: cos (aspect - 225°)
      mutate(site_rep = case_when(site_rep == "1.1" ~ "1.10", # old ~ new
                                   site_rep == "2.1" ~ "2.10",
                                   site_rep == "2.2" ~ "2.20",
                                  site_rep == "INT1" ~ "INT1_1",
                                    site_rep == "INT2" ~ "INT2_1",
                                    site_rep == "INT3" ~ "INT3_1",
                                    site_rep == "INT4" ~ "INT4_1",
                                    site_rep == "INT5" ~ "INT5_1",
                                   TRUE ~ site_rep)) %>% 
     mutate(
      hillshade = as.numeric(hillshade),
      elevation = as.integer(elevation),
      slope = as.numeric(slope),
      site_rep = as.character(site_rep)
      ) 

extracted_prep$site_rep <- gsub("\\.", "_", extracted_prep$site_rep)

# view(extracted)
# length(extracted$site_rep)    # n = 39
```

# load cluster data
```{r}
clusters_load <- read.csv("twinspan_percentcover.csv")

rownames(clusters_load) <- clusters_load[,1]
clusters_load[,1] <- NULL

clusters_spp <- clusters_load %>% 
  dplyr::select(!c(site, site_rep))

diss_matrix <- vegdist(clusters_spp, method = "bray")  # Bray-Curtis dissimilarity

# Step 3: Perform hierarchical clustering
clustering <- hclust(diss_matrix, method = "ward.D2")  # Ward's method

# Step 4: Plot the dendrogram
# plot(clustering, labels = rownames(data), main = "Hierarchical Clustering Dendrogram")
plot(clustering, labels = clusters_load$site_rep, main = "Hierarchical Clustering Dendrogram")


# Optionally, cut the tree to form clusters
cluster_5 <- cutree(clustering, k = 5)  # Cut the tree into 4 clusters
table(cluster_5)
clusters_load$cluster_5 <- cluster_5

cluster_6 <- cutree(clustering, k = 6)  # Cut the tree into 4 clusters
table(cluster_6)
clusters_load$cluster_6 <- cluster_6

clusters_lables <- clusters_load %>% 
  dplyr::select(c(site_rep, cluster_5, cluster_6)) %>% 
   mutate(site_rep = case_when(site_rep == "1_1" ~ "1_01", # old ~ new
                               site_rep == "1_2" ~ "1_02",
                               site_rep == "1_3" ~ "1_03",
                               site_rep == "1_4" ~ "1_04",
                               site_rep == "1_5" ~ "1_05",
                               site_rep == "1_6" ~ "1_06",
                               site_rep == "1_7" ~ "1_07",
                               site_rep == "1_8" ~ "1_08",
                               site_rep == "1_9" ~ "1_09",
                               site_rep == "2_1" ~ "2_01",
                               site_rep == "2_2" ~ "2_02",
                               site_rep == "2_3" ~ "2_03",
                               site_rep == "2_4" ~ "2_04",
                               site_rep == "2_5" ~ "2_05",
                               site_rep == "2_6" ~ "2_06",
                               site_rep == "2_7" ~ "2_07",
                               site_rep == "2_8" ~ "2_08",
                               site_rep == "2_9" ~ "2_09",
                                   TRUE ~ site_rep)) %>% 
    mutate(
      cluster_5 = as.character(cluster_5),
    cluster_6 = as.character(cluster_6)
      ) 


extracted <- extracted_prep %>% 
  left_join(clusters_lables, by = "site_rep")
```

# Prepare data for an NMDS (numbers only)

```{r}
prep <- extracted %>%  
  dplyr::select(c(elevation, slope, hillshade, southwestness, lat, long))
```


# NMDS
```{r nmds by species percent cover}

# the AUTOTRANSFORM = F skips the automatic data transformations and uses the input data as is
# - when the raw data contains the information you need (e.g., abundance)
# - when you have a small number of samples or small number of variables
# - when you want to preserve the original scale of the data (e.g., interested in the absolute differences betwen two sets of measurements)

environNMDS <- metaMDS(prep,
                                  autotransform = F, # or T
                                  distance = "bray",   # bray or "raup"
                  k = 2, #dimentions
                 try = 100, #runs
                 trymax = 100) # this is more appropriate for my data


# uses the RAUP-CRICK dissimilarity index to calculate pairwise dissimilarities
# - adjusts for spp richness
# - downweights importance of rare spp 
# - more useful when interested in community STRUCTURE rather than individual species
# - takes into account differences in species evenness
# abcover_byspecies_NMDS <- metaMDS(abcover_byspecies_nmdsprep_num, distance = "raup") 
environNMDS
```

### stress test

```{r stress tests nmds}
stressplot(environNMDS)
# if stress tests are really low ==> I may have insufficient data. :/

plot(environNMDS)
ordiplot(environNMDS, type = "p")
ordiplot(environNMDS, type = "t")
# ab_nmds.fort <- fortify(as.data.frame(abcover_byspecies_NMDS))
```



```{r scores nmds}

scores(environNMDS)

# plot_df <- scores(abcover_byspecies_NMDS, display = "sites") %>% # from An's code
#  as.data.frame() %>%
#  rownames_to_column("stand_core") %>%
#  full_join(seedbank_bysitecore, by = "stand_core")

environNMDS_df <- data.frame(environNMDS$points, extracted) 
head(environNMDS_df)
```




# figure 

```{r ggplot percent cover by environ}

ggplot(environNMDS_df,  
       aes(x = MDS1, y = MDS2, color = cluster_5)) +
  geom_point(size = 5, alpha = 0.8) +
  theme_bw() +
  labs(title = "NMDS of transects by environmental variables") +
   theme_bw() +
   stat_ellipse(level = .95, linetype = 2, linewidth = 1) +
    labs(title = "Transects by environmental variables", color = cluster_5)

```





