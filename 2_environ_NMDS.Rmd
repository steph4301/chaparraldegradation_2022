
### library
```{r install libraries, message=FALSE}

library(tidyverse) # includes ggplot2 - data visulization, dplyr, tidyr, readr, purr, tibble, stringr, forcats
library(ggpubr) # customize ggplot2 for publication
library(broom)
library(AICcmodavg)
library(vegan)
library(readxl) # for .xls and .xlsx sheets
library(janitor)
library(calecopal) 
library(multcompView)
library(plotly)
if (!require(devtools)) {
  install.packages("devtools")
}
devtools::install_github("gavinsimpson/ggvegan")
library(here)
library(ggpmisc)
```


#### load data

```{r load data}

################### environmental data
extracted_load <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022/chaparraldegradation_2022/Extracted_Elevation_Slope_Aspect_Hillshade_20m.csv", header = TRUE, na.strings=c("","NA")) %>% 
  dplyr::select(system_ind, aspect, elevation, hillshade, slope, site, southwestness, lat, long, cluster)
# names(extracted_load)

twi_fire_load <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022/chaparraldegradation_2022/Extracted_Elevation_Slope_Aspect_Hillshade_TWI_Fire_20m.csv", header = TRUE, na.strings = c("", "NA")) %>% 
  dplyr::select(system_ind, twi, fire_event_count, last_fire)

extracted_join <- extracted_load %>% 
  left_join(twi_fire_load, by = "system_ind")

extracted_prep <- extracted_join%>% 
    rename(site_rep = system_ind) %>% 
 filter(site_rep != "1.03") %>% 
# “southwest-ness” is calculated using: cos (aspect - 225°)
      mutate(site_rep = case_when(site_rep == "1.1" ~ "1.10", # old ~ new
                                   site_rep == "2.1" ~ "2.10",
                                   site_rep == "2.2" ~ "2.20",
                                  site_rep == "INT1" ~ "INT1_1",
                                    site_rep == "INT2" ~ "INT2_1",
                                    site_rep == "INT3" ~ "INT3_1",
                                    site_rep == "INT4" ~ "INT4_1",
                                    site_rep == "INT5" ~ "INT5_1",
                                   TRUE ~ site_rep)) %>% 
     mutate(
      aspect = as.numeric(aspect),
      elevation = as.integer(elevation), # meters
      hillshade = as.numeric(hillshade), 
      slope = as.numeric(slope), # degrees
      site_rep = as.character(site_rep), 
      site = as.character(site)
      ) 

extracted_prep$site_rep <- gsub("\\.", "_", extracted_prep$site_rep)

# view(extracted_prep)
# length(extracted_prep$site_rep)    # n = 39

 
```

# Prepare environ data for an NMDS (numbers only)

```{r}
prep <- extracted_prep %>%  
  dplyr::select(!c("site_rep", "aspect", "last_fire"))
```

### means (SD)
```{r}

means <- prep %>% 
  group_by(cluster) %>% 
   summarize(elev_mean = mean(elevation),
            elev_sd = sd(elevation),
            hill_mean = mean(hillshade),
            hill_sd = sd(hillshade),
            slope_mean = mean(slope),
            slope_sd = sd(slope),
            sw_mean = mean(southwestness),
            sw_sd = sd(southwestness),
            fire_mean = mean(fire_event_count),
            fire_sd = sd(fire_event_count),
            lat_mean = mean(lat),
            lat_sd = sd(lat),
             long_mean = mean(long),
            long_sd = sd(long)
            ) %>% 
  pivot_longer(cols = 2:15, values_to = "mean", names_to = "variable") %>% 
  pivot_wider(id_cols = cluster, names_from = variable, values_from = mean)

means
```

# NMDS
```{r nmds by species percent cover}

# the AUTOTRANSFORM = F skips the automatic data transformations and uses the input data as is
# - when the raw data contains the information you need (e.g., abundance)
# - when you have a small number of samples or small number of variables
# - when you want to preserve the original scale of the data (e.g., interested in the absolute differences betwen two sets of measurements)

environNMDS <- metaMDS(prep,
                                  autotransform = F, # or T
                                  distance = "bray",   # bray or "raup"
                  k = 2, #dimentions
                 try = 100, #runs
                 trymax = 100) # this is more appropriate for my data


# uses the RAUP-CRICK dissimilarity index to calculate pairwise dissimilarities
# - adjusts for spp richness
# - downweights importance of rare spp 
# - more useful when interested in community STRUCTURE rather than individual species
# - takes into account differences in species evenness
# abcover_byspecies_NMDS <- metaMDS(abcover_byspecies_nmdsprep_num, distance = "raup") 
environNMDS
```

### stress test

```{r stress tests nmds}
stressplot(environNMDS)
# if stress tests are really low ==> I may have insufficient data. :/

plot(environNMDS)
ordiplot(environNMDS, type = "p")
ordiplot(environNMDS, type = "t")
# ab_nmds.fort <- fortify(as.data.frame(abcover_byspecies_NMDS))
```



```{r scores nmds}

scores(environNMDS)

# plot_df <- scores(abcover_byspecies_NMDS, display = "sites") %>% # from An's code
#  as.data.frame() %>%
#  rownames_to_column("stand_core") %>%
#  full_join(seedbank_bysitecore, by = "stand_core")

environNMDS_df <- data.frame(environNMDS$points, extracted) 
head(environNMDS_df)
```




# figure 

```{r ggplot percent cover by environ}

ggplot(environNMDS_df,  
       aes(x = MDS1, y = MDS2, color = cluster_5)) +
  geom_point(size = 5, alpha = 0.8) +
  theme_bw() +
  labs(title = "NMDS of transects by environmental variables") +
   theme_bw() +
   stat_ellipse(level = .95, linetype = 2, linewidth = 1) +
    labs(title = "Transects by environmental variables", color = cluster_5)

```





