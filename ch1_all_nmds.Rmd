---
title: "ChapDegNMDS"
author: "Kit Swift"
date: "2023-12-19"
output: pdf_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#the libraries
library(here) # similar to set working directory
library(tidyverse)
library(gridExtra)
library(ggthemes)
library(plotly)
library(ggpubr)
library(vegan)
library(readxl) 
library(multcompView) 
library(ggpmisc)
library(segmented)
library(ggvegan)
```


```{r Data in}
#any outside data is pulled in here

germination_raw <- read_xlsx("processed/germination_m2.xlsx")
density_raw <- read_csv("processed/shrubdensity.csv")
abcover_raw <- read_csv("processed/abcover_full_omitground.csv")


```


```{r Unified data frame}
sort(unique(abcover_raw$species))
abcover_byspecies <- abcover_raw %>% 
   # mutate(species = case_when(species == "Bromus diandrus" ~ "Bromus spp.", # old name ~ new name
   #                            species ==  "Bromus diandrus dead" ~ "Bromus spp. dead",
   #                              species == "Bromus hordeaceus" ~ "Bromus spp.",
   #                            species == "Bromus madritensis" ~ "Bromus spp.",
   #                              species == "Bromus rubens" ~ "Bromus spp.", 
   #                            species == "Bromus rubens dead" ~ "Bromus spp. dead", 
   #                             species == "Bromus hordeaceus" ~ "Bromus spp.",
   #                            species == "Centaurea melitensis dead" ~ "Centaurea melitensis",
   #                            species == "Hirschfeldia incana dead" ~ "Hirschfeldia incana",
   #        TRUE ~ species)) %>% 
  group_by(site, species, lifeform, status, family) %>% 
  filter(site_rep != "Intact4_4") %>% #omit Intact 4 from data
  filter(!is.na(species)) %>% # omit blank cells in species 
  dplyr::summarize(
    count_per_dist = n_distinct(site_rep_dist), 
    percentcover = n_distinct(site_rep_dist)/41) %>% 
  ungroup() %>%
  dplyr::select(c(site, species, percentcover)) %>% 
  mutate(datatype = as.character("ab")) %>% # adding "percent cover" identifier to species name
  mutate(species_datatype = paste(species, datatype, sep="_")) %>% 
  dplyr::select(!c(species, datatype)) %>% 
  rename(species = species_datatype)

density_byspecies <- density_raw %>% 
  group_by(site, species) %>% 
  dplyr::summarize(species_count = mean(count)) %>% 
  mutate(datatype = as.character("dn")) %>% # adding "density" identifier to species name
  mutate(species_datatype = paste(species, datatype, sep="_")) %>% 
  dplyr::select(!c(species, datatype)) %>% 
  rename(species = species_datatype)

sort(unique(germination_raw$genus_abundance))
germination_byspecies <- germination_raw %>%
  group_by(site, species_diversity) %>%
  rename(species = species_diversity) %>%
  dplyr::summarize(seed_density = mean(n_per_cm3)) %>% 
  mutate(datatype = as.character("sd")) %>% # adding "seed bank" identifier to species name
  mutate(species_datatype = paste(species, datatype, sep="_")) %>% 
  dplyr::select(!c(species, datatype)) %>% 
  rename(species = species_datatype)

abcover_nmdsprep <- abcover_byspecies %>%
  tidyr::spread(species, percentcover) %>% 
  replace(is.na(.), 0)

density_nmdsprep <- density_byspecies %>%
  tidyr::spread(species, species_count) %>% 
  replace(is.na(.), 0)

germination_nmdsprep <- germination_byspecies %>%
  tidyr::spread(species, seed_density) %>% 
  replace(is.na(.), 0)

nmds_total_prep <- abcover_nmdsprep %>%
  left_join(density_nmdsprep, by = "site") %>%
  left_join(germination_nmdsprep, by = "site") %>% 
  replace(is.na(.), 0) 

nmds_total <- nmds_total_prep %>%
  dplyr::select(!c("site"))
```

```{r NMDS Prep}


nmds_total.hel <- decostand(nmds_total, method = "hellinger")

nmds_total.nmds <- metaMDS(nmds_total, 
                 autotransform = T,
                 distance = "bray",
                 k = 2,
                 try = 100,
                 trymax = 100)

ordiplot(nmds_total.nmds, type = "t")

nmds.fort <- fortify(nmds_total.nmds)
```

```{r NMDS prep from Stephanie code}

nmds_total.nmds2 <- metaMDS(nmds_total, 
                            autotransform = T,
                             distance = "bray",
                 k = 2,
                 try = 100,
                 trymax = 100)

scores(nmds_total.nmds2)

stressplot(nmds_total.nmds2)

nmds2_df <- data.frame(nmds_total.nmds2$points, nmds_total_prep) # adds NMDS1 and NMDS2 values

# plot: nmds x hillslopes
colnames(nmds2_df)[colnames(nmds2_df) == 'site'] <- 'hillslope' # rename "site" to "hillslope"

total_nmds2_hillslope <- ggplot(nmds2_df, 
       aes(x = MDS1, y = MDS2, color = hillslope, shape = hillslope)) + # shape = site, color = site
  geom_point(size = 3, alpha = 0.8) +
  scale_color_manual(values = c("orange", "brown", "green", "darkgreen", "lightblue", "blue", "navy")) + #"gray0", "gray30", "gray60"
  scale_shape_manual(values = c(16,16, 15, 15, 17, 17, 17)) + 
  theme_bw() +
  #stat_ellipse(linetype = 2, size = 1) +
  labs(title = "NMDS: all data")

# adding vectors to the dataframe
nmds_total_prep <- nmds_total_prep %>% 
  mutate(standtype_ID = 1)
nmds_total_prep$standtype_ID <- 1:7 #shorten df to first 7 rows

nmds_total.nmds2_plot <- scores(nmds_total.nmds2, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("standtype_ID") %>% 
  mutate_at(c('standtype_ID'), as.numeric) %>% 
  full_join(nmds_total_prep, by = "standtype_ID") %>%  
  dplyr::select(!c(standtype_ID)) 

dim(nmds_total.nmds2_plot)

# extracting pvalues
nmds_total.nmds2_fit <- envfit(nmds_total.nmds2, # envfit() takes the output of metaMDS() and the species matrix you created
                          nmds_total_prep, perm = 999) # pvalues for spp and stand, site, stand_core

nmds_total.nmds2_pvals <- nmds_total.nmds2_fit$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") %>% 
  filter(!species == 'standtype_ID')

# extracting coordinates for hillslopes
nmds_total.nmds2_coord <- nmds_total.nmds2_fit %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., nmds_total.nmds2_pvals, by = "species") %>% 
  filter(pvals <= 0.008) %>% # <-- set p-value level here
  filter(!species == 'standtype_ID')
dim(nmds_total.nmds2_coord) # <-- limit number of vectors to <7 for clarity
#write.csv(nmds_total.nmds2_coord,"Ch1_Degradation_figures/nmds2_all_pval")

# plot: nmds x hillslopes + labels 
total_nmds2_hillslope_vectors <- ggplot(nmds_total.nmds2_plot %>% # output of scores()
                                          rename(hillslope = site), 
                                   aes(x = NMDS1, y = NMDS2)) +
  coord_equal() +
  xlim(-2, 2) +
  ylim(-2, 2) +
  geom_point(aes(color = hillslope, shape = hillslope), 
             size = 3, alpha = 0.8, position = position_jitter(width = 0.1, height = 0.1)) + 
  #stat_ellipse(aes(color = hillslope)) +
 scale_color_manual(values = c("orange", "brown", "green", "darkgreen", "lightblue", "cornflowerblue", "blue")) + #"gray0",
   scale_shape_manual(values = c(16,16, 15, 15, 17, 17, 17)) + 
  theme_bw() +
  geom_segment(data = nmds_total.nmds2_coord, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
                col = "black") +
   geom_text(data = nmds_total.nmds2_coord, aes(label = species),  
             position = position_jitter(width = 0.0, height = 0.4)
             )
total_nmds2_hillslope_vectors + theme_bw()
total_nmds2_hillslope_vectors + theme_bw()
total_nmds2_hillslope_vectors + theme_bw()
total_nmds2_hillslope_vectors + theme_bw()
total_nmds2_hillslope_vectors + theme_bw()
total_nmds2_hillslope_vectors + theme_bw()
total_nmds2_hillslope_vectors + theme_bw()
total_nmds2_hillslope_vectors + theme_bw()
```

```{r NMDS Graphing}

duneplot <- ggplot() + 
  
  #putting all the "site" data on the graph, these are the different observations
  geom_point(data = subset(nmds.fort, score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             alpha = 0.5,  #transparency (to hide/show)
             color = "darkorange",
             show.legend = F) +
  
  #while this is the species data, or abundance based on different observations. 
  geom_point(data = subset(nmds.fort, score == 'species'), 
             mapping = aes(x = NMDS1, y = NMDS2),
             alpha = 0.5, #transparency (to hide/show)
             color = "blue",
             show.legend = F) 

duneplot





```

