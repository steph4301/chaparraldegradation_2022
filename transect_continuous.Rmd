---
title: "transect_continuous"
author: "Stephanie Ma Lucero"
date: "2024-04-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r code to hang on to, include=FALSE}

# df<- df_load %>% 
#  mutate(site_rep = paste(site, transect, sep = "_")) %>% # create new column
# unite("lifeform_total", 2:3, sep = "_") # consolidate columns

```

```{r libraries, message=FALSE}
library(here) # similar to set working directory
library(tidyverse) # data wrangling - includes ggplot2, dplyr, tidyr, readr, purr, tibble, stringr, forcats
library(readxl) 
```

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

#chaparral1
#chaparral2
cal_palette(name = "chaparral3", n = 20, type = "continuous") 

#species colors
HEAR <- "#D3E3CA"
RHOV <- "#92A587"
RHIL <- "#2F3525"

MAFA <- "gray60"
SALE <- "gray40"
ARCA <- "gray20"

scl <- 16
css <- 17

colors_scl <- c(HEAR, RHOV, RHIL)
colors_css <- c(MAFA, SALE, ARCA)

# Lifeform colors: shrub, grass, forb
shrub <- "green4"
grass <- "yellow2"
forb <- "purple2"
fern <- "black"
colors_lifeform <- c(shrub, grass, forb, fern)

# Status colors: native, exotic 
native <- "gray50"
nonnative <- "gray0"
colors_status <- c(native, nonnative)

# "orange", "lightblue", "limegreen", "deeppink","mediumpurple2", "darkgreen"
```

#NOTES Transect data overview - Years collected: 2017, 2019, 2024 - Sites: 1 and 2 - Comparing to intact sites: INT1, INT2, INT3, INT4, INT5

# load data

```{r load point intercept transect data from csv, include=TRUE}
file_transect_2019_load <- read_excel("deg_percentcover_byspecies_bylifeform_2024.xlsx", sheet = "2019_data")
# -- years 2017, 2019
# -- Site 1: transects 1-6
# -- Site 2: transects 1-6
# -- INT1, INT2, INT3, INT4

transect2019 <- file_transect_2019_load %>% 
  dplyr::select(c(site, transect, year, distance, vertical, species)) %>% # select columns to full join with 2024 data
  filter(year %in% c(2017, 2019)) %>% #filter data to 2019 data
  dplyr::select(year, site, transect, distance, vertical, species)
  
# View the data (optional)
#View(transect2019)
#sort(unique(transect2019$transect))
#sort(unique(transect2019$site))

file_transect_2024_load <- read.csv("Transects_2024 - transect.csv", header = TRUE, na.strings=c("","NA"))
# -- years 2024
# -- Site 1: transects 7-14
# -- Site 2: transects 7-21
# -- INT5
transect2024 <- file_transect_2024_load %>%  
  dplyr::select(c(site, transect, year, distance, vertical, species)) %>% 
  filter(species != "N/A")
  
# View the data (optional)
#View(transect_2024)
#sort(unique(transect_2024$transect))
#sort(unique(transect_2024$site))
```

## full join transect data

```{r full join}
abcover_fulljoin <- full_join(transect2019, transect2024, by = intersect(names(transect2019), names(transect2024)))

# View the data (optional)
#View(abcover_full)
#sort(unique(abcover_full$transect))
#sort(unique(abcover_full$site))
```

## species list

```{r convert to tibble}
# convert dataframe to tibble
abcover_fulljoin_tib <- as_tibble(abcover_fulljoin) 
class(abcover_fulljoin_tib)

abcover_full <- abcover_fulljoin_tib %>% 
   mutate(site_rep = paste(site, transect, sep = "_")) %>% # combine site and rep to one column
   mutate(site_rep_dist = paste(site_rep, distance, sep = "_")) %>%  # combine site_rep and distance to one column 
   mutate(species = case_when(species == "BG bare ground" ~ "bare_ground", # oldname ~ newname
                              species == "ground" ~ "bare_ground", 
                              species == "native_litter" ~ "litter",
                              species == "nonnative_thatch" ~ "thatch",
                              species == "Bromus diandrus BRDI" ~ "Bromus diandrus",
                              species == "Bromus rubens BRRU" ~ "Bromus rubens", 
                              species == "Bromus hordeaceus BRHO" ~ "Bromus hordeaceus", 
                              species == "Rapistrum rugosum - round pods" ~ "Rapistrum rugosum", 
                              species == "HIIN Hirschfeldia incana - long pods" ~ "Hirschfeldia incana", 
                              species == "Hirschfeldia incana - long pods" ~ "Hirschfeldia incana", 
                              species == "Salvia lucophylla" ~ "Salvia leucophylla",
                              species == "Malacothamnus fasciculatus " ~ "Malacothamnus fasciculatus",
                              species == "dead HEAR" ~ "Heteromeles arbutifolia dead",
                              species == "dead MAFA" ~ "Malacothamnus fasciculatus dead",
                              species == "dead RHIL" ~ "Rhamnus ilicifolia dead",
                              species == "dead ARCA" ~ "Artemisia californica dead",
                              species == "dead SALE" ~ "Salvia leucophylla dead",
                              species == "ACGL Acmispon glaber" ~ "Acmispon glaber",
                              species == "Acmispon maritimus - round, sevfl" ~ "Acmispon maritimus",
                              species == "Acmispon strigosus - oval, sevfl" ~ "Acmispon strigosus",
                              species == "Sambucus nigra" ~ "Sambucus mexicana",
                              species == "Blitum californicum" ~ "Chenopodium californicum",
                              TRUE ~ species)) %>% 
   mutate(
      year = as.character(year),
      site = as.character(site),
      transect = as.character(transect),
      distance = as.character(distance),
      vertical = as.character(vertical),
      species = as.character(species)
      )

glimpse(abcover_full) # look at new columns

sort(unique(abcover_full$species))
```

## species characteristics

```{r load species characteristics, include=TRUE}
specieslist <- file_transect_2019_load %>% 
  dplyr::select(species, lifeform, status, lifecycle, family) %>%
   mutate(status = case_when(status == "Native" ~ "native",
                                status == "Non-native" ~ "nonnative",
                                lifeform == "thatch" ~ "ground",
                                TRUE ~ status)) %>% 
   mutate(lifeform = case_when(lifeform == "Grass" ~ "grass",
                                lifeform == "Shrub" ~ "shrub",
                                lifeform == "Forb" ~ "forb",
                                lifeform == "thatch" ~ "ground",
                                TRUE ~ lifeform)) %>% 
   mutate(lifecycle = case_when(lifecycle == "Annual" ~ "annual", 
                                lifecycle == "Perennial" ~ "perennial", 
                                lifecycle == "thatch" ~ "ground",
                                TRUE ~ lifecycle)) %>% 
   mutate(family = case_when(family == "thatch" ~ "ground", 
                                TRUE ~ family)) %>% 
   mutate(species = case_when(species == "BG bare ground" ~ "bare_ground", # oldname ~ newname
                                species == "ground" ~ "bare_ground", 
                                species == "native_litter" ~ "litter",
                                species == "nonnative_thatch" ~ "thatch",
                                species == "Bromus diandrus BRDI" ~ "Bromus diandrus",
                                species == "Bromus rubens BRRU" ~ "Bromus rubens", 
                                species == "Bromus hordeaceus BRHO" ~ "Bromus hordeaceus", 
                                species == "Rapistrum rugosum - round pods" ~ "Rapistrum rugosum", 
                                species == "HIIN Hirschfeldia incana - long pods" ~ "Hirschfeldia incana", 
                                species == "Hirschfeldia incana - long pods" ~ "Hirschfeldia incana", 
                                species == "Salvia lucophylla" ~ "Salvia leucophylla",
                                species == "Malacothamnus fasciculatus " ~ "Malacothamnus fasciculatus",
                                species == "dead HEAR" ~ "Heteromeles arbutifolia dead",
                                species == "dead MAFA" ~ "Malacothamnus fasciculatus dead",
                                species == "dead RHIL" ~ "Rhamnus ilicifolia dead",
                                species == "dead ARCA" ~ "Artemisia californica dead",
                                species == "dead SALE" ~ "Salvia leucophylla dead",
                                species == "ACGL Acmispon glaber" ~ "Acmispon glaber",
                                species == "Acmispon maritimus - round, sevfl" ~ "Acmispon maritimus",
                                species == "Acmispon strigosus - oval, sevfl" ~ "Acmispon strigosus",
                                species == "Mirabilis laevis var. crassifolia" ~ "Mirabilis laevis",
                                TRUE ~ species)) %>% 
  distinct() 

#View(specieslist)
sort(unique(specieslist$species))
```

-- code to update list of species characteristics
```{r playing with da species list}
ab_species <- sort(unique(abcover_full$species))
species_species <- sort(unique(specieslist$species))

#These are the species that are in abcover_full that are NOT in the species list
difab <- setdiff(ab_species, species_species)
difab 

#These are the species that are in the species list that are NOT in abcover_full
difsp <- setdiff(species_species, ab_species)
difsp

# new.specieslist <- specieslist %>%
#   add_row(species = "", 
#           lifeform = "",
#           status = "",
#           lifecycle = "",
#           family = "")

# # Rename if need be renamed
# new.specieslist <- specieslist %>%
#     mutate(species = case_when(species == "Mirabilis laevis var. crassifolia" ~ "Mirabilis laevis", 
#                                TRUE ~ species))
# 
# new.abcover_full <- abcover_full %>%
#     mutate(species = case_when(species == "Blitum californicum" ~ "Chenopodium californicum", 
#                                species == "Sambucus nigra" ~ "Sambucus mexicana", 
#                                TRUE ~ species))
# 
# new.ab_species <- sort(unique(new.abcover_full$species))
# new.species_species <- sort(unique(new.specieslist$species))
# 
# new.ab_species == new.species_species
# 
# #These are the species that are in abcover_full that are NOT in the species list
# new.difab <- setdiff(new.ab_species, new.species_species)
# new.difab 
# 
# #These are the species that are in the species list that are NOT in abcover_full
# new.difsp <- setdiff(new.species_species, new.ab_species)
# new.difsp
# 
# 
# # Run the code below when you are sure you added everything correctly 
# specieslist <- new.specieslist
# abcover_full <- new.abcover_full
# 
# write.csv(specieslist, file = "specieslist.csv")

```

### left_join species characteristics
```{r left_join species characteristics}
abcover_charateristics <- abcover_full %>% 
  left_join(specieslist, by = "species")

```

## leaf type
```{r load schlero leaf data, echo=FALSE, eval=F}
# shrub_leaftype <- read_excel("shrub_leaftype.xlsx") #original data

shrub_leaftype <- read.csv("shrub_leaftype.csv") %>% 
  dplyr::select("species", "leaftype") %>% 
   mutate(
      species = as.character(species),
      leaftype = as.character(leaftype)
      ) %>% 
  mutate(
    leaftype = if_else(grepl("dead", species, ignore.case = TRUE), "dead_shrub", leaftype)
  )

print(sort(shrub_leaftype$species))
```

-- code to update list of shrub leaf characteristics
```{r update schlero leaf data}
ab_shrubs <- abcover_charateristics %>% 
   filter(lifeform == "shrub") %>%
  pull(species) %>% 
  unique() %>% 
  sort()

shrub_shrubs <- sort(unique(shrub_leaftype$species))

#These are the shrubs that are in abcover_full that are NOT in the shrub species list
difshr <- setdiff(ab_shrubs, shrub_shrubs)
difshr 

# new.shrub_leaftype <- shrub_leaftype %>%
#   add_row(species = "", leaftype = "")
# 
# # Run the code below when you are sure you added everything correctly
# shrub_leaftype <- new.shrub_leaftype
# 
# write.csv(shrub_leaftype, file = "shrub_leaftype.csv")
```

### left_join leaftype
```{r}
abcover_charateristics_leaftype <- abcover_charateristics %>% 
  left_join(shrub_leaftype, by = "species")
```


# Transect data
```{r data check, include = TRUE}
abcover_charateristics_leaftype

%>% 
  group_by(site, transect) %>%
  summarize(data_points = length(unique(distance))) # number of "hits" per transect

abcover_full %>% 
  group_by(site) %>%
  summarize(data_points = length(unique(transect))) # number of transects per site
```

```{r omit ground as a status}
abcover_full_1 <- abcover_full %>% 
  left_join()

abcover_full_omitground <- abcover_full %>% 
  left_join
filter(abcover_full, status =="native" |status == "nonnative")
print(abcover_full_v_omitground)
```
 
```{r preprbindleaftype, include=TRUE}
 
shrubs <- abcover_full_v_omitground %>% 
#   filter(lifeform == "shrub") %>% 
#   left_join(shrub_leaftype, by = "species") %>% 
#   dplyr::select(!c(lifeform)) %>% 
#     rename(lifeform = leaftype ) # newname = oldname
# 
# herbsgrassesfern <-  abcover_full_v_omitground %>% 
#   filter(lifeform =="herb" | lifeform == "grass" | lifeform == "fern") 
#   
# lifeformleaftype <- rbind(herbsgrassesfern, shrubs) %>%  
#   group_by(site_rep_dist) %>%
#    mutate(lifeform_status = paste(lifeform, status, sep = "_")) %>% 
#   group_by(standtype, site, transect, site_rep, lifeform, status, lifeform_status) %>% 
#   dplyr::summarize(
#     count_per_transect = n_distinct(site_rep_dist), 
#     percentcover = n_distinct(site_rep_dist)/41) %>% # <-- calculate percent cover
#   ungroup() #%>% 
#   #  mutate(standtype = fct_relevel(standtype,"intact", "matrix", "degraded")) %>% 
#   #  mutate(site = fct_relevel(site, "INT1", "INT2", "INT3", "ENH1", "ENH2", "DEG1", "DEG2")) %>%
#   # # mutate(site_rep = fct_relevel(site_rep, "INT1_1", "INT2_2", "INT3_3", "ENH1_1" ,    "ENH1_2"   ,  "ENH1_3" ,    "ENH2_4" ,    "ENH2_5"    ,"ENH2_6", "DEG1_1",     "DEG1_2"  ,   "DEG1_3"   ,  "DEG2_4" ,    "DEG2_5"   ,  "DEG2_6")) %>% 
#   # mutate(lifeform_status = fct_relevel(lifeform_status, "grass_nonnative", "herb_nonnative",
#   #                                 "fern_native",     "grass_native", "herb_native", "nonsclero_native", "sclerophyllous_native")
#   #)
# 
# print(lifeformleaftype)
# ```
# 
# ### Percent cover by lifeform by native/nonnative status - there shouldn't be zeros in your df
# 
# ```{r cover x status x lifeform - data prep, include = TRUE}
# # line 933 from Ch1_Degradation_original.Rmd
# 
# # data prep
# abcover_bylf_bystatus <- abcover_full_v_omitground %>% 
#   group_by(standtype, lifeform, status, site, transect, site_rep, year) %>% 
#   dplyr::summarize(
#     count_per_transect = n_distinct(site_rep_dist), 
#     percentcover = n_distinct(site_rep_dist)/41 # <-- calculate percent cover by transect, lifeform, and status
#     ) %>% 
#   ungroup() %>% 
#   unite("lifeform_total", 2:3, sep = "_") #combines characters in two columns to one column
# # view(abcover_bylf_bystatus) # prints to new tab
# #write.csv(abcover_bylf_bystatus,"processed/abcover_bylf_bystatus.csv")
# # visualizing data
# 
# ## histogram 
# hist(abcover_bylf_bystatus$percentcover) 
# ```
# 
# This is the spread of my percent cover data by standtype wrapped by lifeform_status
# 
# ```{r}
# ## jitter - by standtype
# ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = year)) + 
#   geom_jitter()+
#   facet_wrap(~lifeform_total)
# ```
# 
# Here I'm transposing the data from long to wide by lifeform_status becuase I want to visualize native shrub cover by non-native grass cover.
# 
# ```{r}
# abcover_bylf_bystatus_wide <- abcover_bylf_bystatus %>% 
#   dplyr::select(!c(count_per_transect)) %>% 
#   pivot_wider(names_from = lifeform_total, values_from = percentcover) %>% 
#   replace_na(replace = list(grass_native = 0, grass_nonnative = 0, 
#                             herb_native = 0, herb_nonnative = 0, 
#                             shrub_native = 0, shrub_nonnative = 0,
#                             fern_native = 0, fern_nonnative = 0))  # Replace NA with 0 for each value column
#   
# ```
# 
# This is the spread of native shrub cover over non-native grass cover...
# 
# ```{r}
# 
# ggplot(data = abcover_bylf_bystatus_wide, 
#        aes(y = shrub_native*100, x = grass_nonnative*100, color = year)) + 
#   geom_jitter()
# ```
# 
# ... and here is the spread of non-native grass cover overnative shrub cover.
# 
# ```{r}
# ggplot(data = abcover_bylf_bystatus_wide, 
#        aes(y = grass_nonnative*100, x = shrub_native*100, color = year)) + 
#   geom_jitter()
```