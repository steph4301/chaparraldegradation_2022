---
title: "transect_continuous"
author: "Stephanie Ma Lucero"
date: "2024-04-23"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r code to hang on to, include=FALSE}

# df<- df_load %>% 
#  mutate(site_rep = paste(site, transect, sep = "_")) %>% # create new column
# unite("lifeform_total", 2:3, sep = "_") # consolidate columns

```

```{r libraries, message=FALSE}

#install.packages(c("dplyr", "ggplot2", "tidyr", "readr", "lubridate"))

library(here) # similar to set working directory
library(tidyverse) # data wrangling - includes ggplot2, dplyr, tidyr, readr, purr, tibble, stringr, forcats
# library(lubridate) # dates and times
library(ggplot2) # data visualization
#library(gridExtra)
# library(readr)
library(dplyr)
library(ggthemes)
library(plotly)
library(ggpubr) # customize ggplot2 for publication
#library(broom)
#library(AICcmodavg)
library(vegan) #community ecology package - includes, MASS, cluster, mgcv
library(readxl) # for .xls and .xlsx sheets
#library(janitor)
library(multcompView) #Visualizations of Paired Comparisons, functions: TukeyHSD, dist{stats}, simint, simtest, csimint, csimtest{multcomp}, friedmanmc, kruskalmc{pgirmess}
#library(multcomp) # functions: multcompLetters2, multcompLetters3, multcompLetters4 using aov object
#library(DHARMa) #The ‘DHARMa’ package uses a simulation-based approach to create readily interpretable scaled (quantile) residuals for fitted (generalized) linear mixed models.
#citation("DHARMa")
library(ggpmisc)
library(segmented)
library(strucchange)
library(ggpattern)
library(lme4)
library(lmerTest) # load again or update if you're not getting p-values from environmental models
library(googlesheets4) 
#gs4_auth()
# The googlesheets4 package is requesting access to your Google account.
# Enter '1' to start a new auth process or select a pre-authorized account.
# 1: Send me to the browser for a new auth process.
# 2: sama@ucsb.edu
# --> Selection: 2

```

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

cal_palette(name = "chaparral3", n = 20, type = "continuous") 


#species colors
HEAR <- "#D3E3CA"
RHOV <- "#92A587"
RHIL <- "#2F3525"

MAFA <- "gray60"
SALE <- "gray40"
ARCA <- "gray20"

scl <- 16
css <- 17

colors_scl <- c(HEAR, RHOV, RHIL)
colors_css <- c(MAFA, SALE, ARCA)

# Lifeform colors: shrub, grass, forb
shrub <- "green4"
grass <- "yellow2"
forb <- "purple2"
fern <- "black"
colors_lifeform <- c(shrub, grass, forb, fern)

# Status colors: native, exotic 
native <- "gray50"
nonnative <- "gray0"
colors_status <- c(native, nonnative)


# "orange", "lightblue", "limegreen", "deeppink","mediumpurple2", "darkgreen"
```

#Transect data overview
- Years collected: 2017, 2019, 2024
- Sites: 1 and 2
- Comparing to intact sites: INT1, INT2, INT3, INT4, INT5

# load exl and google data and FULL join

load excel data
-- years 2017, 2019
-- Site 1: transects 1-6
-- Site 2: transects 1-6
-- INT1, INT2, INT3, INT4

```{r load point intercept transect data from excel, include=TRUE}

file_transect <- "deg_percentcover_byspecies_bylifeform_2024.xlsx"

# Read the specific sheet named "transect_data"
file_transect_load <- read_excel(file_transect, sheet = "2019_data") %>% 
  mutate(
    year = as.character(year),
    site = as.character(site),
    transect = as.character(transect),
    distance = as.character(distance),
     vertical = as.character(vertical),
    species = as.character(species)
  ) %>%
   mutate(species = case_when(species == "BG bare ground" ~ "bare_ground", # oldname ~ newname
                                species == "Bromus diandrus BRDI" ~ "Bromus diandrus",
                                species == "Bromus rubens BRRU" ~ "Bromus rubens", 
                               species == "Rapistrum rugosum - round pods" ~ "Rapistrum rugosum", 
                              species == "Salvia lucophylla" ~ "Salvia leucophylla",
                              species == "dead HEAR" ~ "Heteromeles arbutifolia dead",
                              species == "dead MAFA" ~ "Malacothamnus fasciculatus dead",
                              species == "dead RHIL" ~ "Rhamnus ilicifolia dead",
          TRUE ~ species)) %>% 
  mutate(status = case_when(status == "Native" ~ "native",
                              status == "Non-native" ~ "nonnative",
                              lifeform == "thatch" ~ "ground",
                            TRUE ~ status)) %>% 
    mutate(lifeform = case_when(lifeform == "Grass" ~ "grass",
                              lifeform == "Shrub" ~ "shrub",
                              lifeform == "Forb" ~ "forb",
                                lifeform == "thatch" ~ "ground",
                            TRUE ~ lifeform)) %>% 
  mutate(lifecycle = case_when(lifecycle == "Annual" ~ "annual", 
                               lifecycle == "Perennial" ~ "perennial", 
                                   lifecycle == "thatch" ~ "ground",
                               TRUE ~ lifecycle)) %>% 
  mutate(family = case_when(family == "thatch" ~ "ground", 
                            TRUE ~ family))
  

transect2019 <- file_transect_load %>% #filter data to 2019 data
  filter(year %in% c(2017, 2019)) %>% 
  dplyr::select(year, site, transect, distance, vertical, species)
 
# View the data (optional)
#View(transect2019)
#sort(unique(transect2019$transect))
#sort(unique(transect2019$site))
#sort(unique(transect2019$species))
```

load google sheets data
-- years 2024
-- Site 1: transects 7-18
-- Site 2: transects 7-14
-- INT5
```{r load load point intercept google data, include=TRUE, echo =FALSE}

Transects2024_loadfromgoogle <- "https://docs.google.com/spreadsheets/d/1FK2YxFNLESzUOiZXI4AIm9gUVStaOLQqCRljIOMnwoM/edit"

#google drive data
transect2024_load <- read_sheet(Transects2024_loadfromgoogle, sheet = "transect") %>%
  mutate(
    year = as.character(year),
    site = as.character(site),
    transect = as.character(transect),
    distance = as.character(distance),
     vertical = as.character(vertical),
    species = as.character(species),
    max_height_cm = as.integer(max_height_cm)
  ) %>%
  dplyr::select(-date, -name, -species_code, -standtype, -hillslope, -coordinates_x, -coordinates_y)

transect2024 <- transect2024_load %>% 
  filter(species != "N/A") %>% 
  dplyr::select((-Notes & -max_height_cm))

# View the data (optional)
#View(transect2024)
sort(unique(transect2024$transect))
sort(unique(transect2024$site))
sort(unique(transect2024$species))
```

full join
```{r}
abcover_full <- full_join(transect2019, transect2024, 
                          by = intersect(names(transect2019), names(transect2024)))

```

```{r load schlero leaf data, echo=FALSE, eval=F}
shrub_leaftype <- read_excel("shrub_leaftype.xlsx")
print(sort(shrub_leaftype$species))
```

```{r load species characteristics, include=TRUE}
specieslist <- file_transect_load %>% 
  dplyr::select(species, lifeform, status, lifecycle, family) %>%
  distinct() 

View(specieslist)
```

# data prep

```{r}
# convert dataframe to tibble
transect2019_tib <- as_tibble(transect2019) 
class(transect2019_tib)

transect2019_v <- transect2019_tib %>% 
   mutate(site_rep = paste(site, transect, sep = "_")) %>% # combine site and rep to one column
  mutate(site_rep_dist = paste(site_rep, distance, sep = "_")) %>%  # combine site_rep and distance to one column  
  mutate(site_rep_status = paste(site_rep, status, sep = "_"))

glimpse(transect2019_v) # look at new columns
```

```{r}
sort(unique(abcover_full_v$species))
```

```{r}
abcover_full_v %>%  
   # na.omit() %>%  
  group_by(site, hillslope, transect) %>% 
  summarize(data_points = length(unique(distance)))
```

```{r}
# omit "ground" as a status since interested in Native and Non-native species 
abcover_full_v_omitground <- filter(abcover_full_v, status =="native" |status == "nonnative")
print(abcover_full_v_omitground)
```

```{r preprbindleaftype, include=TRUE}

shrubs <- abcover_full_v_omitground %>% 
  filter(lifeform == "shrub") %>% 
  left_join(shrub_leaftype, by = "species") %>% 
  dplyr::select(!c(lifeform)) %>% 
    rename(lifeform = leaftype ) # newname = oldname

herbsgrassesfern <-  abcover_full_v_omitground %>% 
  filter(lifeform =="herb" | lifeform == "grass" | lifeform == "fern") 
  
lifeformleaftype <- rbind(herbsgrassesfern, shrubs) %>%  
  group_by(site_rep_dist) %>%
   mutate(lifeform_status = paste(lifeform, status, sep = "_")) %>% 
  group_by(standtype, site, transect, site_rep, lifeform, status, lifeform_status) %>% 
  dplyr::summarize(
    count_per_transect = n_distinct(site_rep_dist), 
    percentcover = n_distinct(site_rep_dist)/41) %>% # <-- calculate percent cover
  ungroup() #%>% 
  #  mutate(standtype = fct_relevel(standtype,"intact", "matrix", "degraded")) %>% 
  #  mutate(site = fct_relevel(site, "INT1", "INT2", "INT3", "ENH1", "ENH2", "DEG1", "DEG2")) %>%
  # # mutate(site_rep = fct_relevel(site_rep, "INT1_1", "INT2_2", "INT3_3", "ENH1_1" ,    "ENH1_2"   ,  "ENH1_3" ,    "ENH2_4" ,    "ENH2_5"    ,"ENH2_6", "DEG1_1",     "DEG1_2"  ,   "DEG1_3"   ,  "DEG2_4" ,    "DEG2_5"   ,  "DEG2_6")) %>% 
  # mutate(lifeform_status = fct_relevel(lifeform_status, "grass_nonnative", "herb_nonnative",
  #                                 "fern_native",     "grass_native", "herb_native", "nonsclero_native", "sclerophyllous_native")
  #)

print(lifeformleaftype)
```

### Percent cover by lifeform by native/nonnative status - there shouldn't be zeros in your df

```{r cover x status x lifeform - data prep, include = TRUE}
# line 933 from Ch1_Degradation_original.Rmd

# data prep
abcover_bylf_bystatus <- abcover_full_v_omitground %>% 
  group_by(standtype, lifeform, status, site, transect, site_rep, year) %>% 
  dplyr::summarize(
    count_per_transect = n_distinct(site_rep_dist), 
    percentcover = n_distinct(site_rep_dist)/41 # <-- calculate percent cover by transect, lifeform, and status
    ) %>% 
  ungroup() %>% 
  unite("lifeform_total", 2:3, sep = "_") #combines characters in two columns to one column
# view(abcover_bylf_bystatus) # prints to new tab
#write.csv(abcover_bylf_bystatus,"processed/abcover_bylf_bystatus.csv")
# visualizing data

## histogram 
hist(abcover_bylf_bystatus$percentcover) 
```
This is the spread of my percent cover data by standtype wrapped by lifeform_status
```{r}
## jitter - by standtype
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = year)) + 
  geom_jitter()+
  facet_wrap(~lifeform_total)
```
Here I'm transposing the data from long to wide by lifeform_status becuase I want to visualize native shrub cover by non-native grass cover.
```{r}
abcover_bylf_bystatus_wide <- abcover_bylf_bystatus %>% 
  dplyr::select(!c(count_per_transect)) %>% 
  pivot_wider(names_from = lifeform_total, values_from = percentcover) %>% 
  replace_na(replace = list(grass_native = 0, grass_nonnative = 0, 
                            herb_native = 0, herb_nonnative = 0, 
                            shrub_native = 0, shrub_nonnative = 0,
                            fern_native = 0, fern_nonnative = 0))  # Replace NA with 0 for each value column
  
```

This is the spread of native shrub cover over non-native grass cover...
```{r}

ggplot(data = abcover_bylf_bystatus_wide, 
       aes(y = shrub_native*100, x = grass_nonnative*100, color = year)) + 
  geom_jitter()
```
... and here is the spread of non-native grass cover overnative shrub cover.
```{r}
ggplot(data = abcover_bylf_bystatus_wide, 
       aes(y = grass_nonnative*100, x = shrub_native*100, color = year)) + 
  geom_jitter()
```
