---
title: "ch1_standdeg_canopy"
author: "Stephanie Ma Lucero"
date: "2023-07-24"
output: html_document
---

### NOTES 

```{r adam sandler message, include=FALSE}

# jul31 
# You've figured out how to visualize the raw data with a histogram, jitter plot, and box plots
# and how to test for normality with the shapiro.test(df$responsevariable).
# None of the above ground percent cover data are normally distributed.
# Leave it and MOVE ON to your seedbank data. 
# 1. complete data collection of Bay 6 tray
# 2. open seedbank NMDS file 
# 3. add the INT seed bank data
# 4. open the file in R and 
# 5. look at hist(seedbank$abundance)
# From talking with Rob - get rid of the zeros in abundance data because you don't know if the seeds were there or not... just calculate means and stats on germination counts. If there was only one tray with Sp. A, you can't run stats on it because you only have one rep with Sp. A present. 

# October 11, 20203
# you need to rerun above ground data by transect, not grouped by stand type
# model = model_type(dependent_variable ~ independent_variable + covariate, data = dataset_name),


```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE}

library(here) # similar to set working directory
library(tidyverse) # data wrangling - includes ggplot2, dplyr, tidyr, readr, purr, tibble, stringr, forcats
# library(lubridate) # dates and times
library(ggplot2) # data visualization
library(gridExtra)
# library(readr)
library(dplyr)
library(ggthemes)
library(plotly)
library(ggpubr) # customize ggplot2 for publication
#library(broom)
#library(AICcmodavg)
library(vegan) #community ecology package - includes, MASS, cluster, mgcv
library(readxl) # for .xls and .xlsx sheets
#library(janitor)
library(multcompView) #Visualizations of Paired Comparisons, functions: TukeyHSD, dist{stats}, simint, simtest, csimint, csimtest{multcomp}, friedmanmc, kruskalmc{pgirmess}
#library(multcomp) # functions: multcompLetters2, multcompLetters3, multcompLetters4 using aov object
#library(DHARMa) #The ‘DHARMa’ package uses a simulation-based approach to create readily interpretable scaled (quantile) residuals for fitted (generalized) linear mixed models.
#citation("DHARMa")
library(ggpmisc)
library(segmented)
```

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Stand colors: INTACT, MATRIX, DEGRADED 
cal_palette(name = "chaparral3", n = 3, type = "continuous") 
#deg <- "#D3E3CA"
#mat <- "#92A587"
#int <- "#2F3525"
deg <- "gray60"
mat <- "gray40"
int <- "gray20"
line <- "red"
degshape <- 16
matshape <- 17
intshape <- 18


standcolors <- c(int, mat, deg)
standcolors_line <- c(line, int, mat, deg)
standshape <- c(intshape, matshape, degshape)

# Lifeform colors: shrub, grass, forb
cal_palette(name = "chaparral3", n = 3, type = "continuous") 
shrub <- "green4"
grass <- "yellow2"
forb <- "purple2"
lifeformcolors <- c(int, mat, deg)

# Status colors: native, exotic 
cal_palette(name = "chaparral1", n = 6, type = "continuous") 
native <- "gray50"
exotic <- "gray0"
statuscolors <- c(native, exotic)

```


```{r load csv, create columns, calculate - percent cover, echo=FALSE, eval=F}

# percent cover - belt transects, point intercept transects
abcover_full <- read.csv("deg_percentcover_byspecies_bylifeform.csv", header = TRUE, na.strings=c("","NA")) %>% 
  rename(speciescode = species.1 ) %>%
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded")) %>% 
  dplyr::select(!speciescode) %>% 
    mutate(site = case_when(site == "Intact_1" ~ "INT1", 
                                site == "Intact_2" ~ "INT2",
                                site == "Intact_3" ~ "INT3", 
          TRUE ~ site))

glimpse(abcover_full)
str(abcover_full)

#abcover_full$standtype <- factor(abcover_full$standtype, levels = c("intact", "matrix", "degraded"))

# convert dataframe to tibble
abcover_full_v <- as_tibble(abcover_full) 
class(abcover_full_v)

# combine site and rep to one column
abcover_full_v$site_rep <- paste(abcover_full_v$site, abcover_full_v$rep, sep="_") 

# combine site_rep and distance to one column
abcover_full_v$site_rep_dist <- paste(abcover_full_v$site_rep, abcover_full_v$distance, sep="_") 

# combine standtype and native/nonnative status to one column
abcover_full_v$stand_status <- paste(abcover_full_v$standtype, abcover_full_v$status, sep="_") 

abcover_full_v <- abcover_full_v %>% 
  mutate(site_rep = fct_relevel
         (site_rep, 
                                "INT1_1", "INT2_2", "INT3_3", "ENH1_1", "ENH1_2",    "ENH1_3"  ,   "ENH2_4"  ,   "ENH2_5"    , "ENH2_6"  , "DEG1_1"   ,  "DEG1_2"  ,   "DEG1_3"     ,"DEG2_4" ,    "DEG2_5"    , "DEG2_6" ))

glimpse(abcover_full_v) # look at new columns

sort(unique(abcover_full_v$species))

abcover_full_v %>%  
  na.omit() %>%  
  group_by(standtype, rep) %>% 
  summarize(data_points = length(rep))

# omit "ground" as a status since interested in Native and Non-native species 
abcover_full_v_omitground <- filter(abcover_full_v, status !="ground")
glimpse(abcover_full_v_omitground)
```

# 1. PHYSICAL STRUCTURE 

### 1.1 Percent cover (horizontal variation)

```{r percent cover - abcover_vegcover, include = TRUE}
abcover_vegcover <- abcover_full_v %>% 
  filter(vertical == "1") %>% 
  group_by(standtype, site, rep) %>% 
  dplyr::summarize(count_per_transect = length(vertical), 
    percentcover_veg = length(vertical)/41, 
    percentcover_ground = (1-percentcover_veg)
    )
print(abcover_vegcover)

abcover_vegcover_long <- gather(abcover_vegcover, covertype, percentcover, percentcover_veg:percentcover_ground, factor_key = TRUE) 
abcover_vegcover_long
```

### 1.1A total % vegetation cover

```{r FIGURES totalvegcover, include=TRUE}

# 1) visualizing data - highlight all and run
hist(abcover_vegcover_long$percentcover) # histogram
ggplot(data = abcover_vegcover_long, aes(y = percentcover, x = site, fill = covertype)) +
    geom_boxplot() # boxplots
ggplot(data = abcover_vegcover_long, aes(y = percentcover, x = site, color = covertype)) + 
  geom_jitter()

# 2) visualize boxplots
ggplot(data = abcover_vegcover_long, aes(y = percentcover, x = site, fill = covertype))+
  geom_boxplot()+
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0, 1))+
  xlab("Site")+
  ylab("Canopy cover (%)") +
 # scale_x_discrete(labels = c("intact" = "Intact", "matrix" = "Matrix",
 #                             "degraded" = "Degraded"))+
  theme_bw()+
  theme(text = element_text(size = 14), axis.text.y = element_text(size = 12), axis.text.x = element_text(size = 12))

# 3) jitter code
ggplot(data = abcover_vegcover_long, aes(x = site, y = percentcover, color = covertype))+ #start with the raw data
  #geom_jitter(width = 0.05, alpha = 0.25, pch=ifelse(grepl("c_", prop2mdata$stim), 17,19), cex=2.5)+ #use geom_jitter to add raw data points
  #geom_point(d = plotnewdata, aes(x = stim, y = stim.mean.prop2m), shape = rep(c(17,19),2), cex = 4)+ #now use geom_point to add the model estimate means
  #geom_linerange(d = plotnewdata, aes(x=stim,ymin=lse,ymax=use),size=1.5,position=position_dodge(width=0.25)) + #and geom_linerange to add the standard errors
  #things below this line just make it look pretty
  geom_jitter()+
  geom_point()+
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0, 1.))+
  xlab("Stimulus")+
  ylab("Proportion approaching stimulus")+
  scale_x_discrete(labels = c("c_scents" = "Control Scents", "t_scents" = "Rival Scents",
                              "c_intruders" = "Control Intruders", "t_intruders" = "Rival Intruders"))+
  theme_bw()+
  theme(text = element_text(size = 14), axis.text.y = element_text(size = 12), axis.text.x = element_text(size = 12))
# end jitter code
```

```{r normality abcover total veg cover, include=TRUE}
shapiro.test(abcover_vegcover_long$percentcover) # veg cover and ground cover
# Shapiro-Wilk normality test
# data:  abcover_vegcover_long$percentcover
# W = 0.67222, p-value = 6.305e-07 <-- not normally distributed...

abcover_vegcover_long$site_rep <- paste(abcover_vegcover_long$site, abcover_vegcover_long$rep, sep="_") # combine site and rep form to one column

# total veg cover only
abcover_vegcover_long_vegonly <- abcover_vegcover_long %>% 
  filter(covertype == "percentcover_veg")

#testing for normality of veg cover only
shapiro.test(abcover_vegcover_long_vegonly$percentcover)
# 	Shapiro-Wilk normality test
# 
# data:  abcover_vegcover_long_vegonly$percentcover
# W = 0.73103, p-value = 0.0005447 <-- not normally distributed

ggqqplot(abcover_vegcover_long_vegonly$percentcover) 

abcover_vegcover_long_vegonly$site_rep <- paste(abcover_vegcover_long_vegonly$site, abcover_vegcover_long_vegonly$rep, sep="_") # combine site and rep form to one column

# code from --> http://www.sthda.com/english/wiki/kruskal-wallis-test-in-r
kruskal.test(percentcover ~ standtype, data = abcover_vegcover_long_vegonly)
# 	Kruskal-Wallis rank sum test
# 
# data:  percentcover by standtype
# Kruskal-Wallis chi-squared = 3.0521, df = 2, p-value = 0.2174 <-- not significantly different

pairwise.wilcox.test(abcover_vegcover_long_vegonly$percentcover, abcover_vegcover_long_vegonly$standtype,
                 p.adjust.method = "BH")
#          intact matrix
# matrix   0.78   -     
# degraded 0.32   0.32  <-- nothing is significant

```

```{r mean sd of abcover by site, include=TRUE}
# min / max percent cover of veg only
min(abcover_vegcover_long_vegonly$percentcover)*100 # 92.68%
max(abcover_vegcover_long_vegonly$percentcover)*100 # 100%

# mean SD by stand type
abcover_vegcover_meanSD <- abcover_vegcover_long_vegonly %>%
  group_by(standtype) %>% # by site
  summarize(mean_cover = mean(percentcover),
            n = length((percentcover)),
            sd = sd(percentcover),
            se = ((sd(percentcover))/sqrt(length((percentcover)))))
print(abcover_vegcover_meanSD)
# standtype mean_cover  n   sd            se
# intact	  0.9674797   3	  0.028163428	  0.016260163
# matrix	  0.9756098	  6	  0.030851489	  0.012595068
# degraded	0.9959350	  6	  0.009957275	  0.004065041

```

```{r bar plot totalvegcover, include=TRUE}

# combine standtype and native/nonnative status to one column
abcover_vegcover$site_rep <- paste(abcover_vegcover$site, abcover_vegcover$rep, sep="_") 

#  column plot - by site_rep
abcover_vegcover_plot_2 <- ggplot(abcover_vegcover, aes(x = site_rep, y = percentcover_veg, fill = standtype)) +
  geom_col(position = "dodge", width = 0.8) +
  labs(
    title = "Total Vegetation Cover", 
    x = "Site", 
    y = "Percent Vegetation Cover (%)") + # title, axes titles
  scale_fill_manual(values = c(standcolors)) + # manual colors
  # scale_fill_manual(values = cal_palette('chaparral2')) +  # continuous colors
  #                  limits = c("intact", "matrix", "degraded"), # "limits" reorders the x-axis
  #                  labels = c("Intact", "Matrix", "Degraded")) + # "labels" changes the name
  theme_bw() #+
 # scale_x_discrete(
 #   limits=c("intact", "matrix", "degraded"),
 #   labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded")
 #   )
abcover_vegcover_plot_2

#  column plot - by SITE
abcover_vegcover_plot <- ggplot(abcover_vegcover_meanSD, aes(x = standtype, y = mean_cover, fill = standtype)) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(
    aes(ymin = mean_cover-se, ymax=mean_cover+se), # mean +- SE
                width=.2, position=position_dodge(.9)) +
  labs(
    title = "Percent Canopy Cover", 
    x = "Site", 
    y = "Average Percent Canopy Cover (%)") + # title, axes titles
  scale_fill_manual(values = c(standcolors)) + # manual colors
  # scale_fill_manual(values = cal_palette('chaparral2')) +  # continuous colors
  #                  limits = c("intact", "matrix", "degraded"), # "limits" reorders the x-axis
  #                  labels = c("Intact", "Matrix", "Degraded")) + # "labels" changes the name
  theme_bw() #+
 # scale_x_discrete(
 #   limits=c("intact", "matrix", "degraded"),
 #   labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded")
 #   )
abcover_vegcover_plot
```


### 1.1B Percent cover by lifeform by native/nonnative status - there shouldn't be zeros in your df

```{r cover x status x lifeform - data prep, include = TRUE}
# line 933 from Ch1_Degradation_original.Rmd

# data prep
abcover_bylf_bystatus <- abcover_full_v_omitground %>% 
  group_by(standtype, lifeform, status, site, rep, site_rep) %>% 
  dplyr::summarize(
    count_per_transect = n_distinct(site_rep_dist), 
    percentcover = n_distinct(site_rep_dist)/41 # <-- calculate percent cover by transect, lifeform, and status
    )
view(abcover_bylf_bystatus) # prints to new tab

# visualizing data

## histogram 
hist(abcover_bylf_bystatus$percentcover) 

## jitter - by site_rep
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = site_rep, color = lifeform)) + 
  geom_jitter()
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = lifeform, color = standtype)) + 
  geom_jitter()
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = status)) + 
  geom_jitter()

## boxplot
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, fill = lifeform)) +
    geom_boxplot() # boxplots

## jitter - by standtype
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = lifeform)) + 
  geom_jitter()
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = status)) + 
  geom_jitter()
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = status)) + 
  geom_point()
## boxplot
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, fill = lifeform)) +
    geom_boxplot() # boxplots
```
### 1.1C Percent cover by native/nonnative status
```{r percent cover by status stats, include=TRUE}

# NATIVE and NON-NATIVE
# testing for normality by status 
shapiro.test(abcover_bylf_bystatus$percentcover) 
#W = 0.90228, p-12838.200536385179 value = 0.0001246 <-- not normally distributed


# NATIVE ONLY
abcover_bylf_bystatus_native <- abcover_bylf_bystatus %>%   # NATIVE ONLY
  filter(status =="native")
shapiro.test(abcover_bylf_bystatus_native$percentcover) 
# 	Shapiro-Wilk normality test
# 
# data:  abcover_bylf_bystatus_native$percentcover
# W = 0.89092, p-value = 0.002663 <-- not normally distributed

kruskal.test(percentcover ~ standtype, data = abcover_bylf_bystatus_native)
# Kruskal-Wallis rank sum test
# 
# data:  percentcover by standtype
# Kruskal-Wallis chi-squared = 4.1338, df = 2, p-value = 0.1266 <-- not sig different

pairwise.wilcox.test(abcover_bylf_bystatus_native$percentcover, abcover_bylf_bystatus_native$standtype,
                 p.adjust.method = "BH")
# data:  abcover_bylf_bystatus_native$percentcover and abcover_bylf_bystatus_native$standtype 
# 
#          intact matrix
# matrix   0.26   -     
# degraded 0.20   0.26  <-- no significant differences
# 
# P value adjustment method: BH 
# 
# --- ERROR MESSAGE ---
# Warning: cannot compute exact p-value with ties
# 
# From CHATGPT: The warning message you are seeing, "Warning: cannot compute exact p-value with ties," occurs when you are performing a statistical test that relies on exact p-values, such as the Mann-Whitney U test or the Kruskal-Wallis test, and there are tied values in your data. Tied values mean that there are two or more identical values in your dataset.

# When ties occur, the exact ranks of these tied values cannot be determined, leading to potential inaccuracies in the p-value calculation. Some statistical tests require exact ranks to compute p-values, so when ties are present, the software might issue a warning indicating that the p-value might not be exact.


# NON-NATVE
abcover_bylf_bystatus_nonnative <- abcover_bylf_bystatus %>%  # NON-NATIVE ONLY
  filter(status == "nonnative")
shapiro.test(abcover_bylf_bystatus_nonnative$percentcover) 
# 	Shapiro-Wilk normality test 
# 
# data:  abcover_bylf_bystatus_nonnative$percentcover
# W = 0.9056, p-value = 0.01551  <-- not normally distributed

kruskal.test(percentcover ~ standtype, data = abcover_bylf_bystatus_nonnative)
# Kruskal-Wallis rank sum test
# 
# data:  percentcover by standtype
# Kruskal-Wallis chi-squared = 11.254, df = 2, p-value = 0.0036 <-- significantly different 

pairwise.wilcox.test(abcover_bylf_bystatus_nonnative$percentcover, abcover_bylf_bystatus_nonnative$standtype,
                 p.adjust.method = "BH")
#          intact matrix
# matrix   0.078  -     
# degraded 0.013  0.039 <-- significantly different

```

```{r data prep for cover by status, include = TRUE}

abcover_nativecover <- abcover_full_v %>% 
  na.omit() %>%  
  filter(status == "native") %>% 
  group_by(standtype, site_rep) %>% 
  dplyr::summarize(count_per_transect = length(unique(distance)), 
                  percentcover_native = length(unique(distance))/41
                  )
view(abcover_nativecover)

abcover_nncover <- abcover_full_v %>% 
  na.omit() %>%  
  filter(status == "nonnative") %>% 
  group_by(standtype, site_rep) %>% 
  dplyr::summarize(count_per_transect = length(unique(distance)), 
                  percentcover_nonnative = length(unique(distance))/41
                  )
view(abcover_nncover)

abcover_bystatus <- abcover_nativecover %>% 
  left_join(abcover_nncover, by = 'site_rep')
view(abcover_bystatus)

# copy/paste data, edited in Excel, saved as csv in 2022b folder
abcover_bystatus_edited <- read.csv("abcover_bystatus.csv", header = TRUE, na.strings=c("","NA"))
print(abcover_bystatus_edited)
  
```

```{r}
ggplot(abcover_bystatus_edited, aes(fill = status, y=percentcover*100, x=site_rep)) + 
    geom_bar(position="stack", stat="identity") +
    theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Transect ID", 
       y = "Percent cover (%)", 
       title = "Percent cover by vegetation status per Trasect")
```

```{r scatterplot native cover by nn grass cover, include=TRUE}

cover_statuslf_matrix <- read.csv("percentcover_bystatus_bylifeform_matrix.csv", header = TRUE) %>% 
  mutate(lifeform = case_when(lifeform == "herb" ~ "forb", 
                              TRUE ~ lifeform))
cover_statuslf_matrix <- cover_statuslf_matrix %>% 
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded"))

#from chunk: SHRUB scatterplot 
cover_statuslf_matrix$status_lifeform <- paste(cover_statuslf_matrix$status, cover_statuslf_matrix$lifeform, sep="_") # combine status and life form to one column
cover_statuslf_matrix_long <- cover_statuslf_matrix %>%
 dplyr::select(standtype, site_rep, percentcover, status_lifeform)
view(cover_statuslf_matrix_long)

cover_statuslf_matrix_wide1 <- cover_statuslf_matrix_long %>%
  spread(status_lifeform, percentcover)
write.csv(cover_statuslf_matrix_wide1,"processed/coverstatus.csv")

view(cover_statuslf_matrix_wide1)

abcover_nativecover_nngrasscover <- left_join(abcover_nativecover, cover_statuslf_matrix_wide1, by = "site_rep")
view(abcover_nativecover_nngrasscover)

formula6 <- abcover_nativecover_nngrasscover$percentcover_native ~ abcover_nativecover_nngrasscover$nonnative_grass

native_by_nngrass_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = nonnative_grass*100, y = percentcover_native*100, shape = standtype.x, color = standtype.x)) + #shape = standtype.x, color = standtype.x
  geom_point(size = 3, alpha = 0.8) +
   scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
#  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native cover (%)", 
       title = "Total Native Cover by Non-native Grass Cover") +
  theme_bw() +  
  stat_poly_line() +
#  stat_poly_eq(use_label(c("eq", "R2")))
 stat_poly_eq(
    aes(label = paste(after_stat(eq.label), stat(adj.rr.label), sep = "~~~~")),
    formula = formula6, 
    parse=TRUE
 )
print(native_by_nngrass_regression)

#write.csv(abcover_nativecover_nngrasscover,"processed/abcover_nativecover_nngrasscover.csv")

```


```{r segmented scatterplot native shrub cover by nn grass cover, include=TRUE}

### SEGMENTED ###
p <- ggplot(abcover_nativecover_nngrasscover, aes(x = nonnative_grass, y = percentcover_native)) + geom_line()+
  geom_point()
p

#create a linear model <-- from https://rpubs.com/MarkusLoew/12164
my.lm <- lm(nonnative_grass ~ percentcover_native, data = abcover_nativecover_nngrasscover)
summary(my.lm)

# Extract the coefficients from the overall model
my.coef <- coef(my.lm)

# add the regression line to the graph
# setting the aesthetics to a constant - this provides a name that we can reference later when we add additional layers
p <- p + geom_abline(intercept = my.coef[1], 
                         slope = my.coef[2], 
                     aes(colour = "overall"))
p

# -------------------
# analyse breakpoints
# -------------------
# http://cran.r-project.org/doc/Rnews/Rnews_2008-1.pdf


# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(my.lm, 
                    seg.Z = ~ nonnative_grass,  # x-axis
                  # psi = .4, .7
                   psi = list(percentcover_native = c(.1219,.829, 0.3))
                    )

my.seg <- segmented(my.lm, seg.Z = ~ nonnative_grass, psi = list(percentcover_native = c(.1, .7)))

# When not providing estimates for the breakpoints "psi = NA" can be used.
# The number of breakpoints that will show up is not defined
#my.seg <- segmented(my.lm, 
#                    seg.Z = ~ DistanceMeters, 
#                    psi = NA)

# display the summary
summary(my.seg)

# get the breakpoints
my.seg$psi

# get the slopes
slope(my.seg)

```

```{r}


# get the slopes manually - excercise!!
my.slopes <- coef(my.seg)

# first line: 
#y = b0 + b1*x
#y = intercept1 + slope1 * x

# second line:
#y = c0 + c1*x
#y = intercept2 + slope2 * x

# third line
#y = d0 + d1 *x
#y = intercept3 + slope3 * x

# At the breakpoint (break1), the segments b and c intersect

#b0 + b1*x = c0 + c1*x

b0 <- coef(my.seg)[[1]]
b1 <- coef(my.seg)[[2]]

# Important:
# the coefficients are the differences in slope in comparison to the previous slope
c1 <- coef(my.seg)[[2]] + coef(my.seg)[[3]]
break1 <- my.seg$psi[[3]]

#Solve for c0 (intercept of second segment):
c0 <- b0 + b1 * break1 - c1 * break1


# At the breakpoint (break2), the two lines are the same again:
# the coefficients are the differences in slope in comparison to the previous slope
d1 <- coef(my.seg)[[4]] + c1
break2 <- my.seg$psi[[4]]

#Solve for d0 (intercept of third segment):
d0 <- c0 + c1 * break2 - d1 * break2

# adding lines to the graph

# line before first breakpoint
p1 <- p1 + geom_abline(intercept = b0, slope = b1, 
                     aes(colour = "first part"), show_guide = TRUE)
p1


# line after first breakpoint
p1 <- p1 + geom_abline(intercept = c0, slope = c1, 
                     aes(colour = "second part"), show_guide = TRUE)
p1


# line after second breakpoint -- if there is one
p1 <- p1 + geom_abline(intercept = d0, slope = d1, 
                     aes(colour = "third part"), show_guide = TRUE)
p1


# get the fitted data
my.fitted <- fitted(my.seg)
my.model <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover$nonnative_grass, TotalNonNativeCover = my.fitted)

# plot the fitted model
ggplot(my.model, aes(x = NonNativeGrassCover, y = TotalNonNativeCover)) + geom_line()


# add the fitted data to the exisiting plot
p1 + geom_line(data = my.model, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "tomato")

# add vertical lines to indicate the break locations
# second row of the psi-matrix
my.lines <- my.seg$psi[, 2]

p1 <- p1 + geom_vline(xintercept = my.lines, linetype = "dashed")
p1
```

```{r scatterplot native cover by native shrub cover, include=TRUE}

native_by_nativeshrub_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = native_shrub*100, y = percentcover_native*100, shape = standtype.x, color = standtype.x)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Native cover (%)", 
       title = "Total Native Cover by Natie Shrub Cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(native_by_nativeshrub_regression)

```

```{r scatterplot native forb by native shrub cover, include=TRUE}

nativeforb_by_nativeshrub_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = native_shrub*100, y = native_forb*100, shape = standtype.x, color = standtype.x)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Native forb cover (%)", 
       title = "Native forb cover x native shrub cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nativeforb_by_nativeshrub_regression)

```

```{r scatterplot native forb by nn grass cover, include=TRUE}

nativeforb_by_nngrass_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = nonnative_grass*100, y = native_forb*100, shape = standtype.x, color = standtype.x)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native forb cover (%)", 
       title = "Native forb cover x non-native grass cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nativeforb_by_nngrass_regression)

```

```{r scatterplot nonnative cover by nn grass cover, include=TRUE}

abcover_nonnative_cover <- abcover_full_v %>% 
  na.omit() %>%  
  filter(status == "nonnative") %>% 
  group_by(standtype, site_rep) %>% 
  dplyr::summarize(count_per_transect = length(unique(distance)), 
                  percentcover_nonnative = length(unique(distance))/41
                  )
view(abcover_nonnative_cover)

abcover_nonnativecover_nngrasscover <- left_join(abcover_nonnative_cover, cover_statuslf_matrix_wide1, by = "site_rep")
view(abcover_nonnativecover_nngrasscover)
write.csv(abcover_nonnativecover_nngrasscover, "processed/abcover_nonnativecover_nngrasscover.csv")

nnnative_by_nngrass_regression <- ggplot(data = abcover_nonnativecover_nngrasscover, 
       aes(x = nonnative_grass*100, y = percentcover_nonnative*100), shape = standtype.x, color = standtype.x) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
   scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Non-native cover (%)", 
       title = "Total Native Cover by Non-native Grass Cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nnnative_by_nngrass_regression)

```

```{r scatterplot nonnative cover by native shrub cover, include=TRUE}

nncover_nativeshrub <- ggplot(data = abcover_nonnativecover_nngrasscover, 
       aes(x = native_shrub*100, y = percentcover_nonnative*100, shape = standtype.x, color = standtype.x)) + #shape = standtype.x, color = standtype.x
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Total non-native cover (%)", 
       title = "Total non-native cover x native shrub cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nncover_nativeshrub)

```

```{r scatterplot nonnative grass cover by native shrub cover, include=TRUE}

nngrass_nativeshrub <- ggplot(data = abcover_nonnativecover_nngrasscover, 
       aes(x = native_shrub*100, y = nonnative_grass*100, shape = standtype.x, color = standtype.x)) + #shape = standtype.x, color = standtype.x
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Non-native grass cover (%)", 
       title = "Non-native grass cover x native shrub cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nngrass_nativeshrub)

```

# Breakpoints
```{r segmented scatterplot nonnative cover by nn grass cover, include=TRUE}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]

### SEGMENTED ###

p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) + geom_line()+
  geom_point()

p2 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) + geom_line()+
  geom_point()
p1

#create a linear model <-- from https://rpubs.com/MarkusLoew/12164
my.lm.nnnative_by_nngrass_regression <- lm(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2)
summary(my.lm.nnnative_by_nngrass_regression)

# Extract the coefficients from the overall model
my.coef.my.lm.nnnative_by_nngrass_regression <- coef(my.lm.nnnative_by_nngrass_regression)

# add the regression line to the graph
# setting the aesthetics to a constant - this provides a name that we can reference later when we add additional layers
p1 + geom_abline(intercept = my.coef.my.lm.nnnative_by_nngrass_regression[1], 
                         slope = my.coef.my.lm.nnnative_by_nngrass_regression[2], 
                     aes(colour = "overall"))
#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(my.lm.nnnative_by_nngrass_regression, 
                    seg.Z = ~ nonnative_grass,  # x-axis
                    psi = c(.3, .8)
                    )
 
# # display the summary
# summary(my.seg)
# 
# # get the breakpoints
# my.seg$psi
# 
# # get the slopes
# slope(my.seg)
# 
#   b0 <- coef(my.seg)[[1]]
#   b1 <- coef(my.seg)[[2]]
# 
# # Important:
# # the coefficients are the differences in slope in comparison to the previous slope
#   c1 <- coef(my.seg)[[2]] + coef(my.seg)[[3]]
#   break1 <- my.seg$psi[[3]]
# 
# #Solve for c0 (intercept of second segment):
#   c0 <- b0 + b1 * break1 - c1 * break1
# 
# 
# # At the breakpoint (break2), the two lines are the same again:
# # the coefficients are the differences in slope in comparison to the previous slope
#  d1 <- coef(my.seg)[[4]] + c1
#  break2 <- my.seg$psi[[4]]
# 
# #Solve for d0 (intercept of third segment): 
#  d0 <- c0 + c1 * break2 - d1 * break2
# 
# # adding lines to the graph
# 
# # line before first breakpoint
# p1 + geom_abline(intercept = b0, slope = b1, color = "red", show_guide = TRUE) + geom_abline(intercept = c0, slope = c1, color = "blue", show_guide = TRUE) + geom_abline(intercept = d0, slope = d1, color = "green", show_guide = TRUE)
# p1

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail(abcover_nonnativecover_nngrasscover2$percentcover_nonnative, n = 1))

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- my.seg$psi[, 2]

modelgraph <- p2 + 
  geom_vline(xintercept = my.lines, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE)

p2
```

```{r segmented nonnative grass/all}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]
tail <- tail(abcover_nonnativecover_nngrasscover2$percentcover_nonnative, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative))
model <- lm(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,  # x-axis
                    psi = c(.3, .8)
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass

```

```{r segmented nonnative grass/native}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$percentcover_native, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(x = nonnative_grass, y = percentcover_native))
model <- lm(percentcover_native ~ nonnative_grass, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,
                    npsi = 2
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.y, color = standtype.y)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented nonnative forb/nn grass}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_forb , decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(x = nonnative_grass, y = nonnative_forb)) +
  geom_point()
model <- lm(nonnative_forb ~ nonnative_grass, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model,
                    npsi = 2)

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented native forb/nn grass}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_forb , decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(x = nonnative_grass, y = native_forb))
model <- lm(native_forb ~ nonnative_grass, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,
                    npsi =  1
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented native shrub/nn grass}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_shrub, decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(x = nonnative_grass, y = native_shrub))
model <- lm(native_shrub ~ nonnative_grass, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,
                    npsi = 2
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented nn grass/n shrub}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_shrub, decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$native_shrub, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = native_shrub))
model <- lm(nonnative_grass~ native_shrub, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ native_shrub,
                    npsi = 1
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented native shrub/nn cover}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_shrub, decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$native_shrub, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = percentcover_nonnative, x = native_shrub))
model <- lm(percentcover_nonnative ~ native_shrub, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, npsi = 2)

plot(fitted(my.seg))

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented native cover/n shrub}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$percentcover_native, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$percentcover_native, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(y = percentcover_native, x = native_shrub)) +
  geom_point()
model <- lm(percentcover_native ~ native_shrub, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ native_shrub,
                    npsi = 2
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- min(abcover_nativecover_nngrasscover2$percentcover_native, n = 1)
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nnngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nnngrass
```

```{r segmented native forbes/n shrub}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$native_forb, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$native_forb, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(y = native_forb, x = native_shrub)) 
model <- lm(native_forb ~ native_shrub, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, npsi = 2)

plot(fitted(my.seg))

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- min(abcover_nativecover_nngrasscover2$percentcover_native, n = 1)
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented nnforb /n shrub}

# KIT - can you let me know if I ran this and the next chunck correctly - and why my shapes aren't showing up for this figure? Thank you!

abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$nonnative_forb, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$native_shrub, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(y = nonnative_forb, x = native_shrub))
model <- lm(nonnative_forb ~ native_shrub, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ native_shrub,
                    npsi = 1 #this is where you change number of thresholds?
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) { 
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0 #min(abcover_nativecover_nngrasscover2$nonnative_forb, n = 1)
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nnngrass <- p1 + 
  geom_point(aes(shape = standtype.y, color = standtype.y)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nnngrass
```

```{r segmented nonnative grass/native grass}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$native_grass, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(x = nonnative_grass, y = native_grass))
model <- lm(native_grass ~ nonnative_grass, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.y, color = standtype.y)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```
#end


```{r}
library(strucchange)

abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]

bp <- breakpoints(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2, h = 1)
summary(bp)

plot(bp, breaks = 4)
plot(nonnative_grass ~ percentcover_native, data = abcover_nativecover_nngrasscover2, pch = 19)
lines(fitted(bp, breaks = 1) ~ abcover_nativecover_nngrasscover2$percentcover_native, col = 4, lwd = 1.5)

#breakpoints to fitted data
my.fitted1 <- fitted(bp, breaks = 2)
my.model1 <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover2$percentcover_nonnative, TotalNonNativeCover = my.fitted1)

p3 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) +
  geom_point()
p3 <- p3 + geom_line(data = my.model1, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "green4")
p3

# #deep fit
# my.fitted2 <- fitted(bp, breaks = 2)
# my.model2 <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover2$percentcover_nonnative, TotalNonNativeCover = my.fitted2)
# 
# p4 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) +
#   geom_point()
# p4 <- p4 + geom_line(data = my.model2, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "tomato")
# p4

abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]

bp <- breakpoints(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2, h = 3)
summary(bp)

plot(bp, breaks = 3)
plot(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2, pch = 19)
lines(fitted(bp, breaks = 1) ~ abcover_nonnativecover_nngrasscover2$percentcover_nonnative, col = 4, lwd = 1.5)

#breakpoints to fitted data
my.fitted1 <- fitted(bp, breaks = 1)
my.model1 <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover2$percentcover_nonnative, TotalNonNativeCover = my.fitted1)

p3 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) +
  geom_point()
p3 <- p3 + geom_line(data = my.model1, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "green4")
p3
```



```{r }

#write.csv(abcover_bylf_bystatus,"processed/percentcover_bystatus_bylifeform.csv")
# GET RID OF ZEROS in df
cover_statuslf_matrix <- read.csv("percentcover_bystatus_bylifeform_matrix.csv", header = TRUE) %>% mutate(lifeform = case_when(lifeform == "herb" ~ "forb", TRUE ~ lifeform))
cover_statuslf_matrix <- cover_statuslf_matrix %>% 
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded"))
```

### STACKED proportion of Family by Transect
```{r proportion cover by family, include=TRUE}


# data prep
abcover_byfamily <- abcover_full_v_omitground %>% 
  group_by(standtype, site, rep, site_rep, family, status) %>% 
  #group_by(standtype, site, rep, site_rep, family, lifeform, status) %>% 
  dplyr::summarize(
    count_per_transect = n_distinct(site_rep_dist))

# view(abcover_byfamily) # prints to new tab

abcover_transect_count <- abcover_byfamily %>%
  group_by(site_rep) %>%
  dplyr::summarize(total_by_transect = sum(count_per_transect))

abcover_byfamily_percent <- abcover_byfamily %>%
  left_join(abcover_transect_count, by = c("site_rep")) %>%
  mutate(percent_cover = (count_per_transect/total_by_transect)*100) %>%
  dplyr::select(!c(total_by_transect, count_per_transect))

# view(abcover_byfamily_percent) # prints to new tab

#this is with just the counts
ggplot(abcover_byfamily, aes(fill=family, y=count_per_transect, x=site_rep)) + 
  geom_bar(position="fill", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#this is the percents we calculated
ggplot(abcover_byfamily_percent %>% 
         dplyr::filter(status == "native" | status == "nonnative"),
       aes(fill=family, y=percent_cover, x=site_rep)) + 
  geom_bar(position="stack", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~ status)

#this is the percents we calculated - native
ggplot(abcover_byfamily_percent %>% 
         dplyr::filter(status == "native"),
       aes(fill=family, y=percent_cover, x=site_rep)) + 
  geom_bar(position="stack", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#this is the percents we calculated - nonnative
ggplot(abcover_byfamily_percent %>% 
         dplyr::filter(status == "nonnative"),
       aes(fill=family, y=percent_cover, x=site_rep)) + 
  geom_bar(position="stack", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

### SEGMENTATION

```{r segmentation internet info, include = FALSE}
# Install and load the segmented package if you haven't already
#install.packages("segmented")
#library(segmented)

# Generate some example data
set.seed(123)
x <- 1:100
y <- c(2 * x[1:50] + rnorm(50, mean = 0, sd = 10),
       5 * x[51:100] + rnorm(50, mean = 0, sd = 10))

# Fit segmented regression model with one breakpoint
seg_model <- segmented(lm(y ~ x), seg.Z = ~ x, psi = c(80))
seg_model2 <- segmented(lm(y ~ x), seg.Z = ~ x, psi = c(50))
# Plot the segmented regression line
plot(x, y, col = "blue", pch = 16, main = "Segmented Regression Example")
lines(x, predict(seg_model), col = "red", lwd = 2)
lines(x, predict(seg_model2), col = "green", lwd = 2)

#https://cran.r-project.org/web/packages/segmented/segmented.pdf
#page 37: Segmented relationships in regression models
set.seed(12)
xx<-1:100
zz<-runif(100)
yy<-2+1.5*pmax(xx-35,0)-1.5*pmax(xx-70,0)+15*pmax(zz-.5,0)+rnorm(100,0,2)
dati<-data.frame(x=xx,y=yy,z=zz)
out.lm<-lm(y~x,data=dati)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
o<-segmented(out.lm) #1 breakpoint for x

#the single segmented variable is not in the starting model, and thus..
#... you need to specify it via seg.Z, but no starting value for psi
o<-segmented(out.lm, seg.Z=~z)
#note the leftmost slope is constrained to be zero (since out.lm does not include z)

#2 segmented variables, 1 breakpoint each (again no need to specify npsi or psi)
o<-segmented(out.lm,seg.Z=~z+x)

#1 segmented variable, but 2 breakpoints: you have to specify starting values (vector) for psi:
o<-segmented(out.lm,seg.Z=~x,psi=c(30,60), control=seg.control(display=FALSE))

#.. or you can specify just the *number* of breakpoints
#o<-segmented(out.lm,seg.Z=~x, npsi=2, control=seg.control(display=FALSE))

slope(o) #the slopes of the segmented relationship

#2 segmented variables: starting values requested via a named list
out.lm<-lm(y~z,data=dati)
o1<-update(o,seg.Z=~x+z,psi=list(x=c(30,60),z=.3))
#..or by specifying just the *number* of breakpoints
#o1<-update(o,seg.Z=~x+z, npsi=c(x=2,z=1))

#the default method leads to the same results (but it is slower)
#o1<-segmented.default(out.lm,seg.Z=~x+z,psi=list(x=c(30,60),z=.3))
#o1<-segmented.default(out.lm,seg.Z=~x+z,psi=list(x=c(30,60),z=.3),
# control=seg.control(fn.obj="sum(x$residuals^2)"))

#automatic procedure to estimate breakpoints in the covariate x (starting from K quantiles)
# Hint: increases number of iterations. Notice: bootstrap restart is not allowed!
#o<-segmented.lm(out.lm,seg.Z=~x+z,psi=list(x=NA,z=.3),
# control=seg.control(fix.npsi=FALSE, n.boot=0, tol=1e-7, it.max = 50, K=5, display=TRUE))

#assess the progress of the breakpoint estimates throughout the iterations
## Not run:
par(mfrow=c(1,2))
draw.history(o, "x")
draw.history(o, "z")
## End(Not run)
#try to increase the number of iterations and re-assess the
#convergence diagnostics
# A simple segmented model with continuous responses and no linear covariates
# No need to fit the starting lm model:
segmented(yy, npsi=2) #NOTE: subsetting the vector works ( segmented(yy[-1],..) )
#if seg.Z is unspecified, the segmented variable is taken as 1:n/n
# An example using the Arima method:
## Not run:
n<-50
idt <-1:n #the time index
mu<-50-idt +1.5*pmax(idt-30,0)
set.seed(6969)
y<-mu+arima.sim(list(ar=.5),n)*3.5
o<-arima(y, c(1,0,0), xreg=idt)
os1<-segmented(o, ~idt, control=seg.control(display=TRUE))
#note using the .coef argument is mandatory!
slope(os1, .coef=os1$coef)
plot(y)
plot(os1, add=TRUE, .coef=os1$coef, col=2)
## End(Not run)

######Three examples using the default method:
#==> 1. Cox regression with a segmented relationship
## Not run:
library(survival)
data(stanford2)
o<-coxph(Surv(time, status)~age, data=stanford2)
os<-segmented(o, ~age, psi=40) #estimate the breakpoint in the age effect
summary(os) #actually it means summary.coxph(os)
plot(os) #it does not work
plot.segmented(os) #call explicitly plot.segmented() to plot the fitted piecewise lines

# ==> 2. Linear mixed model via the nlme package
dati$g<-gl(10,10) #the cluster 'id' variable
library(nlme)
o<-lme(y~x+z, random=~1|g, data=dati)
os<-segmented.default(o, ~x+z, npsi=list(x=2, z=1))

#summarizing results (note the '.coef' argument)
slope(os, .coef=fixef(os))
plot.segmented(os, "x", .coef=fixef(os), conf.level=.95)
confint.segmented(os, "x", .coef=fixef(os))
dd<-data.frame(x=c(20,50),z=c(.2,.6), g=1:2)
predict.segmented(os, newdata=dd, .coef=fixef(os))


# ==> 3. segmented quantile regression via the quantreg package
library(quantreg)
data(Mammals)
y<-with(Mammals, log(speed))
x<-with(Mammals, log(weight))
o<-rq(y~x, tau=.9)
os<-segmented.default(o, ~x) #it does NOT work. It cannot compute the vcov matrix..

#Let's define the vcov.rq function.. (I don't know if it is the best option..)
vcov.rq<-function(x,...) {
V<-summary(x,cov=TRUE,se="nid",...)$cov
rownames(V)<-colnames(V)<-names(x$coef)
V}

os<-segmented.default(o, ~x) #now it does work
plot.segmented(os, res=TRUE, col=2, conf.level=.95)

## End(Not run)
```

```{r segmentation }

```


### - SHRUB

```{r cover by lf by status - stats, include=TRUE}
# SHRUB
# highlight all and run as one command
cover_statuslf_matrix_shrub <- cover_statuslf_matrix %>% 
  filter(lifeform == "shrub" & status == "native")

shapiro.test(cover_statuslf_matrix_shrub$percentcover)
# 	Shapiro-Wilk normality test
# data:  cover_statuslf_matrix_shrub$percentcover
# W = 0.94384, p-value = 0.4331 <-- normally distributed

summary(aov(percentcover ~ standtype, data = cover_statuslf_matrix_shrub))
# Df Sum Sq Mean Sq F value   Pr(>F)    
# standtype    2 0.5516 0.27581    13.9 0.000752 *** <-- significantly different
# Residuals   12 0.2382 0.01985     

TukeyHSD(aov(percentcover ~ standtype, data = cover_statuslf_matrix_shrub))
# Fit: aov(formula = percentcover ~ standtype, data = cover_statuslf_matrix_shrub)
# 
# $standtype
#                       diff        lwr         upr     p adj
# matrix-intact   -0.2723577 -0.5381149 -0.00660053 0.0444896 <-- MAT-INT
# degraded-intact -0.5162602 -0.7820174 -0.25050297 0.0006178 <-- DEG-INT
# degraded-matrix -0.2439024 -0.4608923 -0.02691260 0.0277839 <-- DEG-MAT
                
```

```{r figure shrub, include=TRUE}

# Reorder the levels of the standtype variable
cover_statuslf_matrix$site_rep <- factor(cover_statuslf_matrix$site_rep, 
                                          levels = c("Intact_1_1"
, "Intact_2_2" , "Intact_3_3", "ENH1_1" ,    "ENH1_2"   ,  "ENH1_3" ,    "ENH2_4" ,    "ENH2_5"    ,"ENH2_6", "DEG1_1",     "DEG1_2"  ,   "DEG1_3"   ,  "DEG2_4" ,    "DEG2_5"   ,  "DEG2_6"))


ggplot(data = cover_statuslf_matrix %>% filter((lifeform == 'shrub')) %>% filter((status == 'native')), 
     aes(x = site_rep, y = percentcover*100, fill = standtype)) +
   geom_col(color = "black") +
  scale_fill_manual(values = standcolors) +
  labs(x = "Transect", y = "Shrub Cover (%)", title = "Shrub Cover by Transect") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels by 45 degrees

```

```{r SHRUB scatterplot, include = TRUE}
# The arguments to spread():
# - data: Data object
# - key: Name of column containing the new column names
# - value: Name of column containing values
cover_statuslf_matrix$status_lifeform <- paste(cover_statuslf_matrix$status, cover_statuslf_matrix$lifeform, sep="_") # combine status and life form to one column
cover_statuslf_matrix_long <- cover_statuslf_matrix %>%
 dplyr::select(standtype, site_rep, percentcover, status_lifeform)
view(cover_statuslf_matrix_long)



# scatterplot - shrub x nn grass
shub_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1, 
       aes(x = nonnative_grass*100, y = native_shrub*100)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native shrub cover (%)", 
       title = "Native Shrub Cover by Non-native Grass Cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

shub_grass_scatter_print <- shub_grass_scatter+ theme(legend.position = c(0.15, 0.2))

ggsave("Ch1_Degradation_figures/shub_grass_scatter_print.png", shub_grass_scatter_print, width = 8, height = 6)

```

### - FORB

```{r forb native percent cover by site_rep, include=TRUE}

# FORB
cover_statuslf_matrix %>% 
  filter(lifeform == 'forb') %>% 
  group_by(site_rep, status) 

cover_statuslf_matrix %>% 
  filter(lifeform == 'forb' & status == "native") %>% 
  group_by(site_rep) 

cover_statuslf_matrix %>% 
  filter(lifeform == 'forb' & status == "nonnative") %>% 
  group_by(site_rep) 
```

```{r scatterplot forb native percent cover, include = TRUE}
# scatterplot - forb x nn grass
natforb_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1,
              aes(x = nonnative_grass*100, y = native_forb*100)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native forb cover (%)", 
       title = "Native forb cover by non-native grass cover") +
  theme_bw() +
   stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

# scatterplot - nnforb x nn grass
nnforb_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1,
              aes(x = nonnative_grass*100, y = nonnative_forb*100)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm, gam
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Non-native forb cover (%)", 
       title = "Non-native forb cover by non-native grass cover") +
  theme_bw() +
   stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

natforb_grass_scatter_print <- natforb_grass_scatter + theme(legend.position = c(0.15, 0.8))
nnforb_grass_scatter_print <- nnforb_grass_scatter+ theme(legend.position = c(0.15, 0.8))

# print the plots into a single figure
grid.arrange(natforb_grass_scatter_print, nnforb_grass_scatter_print, ncol = 1, nrow = 2)

ggsave("Ch1_Degradation_figures/natforb_grass_scatter.png", natforb_grass_scatter_print, width = 8, height = 6)
ggsave("Ch1_Degradation_figures/nnforb_grass_scatter.png", nnforb_grass_scatter_print, width = 8, height = 6)
```

```{r forb stats percent cover by site}

# FORB
abcover_bylf_bystatus_aov_forb <- aov(percentcover ~ standtype * status, data = cover_statuslf_matrix %>% filter((lifeform == 'forb')))

print(summary(abcover_bylf_bystatus_aov_forb))

print(TukeyHSD(abcover_bylf_bystatus_aov_forb))
## forb - native
abcover_bylf_bystatus_aov_forbnat <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'forb')) %>% filter((status == 'native')))
print(summary(abcover_bylf_bystatus_aov_forbnat))
# Df  Sum Sq  Mean Sq F value Pr(>F)
#standtype    2 0.00512 0.002558   0.905   0.43
#Residuals   12 0.03391 0.002826  
print(TukeyHSD(abcover_bylf_bystatus_aov_forbnat))
#$standtype
#                      diff         lwr       upr     p adj
#intact-degraded 0.02845528 -0.07182408 0.1287347 0.7352620
#matrix-degraded 0.04065041 -0.04122735 0.1225282 0.4091252
#matrix-intact   0.01219512 -0.08808424 0.1124745 0.9438944 
# NO SIG differences
# forb - nonnative
abcover_bylf_bystatus_aov_forbnn <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'forb')) %>% filter((status == 'nonnative')))
print(summary(abcover_bylf_bystatus_aov_forbnn))
#    Df Sum Sq Mean Sq F value   Pr(>F)    
#standtype    2 0.6180 0.30901    13.3 0.000904 ***
#Residuals   12 0.2789 0.02324    
print(TukeyHSD(abcover_bylf_bystatus_aov_forbnn))
#$standtype
#                      diff        lwr        upr     p adj
#intact-degraded -0.5081301 -0.7957264 -0.2205337 0.0013474 <-- Int - Deg
#matrix-degraded -0.3373984 -0.5722198 -0.1025769 0.0062271 <-- Mat - Deg
#matrix-intact    0.1707317 -0.1168647  0.4583281 0.2896736

```

### - GRASS
```{r grass}
# GRASS
abcover_bylf_bystatus_aov_grass <- aov(percentcover ~ standtype * status, data = cover_statuslf_matrix %>% 
                                   filter((lifeform == 'grass')))
print(summary(abcover_bylf_bystatus_aov_grass))
print(TukeyHSD(abcover_bylf_bystatus_aov_grass))
## grass - native
abcover_bylf_bystatus_aov_grassnat <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'grass')) %>% filter((status == 'native')))
print(summary(abcover_bylf_bystatus_aov_grassnat))
# print(summary(abcover_bylf_bystatus_aov_grassnat))
#            Df Sum Sq Mean Sq F value   Pr(>F)    
#standtype    2 0.6728  0.3364   30.36 2.02e-05 ***
#Residuals   12 0.1330  0.0111  
print(TukeyHSD(abcover_bylf_bystatus_aov_grassnat))
#$standtype
#                       diff         lwr        upr     p adj
#intact-degraded  0.56097561  0.36240594  0.7595453 0.0000191 <-- Int - Deg
#matrix-degraded  0.07723577 -0.08489569  0.2393672 0.4370582
#matrix-intact   -0.48373984 -0.68230951 -0.2851702 0.0000808 <-- Int - Mat
# SIG MORE native grass at Intact
# nonnative
abcover_bylf_bystatus_aov_grassnn <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'grass')) %>% filter((status == 'nonnative')))
print(summary(abcover_bylf_bystatus_aov_grassnn))
#            Df Sum Sq Mean Sq F value   Pr(>F)    
#standtype    2 1.3178  0.6589   55.46 8.66e-07 ***
#Residuals   12 0.1426  0.0119 
print(TukeyHSD(abcover_bylf_bystatus_aov_grassnn))
#$standtype
#                      diff        lwr         upr     p adj
#intact-degraded -0.8089431 -1.0145691 -0.60331712 0.0000006 <-- 
#matrix-degraded -0.2195122 -0.3874051 -0.05161929 0.0115409 <--
#matrix-intact    0.5894309  0.3838049  0.79505687 0.0000165 <-- 
# SIG different non-native grass among sites



# scatterplot - nnforb x nn grass
natgrass_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1,
              aes(x = nonnative_grass*100, y = native_grass*100, color = standtype)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm, gam
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native grass cover (%)", 
       title = "Native grass cover by non-native grass cover") +
  theme_bw()

natgrass_grass_scatter_print <- natgrass_grass_scatter + theme(legend.position = c(0.8, 0.8))

ggsave("Ch1_Degradation_figures/natgrass_grass_scatter_print.png", natgrass_grass_scatter_print, width = 8, height = 6)

```

```{r fern}
# FERN
abcover_bylf_bystatus_aov_fern <- aov(percentcover ~ standtype * status, data = cover_statuslf_matrix %>% 
                                   filter((lifeform == 'fern')))
print(summary(abcover_bylf_bystatus_aov_fern))
print(TukeyHSD(abcover_bylf_bystatus_aov_fern))
## fern - native
abcover_bylf_bystatus_aov_fernnat <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'fern')) %>% filter((status == 'native')))
print(summary(abcover_bylf_bystatus_aov_fernnat))
print(TukeyHSD(abcover_bylf_bystatus_aov_fernnat))
#$standtype <-- can't really do stats on only one occurrence
#                         diff          lwr         upr   p adj
#intact-degraded  8.130081e-03 -0.002714893 0.018975056 0.15458 
#matrix-degraded  1.662443e-18 -0.008854884 0.008854884 1.00000
#matrix-intact   -8.130081e-03 -0.018975056 0.002714893 0.15458
# nonnative
abcover_bylf_bystatus_aov_fernnn <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'fern')) %>% filter((status == 'nonnative')))
print(summary(abcover_bylf_bystatus_aov_fernnn))
print(TukeyHSD(abcover_bylf_bystatus_aov_fernnn))

abcover_bylf_bystatus_meanSD <- cover_statuslf_matrix %>%  
  group_by(lifeform, status, standtype) %>% 
  summarize(avg_cover = mean(percentcover), 
            sd = sd(percentcover),
            N = length(percentcover), 
            se = ((sd(percentcover))/sqrt(length((percentcover)))))

abcover_bylf_bystatus_meanSD$status_lifeform <- paste(abcover_bylf_bystatus_meanSD$status, abcover_bylf_bystatus_meanSD$lifeform, sep="_") # combine status and life form to one column
print(abcover_bylf_bystatus_meanSD) 
```

```{r percent cover x nn grass combine, include = TRUE}

# print the plots into a single figure
nncover_combined <- grid.arrange(shub_grass_scatter_print, natgrass_grass_scatter_print, natforb_grass_scatter_print, nnforb_grass_scatter_print, ncol = 2, nrow = 2,
  heights = c(1, 1),  # Adjust the height ratios between rows
  widths = c(1, 1)     # Adjust the width ratios between columns
)

ggsave("Ch1_Degradation_figures/nncover_combined.png", nncover_combined, width = 15, height = 10)
```

### - STATS
```{r plot abcover_bylf_meanSD, include = TRUE}
# line 965 in Ch1_Degradation_original.Rmd

#  column plot, 2 x 2 by lifeform
abcover_bylf_bystatus_meanSD_plot_wrap <- ggplot(abcover_bylf_bystatus_meanSD, aes(x = status, y = avg_cover, fill = standtype )) +
  facet_wrap(~ lifeform) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(aes(ymin=avg_cover-se, ymax=avg_cover+se), width=.2,
                 position=position_dodge(.9)) +
  labs(title = "Percent Cover by status and standtype", x = "Status", y = "Average Percent Cover (%)") +
  scale_fill_manual(values = c(standcolors)) + # manual colors
#   scale_fill_manual(values = cal_palette('chaparral3')) + # continuous colors
                       theme_bw()

abcover_bylf_bystatus_meanSD_plot_wrap + scale_x_discrete(limits=c("intact", "matrix", "degraded"),
                                         labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded"))


```

### 1.2 Canopy height (vertical variation)

```{r load csv - canopy height, include=TRUE}
# stand height 

standheight_full <- read_csv("deg_maxheight.csv",
                             col_types = cols(
                               standtype = col_character(),
                               site = col_character(),
                               Transect_rep = col_character(),
                               Reading = col_character(),
                               Species = col_character(),
                               height_cm = col_double(),
                               next_tallest = col_character())) %>%
  dplyr::select('standtype', 'site', 'Transect_rep', 'Reading', 'Species', 'height_cm') %>% 
  rename(rep = Transect_rep, 
         reading = Reading, 
         species = Species) %>% 
  mutate(site = case_when(site == "ENH_1" ~ "ENH1", # old name ~ new name
                          site == "ENH_2" ~ "ENH2",
                          site == "ENH_3" ~ "ENH3", 
                          site == "DEG_1" ~ "DEG1",
                          site == "DEG_2" ~ "DEG2", 
                          site == "DEG_3" ~ "DEG3", 
                          TRUE ~ site)) %>% 
  mutate(standtype = fct_relevel(standtype, "Intact", "Matrix", "Degraded")) %>% 
  filter(site!= "Intact_4")
view(standheight_full)

standheight_full %>%  
  group_by(site,rep) %>% 
  summarize(data_points = length(reading))
```

```{r max height plot, include = TRUE}

standheight_full$site_rep <- paste(standheight_full$site, standheight_full$rep, sep="_") # combine site and rep to one column

ggplot(standheight_full, aes(x = as.integer(reading)/2, y = height_cm/100, group = site_rep, color = standtype)) +
 # facet_wrap(~ standtype, scales = "free_y", ncol = 1) +
  geom_line() +
  labs(
    title = "Canopy Height by Point-Intercept transect distance",
    x = "Distance (m)",
    y = "Height (m)"
  ) +
  ylim(0, 5)+
  theme_bw()

histogram(standheight_full$height_cm)

ggplot(data = standheight_full, 
       aes(x = site_rep, y = height_cm)) +
  geom_point() +
  theme(axis.text.x.bottom = element_text(angle = 90)) +  
  labs(x = "Transect ID", 
       y = "Canopy height (cm)", 
       title = "Canopy height (cm) by transect")

ggplot(standheight_full, 
       aes(x = site_rep, y = height_cm)) +
  geom_boxplot() +
  theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Transect ID", 
       y = "Canopy height (cm)", 
       title = "Canopy height (cm) by transect")
```

```{r combine columns - canopy height, include = TRUE}

# mean SD by transect - 15 rows
standheight_siterep_meanSD <- standheight_full %>% 
  left_join(nncover, by = 'site_rep') %>% 
  group_by(standtype, site_rep) %>%
  summarize(mean_height = mean(height_cm),
            n = length((height_cm)),
            sd = sd(height_cm),
            se = ((sd(height_cm))/sqrt(length((height_cm)))), 
            mean_nngrasscover = mean(nonnative_grass), 
            mean_nativeshrubcover = mean(native_shrub)) %>% 
  print(standheight_siterep_meanSD) # prints: standtype - site_rep - mean... 

# mean SD by transect - 15 rows
standheight_site_meanSD <- standheight_full %>% 
   left_join(nncover, by = 'site_rep') %>% 
  group_by(standtype, site) %>%
  summarize(mean_height = mean(height_cm),
            n = length((height_cm)),
            sd = sd(height_cm),
            se = ((sd(height_cm))/sqrt(length((height_cm)))), 
            mean_nngrasscover = mean(nonnative_grass), 
            mean_nativeshrubcover = mean(native_shrub)) %>% 
  print(standheight_site_meanSD) # prints: standtype - site_rep - mean... 
```

```{r}
# columnn plot x site_rep
ggplot(standheight_siterep_meanSD, 
       aes(x = site_rep, y = mean_height, fill = standtype)) +
  geom_col(color = "black") +
  scale_fill_manual(values = standcolors) +
  geom_errorbar(aes(ymin = mean_height - se, ymax = mean_height + se), width = 0.5) +
   theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Transect ID", 
   y = "Mean canopy height (cm)", 
       title = "Mean canopy height (cm) by transect")

# columnn plot x site
ggplot(standheight_site_meanSD, 
       aes(x = site, y = mean_height, fill = standtype)) +
  geom_col(color = "black") +
  scale_fill_manual(values = standcolors) +
  geom_errorbar(aes(ymin = mean_height - se, ymax = mean_height + se), width = 0.5) +
   #theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Hillslope", 
   y = "Mean canopy height (cm)", 
       title = "Mean canopy height (cm) by hillslope")

# columnn plot - mean height x nngrass
ggplot(standheight_siterep_meanSD, 
       aes(x = mean_nngrasscover, y = mean_height, color = site)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean_height - se, ymax = mean_height + se)) +
  # theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Non-native grass cover (%)", 
   y = "Mean canopy height (cm)", 
       title = "Mean canopy height (cm) by non-native grass cover (%)")

# columnn plot x site
ggplot(standheight_site_meanSD, 
       aes(x = mean_nngrasscover, y = mean_height, color = site)) +
  geom_point()+
  geom_errorbar(aes(ymin = mean_height - se, ymax = mean_height + se)) +
   #theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Hillslope", 
   y = "Mean canopy height (cm)", 
       title = "Mean canopy height (cm) by hillslope")



```


```{r stand height stats, include = TRUE}
shapiro.test(standheight_full$height_cm)
# 	Shapiro-Wilk normality test
# data:  standheight_full$height_cm
# W = 0.90732, p-value < 2.2e-16 <-- not normally distributed

kruskal.test(height_cm ~ site_rep, data = standheight_full)
# Kruskal-Wallis rank sum test
# 
# data:  height_cm by site_rep
# Kruskal-Wallis chi-squared = 108.21, df = 14, p-value < 2.2e-16 <-- there are sig differences

pairwise.wilcox.test(standheight_full$height_cm, standheight_full$site_rep,
                 p.adjust.method = "BH")
# 	Pairwise comparisons using Wilcoxon rank sum test with continuity correction <-- error message Warning: cannot compute exact p-value with ties
# 
# data:  standheight_full$height_cm and standheight_full$site_rep 
# 
#            DEG1_1  DEG1_2  DEG1_3  DEG2_4  DEG2_5  DEG2_6  ENH1_1  ENH1_2  ENH1_3  ENH2_4  ENH2_5  ENH2_6  Intact_1_1 Intact_2_2
# DEG1_2     0.04716 -       -       -       -       -       -       -       -       -       -       -       -          -         
# DEG1_3     0.00793 0.58907 -       -       -       -       -       -       -       -       -       -       -          -         
# DEG2_4     0.41016 0.45869 0.11792 -       -       -       -       -       -       -       -       -       -          -         
# DEG2_5     0.09542 0.72119 0.91270 0.61011 -       -       -       -       -       -       -       -       -          -         
# DEG2_6     0.63898 0.28765 0.10600 0.44577 0.17387 -       -       -       -       -       -       -       -          -         
# ENH1_1     0.07404 0.27538 0.25829 0.56390 0.88053 0.41016 -       -       -       -       -       -       -          -         
# ENH1_2     0.54994 0.42863 0.40877 0.29792 0.19663 0.35502 0.31081 -       -       -       -       -       -          -         
# ENH1_3     0.26132 0.05340 0.03912 0.09197 0.02673 0.10600 0.05315 0.77211 -       -       -       -       -          -         
# ENH2_4     8.6e-05 0.00048 0.00060 0.00462 0.03918 0.00098 0.02173 0.03976 0.00032 -       -       -       -          -         
# ENH2_5     2.8e-06 2.2e-05 2.2e-05 0.00169 0.02360 0.00011 0.01594 0.04716 0.00020 0.79009 -       -       -          -         
# ENH2_6     0.00046 0.00716 0.00983 0.02527 0.11387 0.00401 0.08484 0.05187 0.00095 0.49368 0.58907 -       -          -         
# Intact_1_1 0.10762 0.07438 0.06278 0.05290 0.04193 0.07902 0.12226 0.72467 0.43908 0.01229 0.01594 0.01594 -          -         
# Intact_2_2 0.43529 0.81915 0.56431 0.91873 0.63838 0.63898 0.85178 0.16836 0.05208 0.06034 0.04788 0.13437 0.05187    -         
# Intact_3_3 1.0e-05 5.8e-07 1.9e-07 4.9e-06 1.3e-06 3.2e-06 1.4e-06 0.00524 0.00034 4.2e-08 2.4e-08 5.2e-08 0.03621    3.2e-06 


kruskal.test(height_cm ~ site, data = standheight_full)
# 	Kruskal-Wallis rank sum test
# 
# data:  height_cm by site
# Kruskal-Wallis chi-squared = 98.456, df = 6, p-value < 2.2e-16 <-- ther are sig differences

pairwise.wilcox.test(standheight_full$height_cm, standheight_full$site,
                 p.adjust.method = "BH")
# Pairwise comparisons using Wilcoxon rank sum test with continuity correction <-- error message Warning: cannot compute exact p-value with ties
# 
# data:  standheight_full$height_cm and standheight_full$site 
# 
#          DEG1    DEG2    ENH1    ENH2    Intact_1 Intact_2
# DEG2     0.7707  -       -       -       -        -       
# ENH1     0.5132  0.1258  -       -       -        -       
# ENH2     1.4e-11 4.1e-07 9.1e-07 -       -        -       
# Intact_1 0.0223  0.0139  0.2486  0.0012  -        -       
# Intact_2 0.9924  0.9924  0.1258  0.0218  0.0363   -       
# Intact_3 2.2e-10 1.1e-09 8.5e-07 6.5e-13 0.0223   8.5e-07 
```



```{r extra code - mean canopy height by stand type, include=FALSE}

# mean SD by stand type - 3 stand types
standheight_standtype_meanSD <- standheight_full %>%
  group_by(standtype, rep) %>%
  summarize(mean_height_byrep = mean(height_cm),
            n = length((height_cm)),
            sd = sd(height_cm),
            se = ((sd(height_cm))/sqrt(length((height_cm))))) %>% # equivalent to: standheight_siterep_meanSD
  group_by(standtype) %>% 
   summarize(mean_height_bystandtype_cm = mean(mean_height_byrep),
             n = length((mean_height_byrep)),
             sd_cm = sd(mean_height_byrep),
             se_cm = ((sd(mean_height_byrep))/sqrt(length((mean_height_byrep))))) %>% # summarizes by standtype
  print(standheight_standtype_meanSD)

# standtype mean_height_bystandtype N SD SE
#Intact	  150.29268	3	62.942199	36.339695
#Matrix	  90.17480	6	30.885894	12.609114
#Degraded	94.00813	6	6.593106	2.691624

```

```{r canopy height by stand type - stats, include=FALSE}


shapiro.test(standheight_full$height_cm)
# 	Shapiro-Wilk normality test
# data:  standheight_full$height_cm
# W = 0.90732, p-value < 2.2e-16 <-- not normally distributed

kruskal.test(height_cm ~ standtype, data = standheight_full)
# 	Kruskal-Wallis rank sum test
# data:  height_cm by standtype
# Kruskal-Wallis chi-squared = 37.914, df = 2, p-value = 5.85e-09

pairwise.wilcox.test(standheight_full$height_cm, standheight_full$standtype,
                 p.adjust.method = "BH")
# Pairwise comparisons using Wilcoxon rank sum test with continuity correction 
# data:  standheight_full$height_cm and standheight_full$standtype 
#          Intact  Matrix 
# Matrix   9.7e-07 -      
# Degraded 9.7e-07 0.00042 <-- all are significantly different
# P value adjustment method: BH 
```

```{r COV - stand height by transect line, include=TRUE}
standheight_cov_transect <- standheight_siterep_meanSD %>% # Intact n = 3, Matrix and Deg n = 6
  mutate(cov_bytransect = sd/mean_height) %>% # COV = SD / mean
  print(standheight_cov_transect)

standheight_cov_transect[order(standheight_cov_transect$cov_bytransect), ]

```


```{r COV by transect prep, include=FALSE}
#add mean height to site_rep

transect_prepCOV <- standheight_siterep_meanSD %>% 
  dplyr::select('site_rep', 'mean_height')

transectCOV <- standheight_full %>% 
  left_join(transect_prepCOV, by = 'site_rep') %>% 
   dplyr::select(!c('standtype.y')) %>% 
  rename('standtype' = 'standtype.x') %>% 
  mutate(dist_from_mean = height_cm - mean_height) %>% 
  left_join(nncover, by = 'site_rep') %>% 
  dplyr::select(!c('standtype', 'standtype.y', 'X')) %>% 
  rename('standtype' = 'standtype.x')
  

print(transectCOV)
```

```{r graph distance from mean canopy height, include=FALSE}

# distance from mean canopy height x transect
# - scatterplot
ggplot(data = transectCOV, 
       aes(x = site_rep, y = dist_from_mean)) +
  geom_point() +
  theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Transect ID", 
       y = "Distance from mean canopy cover (cm)", 
       title = "Distance from mean canopy height (cm) by Transect ID")
# - box plot
ggplot(transectCOV, 
       aes(x = site_rep, y = dist_from_mean)) +
  geom_boxplot() +
  theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Transect ID", 
   y = "Distance from mean canopy height (cm)", 
       title = "Canopy height (cm) by transect")

# distance from mean canopy height x nn grass cover
ggplot(transectCOV, 
       aes(x = percentcover_nonnative, y = dist_from_mean)) +
  geom_point(aes(fill = standtype), colour = "black", size = 3, pch = 21) +
 # theme(axis.text.x.bottom = element_text(angle = 90)) +
labs(x = "Average non-native grass cover (%)", 
       y = "Distance from mean canopy height (cm)", 
       title = "Distance from mean canopy height (cm) by average non-native cover (%)")

```

```{r stats for COV, include=FALSE}

histogram(transectCOV$dist_from_mean)

shapiro.test(transectCOV$dist_from_mean)
# Shapiro-Wilk normality test
# 
# data:  transectCOV$dist_from_mean
# W = 0.98131, p-value = 4.462e-07 <-- not normally distributed

kruskal.test(dist_from_mean ~ site_rep, data = transectCOV)
# Kruskal-Wallis rank sum test
# 
# data:  dist_from_mean by site_rep
# Kruskal-Wallis chi-squared = 2.2501, df = 14, p-value = 0.9998 <-- no sig difference between transects

pairwise.wilcox.test(transectCOV$dist_from_mean, transectCOV$site_rep,
                 p.adjust.method = "BH")
# All values are equal to 1 because the mean is calculated from the raw values. SO - the cumulative "dist_to_mean" is going to be zero because that's how the mean is calculated - the mean is the centroid value of all raw data points. 
# So - analyze differences in transect height based on mean heights and SD... NOT COV since you have an N of 1.  
```




```{r COV - stand height by standtype, include=TRUE}
standheight_cov <- standheight_siterep_meanSD %>% # Intact n = 3, Matrix and Deg n = 6
  group_by(standtype, site_rep) %>% 
  dplyr::summarize(cov = sd/mean_height) %>% # COV = SD / mean
  print(standheight_cov)

# grouped by standtype
standheight_cov %>% 
  group_by(standtype) %>% 
  summarize(mean_cov = mean(cov),
            n = length((cov)),
            sd = sd(cov),
            se = ((sd(cov))/sqrt(length((cov)))))
#         mean_COV  N SD          SE
#Intact	  0.6187625	3	0.12556945	0.07249755 <-- larger number = more variation
#Matrix	  0.6668496	6	0.09217907	0.03763195 
#Degraded	0.3218140	6	0.11316173	0.04619808 <-- smaller number = less variation

shapiro.test(standheight_cov$cov)
# Shapiro-Wilk normality test
# data:  standheight_cov$cov
# W = 0.94294, p-value = 0.4207 <-- normally distributed

summary(aov((cov ~ standtype) , data = standheight_cov))
#            Df Sum Sq Mean Sq F value   Pr(>F)    
#standtype    2 0.3943  0.1971   17.14 0.000304 *** <-- cov is significantly different by standtype

TukeyHSD(aov((cov ~ standtype) , data = standheight_cov), conf.level=.95) 
#$standtype
#                       diff        lwr         upr     p adj
#Matrix-Intact    0.04808716 -0.1542489  0.25042324 0.8045742
#Degraded-Intact -0.29694845 -0.4992845 -0.09461236 0.0053826 <-- Deg and Int
#Degraded-Matrix -0.34503560 -0.5102423 -0.17982888 0.0003305 <-- Deg and Mat

# Degraded sites are significantly more homogeneous than the INT and MAT standtypes
```

### 1.3 Shrub density 

```{r  load data - shrub density, include=TRUE}
#1. Every variable is a column --> ARCA_dead
#2. Each observation is a row --> DEG_1
#3. Each cell contains a single value --> N


# native shrub density 
shrubdensitylife_full <- read_csv("deg_beltdensity_bylifestage.csv", 
    col_types = cols(
      StandType = col_character(), 
      Site = col_character(),
      rep = col_character(),
      ScientificName = col_character(), 
      dead = col_integer(),
      immature = col_integer(),
      mature = col_integer(), 
      resprout = col_integer(), 
      seedling = col_integer()
      )
     ) %>% 
  rename(standtype = StandType, 
         site = Site, 
         species = ScientificName) %>%
  mutate(standtype = case_when(standtype == "Grass" ~ "degraded", 
                               standtype == "matrix" ~ "matrix",
                               standtype == "Intact" ~ "intact")) %>% 
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded"))
  
glimpse(shrubdensitylife_full)

#dim(shrubdensitylife_full)
#head(shrubdensitylife_full)
#tail(shrubdensitylife_full)
specnumber(shrubdensitylife_full)

# convert dataframe to tibble
shrubdensitylife_full <- as_tibble(shrubdensitylife_full) 
class(shrubdensitylife_full) # now a tibble
# [1] "tbl_df"     "tbl"        "data.frame"

shrubdensitylife_transposed <- gather(shrubdensitylife_full, "status", "count", 5:9) # transpose data from wide to long format
glimpse(shrubdensitylife_transposed)

shrubdensity <- shrubdensitylife_transposed # 
shrubdensity$site_rep <- paste(shrubdensity$site, shrubdensity$rep, sep="_") # combine site and rep to one column
shrubdensity$site_rep_species <- paste(shrubdensity$site_rep, shrubdensity$species, sep="_") # combine site and rep to one column
head(shrubdensity) # look at new column site_rep, last column

shrubdensity %>% 
  group_by(site_rep, status) %>% 
  summarize(length_count = length(count)) %>% 
  print(shrubdensity_sum_bysiterep_meanSD)
# all site_rep have 5 status categories: dead, immature, mature, resprout, seedling 
# all status have 13 length_count --> 13 species per status
# take home = no missing data points

sort(unique(shrubdensity$site_rep))
sort(unique(shrubdensity$site_rep_species))
sort(unique(shrubdensity$species))

# write.csv(shrubdensity,"processed/shrubdensity.csv")

# shrubdensityspp_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_beltdensity_byspecies.csv")
# shrubdensityalive_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/deg_beltdensity_seperatealive.csv")

```

#### ALIVE shrub density

```{r alive shrub dentsity 1m2 and figure x nngrass, include=TRUE}

# ALIVE
shrubdensity_sum_bysiterep <- shrubdensity %>% # call tibble
  filter(status != "dead") %>% #omit dead shrubs
  group_by(standtype, site_rep) %>%  # lump immature, mature, resprout shrubs and seedlings
  summarize(aliveshrubdensity_80m2 = sum(count), 
            aliveshrubdensity_1m2 = aliveshrubdensity_80m2/80)  # 4m x 20 m belt transect
  print(shrubdensity_sum_bysiterep) 
```

```{r}

nativecover <- read.csv("processed/abcover_nativecover_nngrasscover.csv") # native percent cover from ch1_standdeg_canopy.Rmd
sort(unique(nativecover$site_rep))
# "DEG1_1"     "DEG1_2"     "DEG1_3"     "DEG2_4"     "DEG2_5"     "DEG2_6"     "ENH1_1"     "ENH1_2"     "ENH1_3"     "ENH2_4"     "ENH2_5"    
# "ENH2_6"     "Intact_1_1" "Intact_2_2" "Intact_3_3"
glimpse(nativecover)

nncover <- read.csv("processed/abcover_nonnativecover_nngrasscover.csv") # non-native percent cover from ch1_standdeg_canopy.Rmd
sort(unique(nncover$site_rep))
# "DEG1_1"     "DEG1_2"     "DEG1_3"     "DEG2_4"     "DEG2_5"     "DEG2_6"     "ENH1_1"     "ENH1_2"     "ENH1_3"     "ENH2_4"     "ENH2_5"    
# "ENH2_6"     "Intact_1_1" "Intact_2_2" "Intact_3_3"
glimpse(nncover)


shrubdensity_sum_bysiterep_nat <- shrubdensity_sum_bysiterep %>%
 left_join(nativecover, by = "site_rep") 
shrubdensity_sum_bysiterep_nat_nn <- shrubdensity_sum_bysiterep_nat %>% # join above ground species diversity with non-native transect percent cover
  left_join(nncover, by = "site_rep")
print(shrubdensity_sum_bysiterep_nat_nn)

shrubdensity_sum_bysiterep_regression <- ggplot(data = shrubdensity_sum_bysiterep_nat_nn, 
       aes(x = nonnative_grass*100, y = aliveshrubdensity_1m2, shape = standtype, color = standtype)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 3)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Shrub Density (#/m2)", 
       title = "Shrub density (per m2) x non-native grass cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(shrubdensity_sum_bysiterep_regression)
```


```{r alive shrub dentsity 1m2 - mean SD, include=TRUE}
shrubdensity_sum_bysiterep_meanSD <- shrubdensity_sum_bysiterep %>%
  group_by(standtype) %>%
  summarize(mean_aliveshrubdensity_1m2 = mean(aliveshrubdensity_1m2),
            n = length((aliveshrubdensity_1m2)),
            sd = sd(aliveshrubdensity_1m2),
            se = ((sd(aliveshrubdensity_1m2))/sqrt(length((aliveshrubdensity_1m2))))) %>% 
  print(shrubdensity_sum_bysiterep_meanSD)
#standtype    mean_aliveshrubdensity_1m2  n sd  se
#intact	      0.6375000	                  3	0.21323403	0.12311072
#matrix	      0.7750000	                  6	0.77245550	0.31535364
#degraded	    0.1895833	                  6	0.07600027	0.03102698

```

```{r alive shrub dentsity 1m2 - aov tukey, include=TRUE}

# ALIVE
summary(aov((aliveshrubdensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep))
#            Df Sum Sq Mean Sq F value Pr(>F)
#standtype    2  1.086  0.5430     2.1  0.165
#Residuals   12  3.103  0.2586 

TukeyHSD(aov((aliveshrubdensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep), conf.level=.95) 
#$standtype
#                      diff        lwr       upr     p adj
#matrix-intact    0.1375000 -0.8218272 1.0968272 0.9230712
#degraded-intact -0.4479167 -1.4072439 0.5114105 0.4505607
#degraded-matrix -0.5854167 -1.3687040 0.1978707 0.1560871

```

```{r alive shrub dentsity 1m2 - figures - tables, include=TRUE}

shrubdensity_sum_bysiterep_aov_1m2_column <- ggplot(shrubdensity_sum_bysiterep_meanSD, aes(x = standtype, y = mean_aliveshrubdensity_1m2, fill = standtype)) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(
    aes(ymin=mean_aliveshrubdensity_1m2-se, ymax=mean_aliveshrubdensity_1m2+se), 
                width=.2, position=position_dodge(.9)) +
  labs(
    title = "Alive shrub density by stand type", 
    x = "Stand Type", 
    y = "Average alive shrub density (#/m2)") + # title, axes titles
  scale_fill_manual(values = c(standcolors)) + # manual colors
  # scale_fill_manual(values = cal_palette('chaparral2')) +  # continuous colors
  #                  limits = c("intact", "matrix", "degraded"), # "limits" reorders the x-axis
  #                  labels = c("Intact", "Matrix", "Degraded")) + # "labels" changes the name
  theme_bw()
shrubdensity_sum_bysiterep_aov_1m2_column

# table: standtype, species, lifestage
shrubdensity_table <- shrubdensity %>%
  mutate(status = case_when(status == "resprout" ~ "immature", 
                            TRUE ~ status)) %>% 
  mutate(status = fct_relevel(status, "mature", "immature", "seedling", "dead")) %>% 
  group_by(standtype, species, status) %>%
   rename(lifestage = status) %>% 
  summarize(N = sum(count)) %>%
  print(shrubdensity_table) 

shrubdensity_table_spread <- shrubdensity_table %>%  
  spread(key = lifestage, value = N) %>% 
  print(shrubdensity_table_spread)

#write.csv(shrubdensity_table_spread,"processed/shrubdensity_table_spread.csv")

shrubdensity_table_spread %>% 
  group_by(standtype) %>% 
  summarize(sum_mature = sum(mature), 
            sum_immature = sum(immature), 
            sum_seedling = sum(seedling), 
            sum_dead = sum(dead))
#standtype sum_mature sum_immature sum_seedlingsum_dead
#intact	  101	    45	  7	    22
#matrix	  297	    70	  5	    256
#degraded	72	    16	  3	    0
```

#### MATURE shrub density

```{r mature shrub density - mean SD, include=TRUE}

# MATURE 
shrubdensity_sum_bysiterep_mature <- shrubdensity %>%
  filter(status == "mature") %>% #select only mature shrubs
  group_by(standtype, site_rep) %>%  
  summarize(matureshrubdensity_80m2 = sum(count), 
            matureshrubdensity_1m2 = matureshrubdensity_80m2/80) # 4m x 20 m belt transect
  print(shrubdensity_sum_bysiterep_mature) 

shrubdensity_sum_bysiterep_mature_meanSD <- shrubdensity_sum_bysiterep_mature %>%
  group_by(standtype) %>%
  summarize(mean_matureshrubdensity_1m2 = mean(matureshrubdensity_1m2),
            n = length((matureshrubdensity_1m2)),
            sd = sd(matureshrubdensity_1m2),
            se = ((sd(matureshrubdensity_1m2))/sqrt(length((matureshrubdensity_1m2))))) %>% 
  print(shrubdensity_sum_bysiterep_mature_meanSD)
#standtype    mean_matureshrubdensity_1m2  n sd  se
#intact	      0.4208333	                  3	0.22511571	0.12997062
#matrix	      0.6187500	                  6	0.52361424	0.21376462
#degraded	    0.1500000	                  6	0.06072479	0.02479079

```

```{r mature shrub density - aov tukey, include=TRUE}

# MATURE 
summary(aov((matureshrubdensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep_mature))
#            Df Sum Sq Mean Sq F value Pr(>F)
#standtype    2 0.6624  0.3312   2.666   0.11
#Residuals   12 1.4907  0.1242  

TukeyHSD(aov((matureshrubdensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep_mature), conf.level=.95) 
#$standtype
#                      diff        lwr        upr     p adj
#matrix-intact    0.1979167 -0.4669675 0.86280085 0.7135344
#degraded-intact -0.2708333 -0.9357175 0.39405085 0.5397636
#degraded-matrix -0.4687500 -1.0116257 0.07412566 0.0937921
```

#### IMMATURE shrub density

```{r immature shrub density, include=TRUE}

shrubdensity_sum_bysiterep_immature <- shrubdensity %>%
  filter(status == "immature") %>% #select only mature shrubs
  group_by(standtype, site_rep) %>%  
  summarize(immatureshrubdensity_80m2 = sum(count), 
            immatureshrubdensity_1m2 = immatureshrubdensity_80m2/80)  # 4m x 20 m belt transect
  print(shrubdensity_sum_bysiterep_immature) 

shrubdensity_sum_bysiterep_immature_meanSD <- shrubdensity_sum_bysiterep_immature %>%
  group_by(standtype) %>%
  summarize(mean_immatureshrubdensity_1m2 = mean(immatureshrubdensity_1m2),
            n = length((immatureshrubdensity_1m2)),
            sd = sd(immatureshrubdensity_1m2),
            se = ((sd(immatureshrubdensity_1m2))/sqrt(length((immatureshrubdensity_1m2))))) %>% 
  print(shrubdensity_sum_bysiterep_immature_meanSD)
#standtype  mean      n sd  se
#intact	    0.1833333	3	0.02886751	0.016666667
#matrix	    0.1395833	6	0.22184125	0.090566312
#degraded	  0.0312500	6	0.02200852	0.008984941

summary(aov((immatureshrubdensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep_immature))
#Df  Sum Sq Mean Sq F value Pr(>F)
#standtype    2 0.05822 0.02911   1.396  0.285
#Residuals   12 0.25016 0.02085  

```
#### SEEDLING shrub density

```{r immature shrub density, include=TRUE}

shrubdensity_sum_bysiterep_seedling <- shrubdensity %>%
  filter(status == "seedling") %>% #select only mature shrubs
  group_by(standtype, site_rep) %>%  
  summarize(seedlingdensity_80m2 = sum(count), 
            seedlingdensity_1m2 = seedlingdensity_80m2/80)  # 4m x 20 m belt transect
  print(shrubdensity_sum_bysiterep_seedling) 

shrubdensity_sum_bysiterep_seedling_meanSD <- shrubdensity_sum_bysiterep_seedling %>%
  group_by(standtype) %>%
  summarize(mean_seedlingdensity_1m2 = mean(seedlingdensity_1m2),
            n = length((seedlingdensity_1m2)),
            sd = sd(seedlingdensity_1m2),
            se = ((sd(seedlingdensity_1m2))/sqrt(length((seedlingdensity_1m2))))) %>% 
  print(shrubdensity_sum_bysiterep_seedling_meanSD)
#standtype  mean      n sd  se
#intact	    0.02916667	3	0.04018188	0.023199018
#matrix	    0.01041667	6	0.01461306	0.005965759
#degraded	  0.00625000	6	0.01530931	0.00625000

summary(aov((seedlingdensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep_seedling))
#Df  Sum Sq Mean Sq F value Pr(>F)
#standtype    2 0.001094 0.0005469     1.2  0.335
#Residuals   12 0.005469 0.0004557   

```
#### RESPROUT shrub density
```{r resprout density, include=TRUE}

shrubdensity_sum_bysiterep_respt <- shrubdensity %>%
  filter(status == "resprout") %>% #select only mature shrubs
  group_by(standtype, site_rep) %>%  
  summarize(resptdensity_80m2 = sum(count), 
            resptdensity_1m2 = resptdensity_80m2/80) # 4m x 20 m belt transect
  print(shrubdensity_sum_bysiterep_respt) 

shrubdensity_sum_bysiterep_respt_meanSD <- shrubdensity_sum_bysiterep_respt %>%
  group_by(standtype) %>%
  summarize(mean_resptdensity_1m2 = mean(resptdensity_1m2),
            n = length((resptdensity_1m2)),
            sd = sd(resptdensity_1m2),
            se = ((sd(resptdensity_1m2))/sqrt(length((resptdensity_1m2))))) %>% 
  print(shrubdensity_sum_bysiterep_respt_meanSD)
#standtype  mean        n sd  se
#intact	    0.004166667	3	0.007216878	0.004166667
#matrix	    0.006250000	6	0.015309311	0.006250000
#degraded	  0.002083333	6	0.005103104	0.002083333

summary(aov((resptdensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep_respt))
#Df  Sum Sq Mean Sq F value Pr(>F)
#standtype    2 0.0000521 2.604e-05   0.222  0.804
#Residuals   12 0.0014063 1.172e-04 
```

#### DEAD shrub density
```{r dead shrub density, include=TRUE}

shrubdensity_sum_bysiterep_dead <- shrubdensity %>%
  filter(status == "dead") %>% #select only mature shrubs
  group_by(standtype, site_rep) %>%  
  summarize(deaddensity_80m2 = sum(count), 
            deaddensity_1m2 = deaddensity_80m2/80) %>% # 4m x 20 m belt transect
  print(shrubdensity_sum_bysiterep_dead) 

shrubdensity_sum_bysiterep_dead_meanSD <- shrubdensity_sum_bysiterep_dead %>%
  group_by(standtype) %>%
  summarize(mean_deaddensity_1m2 = mean(deaddensity_1m2),
            n = length((deaddensity_1m2)),
            sd = sd(deaddensity_1m2),
            se = ((sd(deaddensity_1m2))/sqrt(length((deaddensity_1m2))))) %>% 
  print(shrubdensity_sum_bysiterep_dead_meanSD)
#standtype  mean      n sd  se
#intact	0.09166667	3	0.1371207	0.07916667
#matrix	0.53333333	6	1.2698097	0.51839764
#degraded	0.00000000	6	0.0000000	0.00000000

summary(aov((deaddensity_1m2 ~ standtype) , data = shrubdensity_sum_bysiterep_dead))
#Df  Sum Sq Mean Sq F value Pr(>F)
#standtype    2  0.927  0.4634   0.687  0.522
#Residuals   12  8.100  0.6750  
```

# END 

##Density Segmented
```{r shrub density}
abcover_nativecover_nngrasscover[1:3,2] <- c("Intact1_1", "Intact2_2", "Intact3_3")

shrubdensity_sum_bysiterep_all <- shrubdensity_sum_bysiterep %>% 
  left_join(shrubdensity_sum_bysiterep_seedling, by = c("site_rep", "standtype")) %>%
  left_join(shrubdensity_sum_bysiterep_immature, by = c("site_rep", "standtype")) %>%
  left_join(shrubdensity_sum_bysiterep_mature, by = c("site_rep", "standtype")) %>%
  left_join(shrubdensity_sum_bysiterep_respt, by = c("site_rep", "standtype")) %>%
  left_join(abcover_nativecover_nngrasscover, by = c("site_rep")) %>%
  dplyr::select("site_rep", "aliveshrubdensity_1m2", "seedlingdensity_1m2", "immatureshrubdensity_1m2", "matureshrubdensity_1m2", "resptdensity_1m2", "nonnative_grass", "native_shrub")

shrub_density <- ggplot(data = shrubdensity_sum_bysiterep_all, aes(x = site_rep)) +
  geom_point(aes(y = aliveshrubdensity_1m2, color = "alive")) +
  geom_point(aes(y = seedlingdensity_1m2, color = "seedling")) +
  geom_point(aes(y = immatureshrubdensity_1m2, color = "immature")) +
  geom_point(aes(y = matureshrubdensity_1m2, color = "mature")) +
  geom_point(aes(y = resptdensity_1m2, color = "resprout")) +
  scale_color_manual(values = c("red3", "yellow3", "green3", "blue3", "purple3"))

shrub_density1 <- ggplot(data = shrubdensity_sum_bysiterep_all, aes(x = nonnative_grass)) +
  geom_point(aes(y = aliveshrubdensity_1m2, color = "alive")) +
  geom_point(aes(y = seedlingdensity_1m2, color = "seedling")) +
  geom_point(aes(y = immatureshrubdensity_1m2, color = "immature")) +
  geom_point(aes(y = matureshrubdensity_1m2, color = "mature")) +
  geom_point(aes(y = resptdensity_1m2, color = "resprout")) +
  scale_color_manual(values = c("red3", "yellow3", "green3", "blue3", "purple3"))
shrub_density1

shrub_density2 <- ggplot(data = shrubdensity_sum_bysiterep_all, aes(x = native_shrub)) +
  geom_point(aes(y = aliveshrubdensity_1m2, color = "alive")) +
  geom_point(aes(y = seedlingdensity_1m2, color = "seedling")) +
  geom_point(aes(y = immatureshrubdensity_1m2, color = "immature")) +
  geom_point(aes(y = matureshrubdensity_1m2, color = "mature")) +
  geom_point(aes(y = resptdensity_1m2, color = "resprout")) +
  scale_color_manual(values = c("red3", "yellow3", "green3", "blue3", "purple3"))
shrub_density2

ggplotly(shrub_density)
```


```{r above ground - species richness - native richness, include = FALSE}

### SPECIES RICHNESS DATA IS IN CH1_DEGRADATION_ABCOVERNMDS.RMD FILE ###






# species richness, native richness
abrich_full <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_abrich.csv", header = TRUE, na.strings=c("","NA")) %>% 
  dplyr::select('trasecttype', 'standtype', 'site', 'rep', 'distance', 'vertical', 'species', 'lifeform', 'status', 'lifecycle', 'Family', 'lifestage') %>% 
  rename(transecttype = trasecttype, 
         family = Family)
glimpse(abrich_full)

# native shrub density 
shrubdensitylife_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_beltdensity_bylifestage.csv", 
    col_types = cols(
      StandType = col_character(), 
      Site = col_character(),
      rep = col_integer(),
      ScientificName = col_character(), 
      dead = col_integer(),
      immature = col_integer(),
      mature = col_integer(), 
      resprout = col_integer(), 
      seedling = col_integer()
      )
     ) %>% 
  rename()
  


shrubdensityspp_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_beltdensity_byspecies.csv")
# shrubdensityalive_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/deg_beltdensity_seperatealive.csv")

```
