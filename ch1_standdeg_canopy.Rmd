---
title: "ch1_standdeg_canopy"
author: "Stephanie Ma Lucero"
date: "2023-07-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r install libraries, message=FALSE}

library(here) # similar to set working directory
library(tidyverse) # data wrangling - includes ggplot2, dplyr, tidyr, readr, purr, tibble, stringr, forcats
# library(lubridate) # dates and times
library(ggplot2) # data visualization
# library(readr)
library(dplyr)
library(ggthemes)
library(plotly)
library(ggpubr) # customize ggplot2 for publication
#library(broom)
#library(AICcmodavg)
library(vegan) #community ecology package - includes, MASS, cluster, mgcv
library(readxl) # for .xls and .xlsx sheets
#library(janitor)
library(multcompView) #Visualizations of Paired Comparisons, functions: TukeyHSD, dist{stats}, simint, simtest, csimint, csimtest{multcomp}, friedmanmc, kruskalmc{pgirmess}
#library(multcomp) # functions: multcompLetters2, multcompLetters3, multcompLetters4 using aov object

```

```{r install colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Stand colors: INTACT, MATRIX, DEGRADED 
cal_palette(name = "chaparral3", n = 3, type = "continuous") 
deg <- "#D3E3CA"
mat <- "#92A587"
int <- "#2F3525"
standcolors <- c(int, mat, deg)

# Lifeform colors: shrub, grass, forb
cal_palette(name = "chaparral3", n = 3, type = "continuous") 
shrub <- "#D3E3CA"
grass <- "#92A587"
forb <- "#2F3525"
lifeformcolors <- c(int, mat, deg)

# Status colors: native, exotic 
cal_palette(name = "chaparral1", n = 6, type = "continuous") 
native <- "#AEBFA8"
exotic <- "#F19B34"
statuscolors <- c(native, exotic)

```

# 1. How does physical structure differ among the stands?

### 1.1 Percent cover by stand (horizontal variation)

```{r load csv, create columns, calculate - percent cover, echo=FALSE, eval=F}

# percent cover - belt transects, point intercept transects
abcover_full <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_percentcover_byspecies_bylifeform.csv", header = TRUE, na.strings=c("","NA")) %>% 
  rename(speciescode = species.1 ) %>%
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded")) %>% 
  dplyr::select(!speciescode)
glimpse(abcover_full)
str(abcover_full)

#abcover_full$standtype <- factor(abcover_full$standtype, levels = c("intact", "matrix", "degraded"))

# convert dataframe to tibble
abcover_full_v <- as_tibble(abcover_full) 
class(abcover_full_v)

# combine site and rep to one column
abcover_full_v$site_rep <- paste(abcover_full_v$site, abcover_full_v$rep, sep="_") 

# combine site_rep and distance to one column
abcover_full_v$site_rep_dist <- paste(abcover_full_v$site_rep, abcover_full_v$distance, sep="_") 

# combine standtype and native/nonnative status to one column
abcover_full_v$stand_status <- paste(abcover_full_v$standtype, abcover_full_v$status, sep="_") 

view(abcover_full_v) # look at new columns

abcover_full_v %>%  
  na.omit() %>%  
  group_by(standtype, rep) %>% 
  summarize(data_points = length(rep))

# omit "ground" as a status since interested in Native and Non-native species 
abcover_full_v_omitground <- filter(abcover_full_v, status !="ground")
glimpse(abcover_full_v_omitground)
```

##### (A) by cover type - OMIT 
```{r calculate veg/ground cover, include = TRUE}
abcover_vegcover <- abcover_full_v %>% 
  filter(vertical == "1") %>% 
  group_by(standtype, site, rep) %>% 
  dplyr::summarize(count_per_transect = length(vertical), 
    percentcover_veg = length(vertical)/41, 
    percentcover_ground = (1-percentcover_veg)
    )
print(abcover_vegcover)

abcover_vegcover_long <- gather(abcover_vegcover, covertype, percentcover, percentcover_veg:percentcover_ground, factor_key = TRUE) 
abcover_vegcover_long

abcover_vegcover_meanSD <- abcover_vegcover_long %>%
  group_by(standtype, covertype) %>% 
  summarize(mean_cover = mean(percentcover),
            n = length((percentcover)),
            sd = sd(percentcover),
            se = ((sd(percentcover))/sqrt(length((percentcover)))))
print(abcover_vegcover_meanSD)
```
```{r aov veg/ground cover, include=TRUE}
summary(aov(percentcover_veg ~ standtype, data = abcover_vegcover))
TukeyHSD(aov(percentcover_veg ~ standtype, data = abcover_vegcover))
#$standtype
#                         diff         lwr        upr p adj
#matrix-intact    5.551115e-17 -0.02981350 0.02981350     1
#degraded-intact -5.551115e-17 -0.02981350 0.02981350     1
#degraded-matrix -1.110223e-16 -0.02434262 0.02434262     1

summary(aov(percentcover ~ standtype * covertype, data = abcover_vegcover_long))
TukeyHSD((aov(percentcover ~ standtype * covertype, data = abcover_vegcover_long)))
#$`standtype:covertype`
#                                                                diff         lwr         upr     p adj
#matrix:percentcover_veg-intact:percentcover_veg          0.008130081 -0.04407217  0.06033233 0.9963927 <-- max - int veg
#degraded:percentcover_veg-intact:percentcover_veg        0.028455285 -0.02374697  0.08065754 0.5537578 <-- deg - int veg
#intact:percentcover_ground-intact:percentcover_veg      -0.934959350 -0.99523732 -0.87468138 0.0000000
#matrix:percentcover_ground-intact:percentcover_veg      -0.943089431 -0.99529168 -0.89088718 0.0000000
#degraded:percentcover_ground-intact:percentcover_veg    -0.963414634 -1.01561689 -0.91121238 0.0000000
#degraded:percentcover_veg-matrix:percentcover_veg        0.020325203 -0.02229776  0.06294816 0.6828902 <-- deg - mat veg
#intact:percentcover_ground-matrix:percentcover_veg      -0.943089431 -0.99529168 -0.89088718 0.0000000
#matrix:percentcover_ground-matrix:percentcover_veg      -0.951219512 -0.99384247 -0.90859655 0.0000000
#degraded:percentcover_ground-matrix:percentcover_veg    -0.971544715 -1.01416768 -0.92892175 0.0000000
#intact:percentcover_ground-degraded:percentcover_veg    -0.963414634 -1.01561689 -0.91121238 0.0000000
#matrix:percentcover_ground-degraded:percentcover_veg    -0.971544715 -1.01416768 -0.92892175 0.0000000
#degraded:percentcover_ground-degraded:percentcover_veg  -0.991869919 -1.03449288 -0.94924696 0.0000000
#matrix:percentcover_ground-intact:percentcover_ground   -0.008130081 -0.06033233  0.04407217 0.9963927 <-- mat - int grd
#degraded:percentcover_ground-intact:percentcover_ground -0.028455285 -0.08065754  0.02374697 0.5537578 <-- deg - int grd
#degraded:percentcover_ground-matrix:percentcover_ground -0.020325203 -0.06294816  0.02229776 0.6828902 <-- deg - mat grd

# no significant difference in ground cover or in vegetation cover
```
```{r plot veg/ground cover, include=TRUE}
#  column plot

abcover_vegcover_plot <- ggplot(abcover_vegcover_meanSD, aes(x = standtype, y = mean, fill = status)) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) +
               labs(title = "Percent Cover", x = "Stand Type", y = "Average Percent Cover (%)") + # title, axes titles
 # scale_fill_manual(values = c('#D3E3CA', '#92A587', '#2F3525'), # manual colors
   scale_fill_manual(values = cal_palette('chaparral2')) +  # continuous colors
  #                  limits = c("intact", "matrix", "degraded"), # "limits" reorders the x-axis
  #                  labels = c("Intact", "Matrix", "Degraded")) + # "labels" changes the name
                    theme_bw() +
  scale_x_discrete(limits=c("intact", "matrix", "degraded"),
                                         labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded"))

print(abcover_bystatus_plot)  
```



##### (B) Percent cover by lifeform by native/nonnative status 

```{r cover x status x lifeform, include = TRUE}
# line 933 from Ch1_Degradation_original.Rmd

# data prep
abcover_bylf_bystatus <- abcover_full_v_omitground %>% 
  group_by(standtype, lifeform, status, site, rep, site_rep) %>% 
  dplyr::summarize(
    count_per_transect = n_distinct(site_rep_dist), 
    percentcover = n_distinct(site_rep_dist)/41
    )
view(abcover_bylf_bystatus) # prints to new tab

write.csv(abcover_bylf_bystatus,"processed/percentcover_bystatus_bylifeform.csv")

# normality
# anova - what results do I want to report?

# calculate means and SD 
abcover_bylf_bystatus_meanSD <- abcover_bylf_bystatus %>%
  group_by(standtype, status, lifeform) %>%
#  group_by(standtype = "intact", lifeform, status) %>%
#  group_by(standtype = "matrix", lifeform, status) %>%
# group_by(standtype = "degraded", lifeform, status) %>%
  summarize(mean_cover = mean(percentcover),
            SD = sd(percentcover),
            N = length(percentcover), 
            SE = ((sd(percentcover))/sqrt(length((percentcover)))))
print(abcover_bylf_bystatus_meanSD)

abcover_bylf_bystatus_meanSD$status_lifeform <- paste(abcover_bylf_bystatus_meanSD$status, abcover_bylf_bystatus_meanSD$lifeform, sep="_") # combine status and life form to one column
 
view(abcover_bylf_bystatus_meanSD)
```

```{r plot abcover_bylf_meanSD, include = TRUE}
# line 965 in Ch1_Degradation_original.Rmd

#  column plot, 2 x 2 by lifeform
abcover_bylf_bystatus_meanSD_plot_wrap <- ggplot(abcover_bylf_bystatus_meanSD, aes(x = standtype, y = mean_cover, fill = status )) +
  facet_wrap(~ lifeform) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(aes(ymin=mean_cover-SD, ymax=mean_cover+SD), width=.2,
                 position=position_dodge(.9)) +
  labs(title = "Percent Cover by lifeform", x = "Stand Type", y = "Average Percent Cover") +
  scale_fill_manual(values = c(statuscolors)) + # manual colors
#   scale_fill_manual(values = cal_palette('chaparral3')) + # continuous colors
                       theme_bw()
abcover_bylf_bystatus_meanSD_plot_wrap + scale_x_discrete(limits=c("intact", "matrix", "degraded"),
                                         labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded"))


#  column plot, 2 x 2 by lifeform
abcover_bylf_bystatus_meanSD_plot_wrap <- ggplot(abcover_bylf_bystatus_meanSD, aes(x = standtype, y = mean, fill = status )) +
  facet_wrap(~ lifeform) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) +
  labs(title = "Percent Cover by status and lifeform", x = "Stand Type", y = "Average Percent Cover") +
  scale_fill_manual(values = c('#D3E3CA', '#92A587', '#2F3525')) + # manual colors
#   scale_fill_manual(values = cal_palette('chaparral3')) + # continuous colors
                       theme_bw()
abcover_bylf_bystatus_meanSD_plot_wrap + scale_x_discrete(limits=c("intact", "matrix", "degraded"),
                                         labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded"))
```




```{r}
# species richness, native richness
abrich_full <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_abrich.csv", header = TRUE, na.strings=c("","NA")) %>% 
  dplyr::select('trasecttype', 'standtype', 'site', 'rep', 'distance', 'vertical', 'species', 'lifeform', 'status', 'lifecycle', 'Family', 'lifestage') %>% 
  rename(transecttype = trasecttype, 
         family = Family)
glimpse(abrich_full)

# native shrub density 
shrubdensitylife_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_beltdensity_bylifestage.csv", 
    col_types = cols(
      StandType = col_character(), 
      Site = col_character(),
      rep = col_integer(),
      ScientificName = col_character(), 
      dead = col_integer(),
      immature = col_integer(),
      mature = col_integer(), 
      resprout = col_integer(), 
      seedling = col_integer()
      )
     ) %>% 
  rename()
  


shrubdensityspp_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_beltdensity_byspecies.csv")
# shrubdensityalive_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/deg_beltdensity_seperatealive.csv")

# stand height 
standheight_full <- read_csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/deg_maxheight.csv")
```
