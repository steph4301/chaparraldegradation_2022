---
title: "ch1_standdeg_canopy"
author: "Stephanie Ma Lucero"
date: "2023-07-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE}

library(here) # similar to set working directory
library(tidyverse) # data wrangling - includes ggplot2, dplyr, tidyr, readr, purr, tibble, stringr, forcats
# library(lubridate) # dates and times
library(ggplot2) # data visualization
library(gridExtra)
# library(readr)
library(dplyr)
library(ggthemes)
library(plotly)
library(ggpubr) # customize ggplot2 for publication
#library(broom)
#library(AICcmodavg)
library(vegan) #community ecology package - includes, MASS, cluster, mgcv
library(readxl) # for .xls and .xlsx sheets
#library(janitor)
library(multcompView) #Visualizations of Paired Comparisons, functions: TukeyHSD, dist{stats}, simint, simtest, csimint, csimtest{multcomp}, friedmanmc, kruskalmc{pgirmess}
#library(multcomp) # functions: multcompLetters2, multcompLetters3, multcompLetters4 using aov object
#library(DHARMa) #The ‘DHARMa’ package uses a simulation-based approach to create readily interpretable scaled (quantile) residuals for fitted (generalized) linear mixed models.
#citation("DHARMa")
library(ggpmisc)
library(segmented)
library(strucchange)
```

```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# all palettes
names(cal_palettes)

# Stand colors: INTACT, MATRIX, DEGRADED 
cal_palette(name = "chaparral3", n = 3, type = "continuous") 
#deg <- "#D3E3CA"
#mat <- "#92A587"
#int <- "#2F3525"
deg <- "gray60"
mat <- "gray40"
int <- "gray20"
line <- "red"
degshape <- 16
matshape <- 17
intshape <- 18


standcolors <- c(int, mat, deg)
standcolors_line <- c(line, int, mat, deg)
standshape <- c(intshape, matshape, degshape)

# Lifeform colors: shrub, grass, forb
cal_palette(name = "chaparral3", n = 3, type = "continuous") 
shrub <- "green4"
grass <- "yellow2"
forb <- "purple2"
lifeformcolors <- c(int, mat, deg)

# Status colors: native, exotic 
cal_palette(name = "chaparral1", n = 6, type = "continuous") 
native <- "gray50"
exotic <- "gray0"
statuscolors <- c(native, exotic)

```

```{r load csv, create columns, calculate - percent cover, echo=FALSE, eval=F}

# percent cover - belt transects, point intercept transects
abcover_full <- read.csv("deg_percentcover_byspecies_bylifeform.csv", header = TRUE, na.strings=c("","NA")) %>% 
  rename(speciescode = species.1 ) %>%
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded")) %>% 
  dplyr::select(!speciescode) %>% 
    mutate(site = case_when(site == "Intact_1" ~ "INT1", 
                                site == "Intact_2" ~ "INT2",
                                site == "Intact_3" ~ "INT3", 
          TRUE ~ site))

glimpse(abcover_full)
str(abcover_full)

#abcover_full$standtype <- factor(abcover_full$standtype, levels = c("intact", "matrix", "degraded"))

# convert dataframe to tibble
abcover_full_v <- as_tibble(abcover_full) 
class(abcover_full_v)

# combine site and rep to one column
abcover_full_v$site_rep <- paste(abcover_full_v$site, abcover_full_v$rep, sep="_") 

# combine site_rep and distance to one column
abcover_full_v$site_rep_dist <- paste(abcover_full_v$site_rep, abcover_full_v$distance, sep="_") 

# combine standtype and native/nonnative status to one column
abcover_full_v$stand_status <- paste(abcover_full_v$standtype, abcover_full_v$status, sep="_") 

abcover_full_v <- abcover_full_v %>% 
  mutate(site_rep = fct_relevel
         (site_rep, 
                                "INT1_1", "INT2_2", "INT3_3", "ENH1_1", "ENH1_2",    "ENH1_3"  ,   "ENH2_4"  ,   "ENH2_5"    , "ENH2_6"  , "DEG1_1"   ,  "DEG1_2"  ,   "DEG1_3"     ,"DEG2_4" ,    "DEG2_5"    , "DEG2_6" ))

glimpse(abcover_full_v) # look at new columns

sort(unique(abcover_full_v$species))

abcover_full_v %>%  
  na.omit() %>%  
  group_by(standtype, rep) %>% 
  summarize(data_points = length(rep))

# omit "ground" as a status since interested in Native and Non-native species 
abcover_full_v_omitground <- filter(abcover_full_v, status !="ground")
glimpse(abcover_full_v_omitground)
```

# VEG COVER

-   Percent cover (horizontal variation)

```{r percent cover - abcover_vegcover, include = TRUE}
abcover_vegcover <- abcover_full_v %>% # total above veg
  filter(vertical == "1") %>% 
  group_by(standtype, site, rep) %>% 
  dplyr::summarize(count_per_transect = length(vertical), 
    percentcover_veg = length(vertical)/41, 
    percentcover_ground = (1-percentcover_veg)
    )
print(abcover_vegcover)

abcover_vegcover_long <- gather(abcover_vegcover, covertype, percentcover, percentcover_veg:percentcover_ground, factor_key = TRUE) 
abcover_vegcover_long
```

### TOTAL VEG COVER

-   \% vegetation cover per transect
-   \% bare ground cover per transect

```{r FIGURES totalvegcover, include=TRUE}

# 1) visualizing data - highlight all and run
hist(abcover_vegcover_long$percentcover) # histogram
ggplot(data = abcover_vegcover_long, aes(y = percentcover, x = site, fill = covertype)) +
    geom_boxplot() # boxplots
ggplot(data = abcover_vegcover_long, aes(y = percentcover, x = site, color = covertype)) + 
  geom_jitter()

# 2) visualize boxplots
ggplot(data = abcover_vegcover_long, aes(y = percentcover, x = site, fill = covertype))+
  geom_boxplot()+
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0, 1))+
  xlab("Site")+
  ylab("Canopy cover (%)") +
 # scale_x_discrete(labels = c("intact" = "Intact", "matrix" = "Matrix",
 #                             "degraded" = "Degraded"))+
  theme_bw()+
  theme(text = element_text(size = 14), axis.text.y = element_text(size = 12), axis.text.x = element_text(size = 12))

# 3) jitter code
ggplot(data = abcover_vegcover_long, aes(x = site, y = percentcover, color = covertype))+ #start with the raw data
  #geom_jitter(width = 0.05, alpha = 0.25, pch=ifelse(grepl("c_", prop2mdata$stim), 17,19), cex=2.5)+ #use geom_jitter to add raw data points
  #geom_point(d = plotnewdata, aes(x = stim, y = stim.mean.prop2m), shape = rep(c(17,19),2), cex = 4)+ #now use geom_point to add the model estimate means
  #geom_linerange(d = plotnewdata, aes(x=stim,ymin=lse,ymax=use),size=1.5,position=position_dodge(width=0.25)) + #and geom_linerange to add the standard errors
  #things below this line just make it look pretty
  geom_jitter()+
  geom_point()+
  scale_y_continuous(breaks = seq(0,1,0.2), limits = c(0, 1.))+
  xlab("Stimulus")+
  ylab("Proportion approaching stimulus")+
  scale_x_discrete(labels = c("c_scents" = "Control Scents", "t_scents" = "Rival Scents",
                              "c_intruders" = "Control Intruders", "t_intruders" = "Rival Intruders"))+
  theme_bw()+
  theme(text = element_text(size = 14), axis.text.y = element_text(size = 12), axis.text.x = element_text(size = 12))
# end jitter code
```

```{r normality abcover total veg cover, include=TRUE}
shapiro.test(abcover_vegcover_long$percentcover) # veg cover and ground cover
# Shapiro-Wilk normality test
# data:  abcover_vegcover_long$percentcover
# W = 0.67222, p-value = 6.305e-07 <-- not normally distributed...

abcover_vegcover_long$site_rep <- paste(abcover_vegcover_long$site, abcover_vegcover_long$rep, sep="_") # combine site and rep form to one column

# total veg cover only
abcover_vegcover_long_vegonly <- abcover_vegcover_long %>% 
  filter(covertype == "percentcover_veg")

#testing for normality of veg cover only
shapiro.test(abcover_vegcover_long_vegonly$percentcover)
# 	Shapiro-Wilk normality test
# 
# data:  abcover_vegcover_long_vegonly$percentcover
# W = 0.73103, p-value = 0.0005447 <-- not normally distributed

ggqqplot(abcover_vegcover_long_vegonly$percentcover) 

abcover_vegcover_long_vegonly$site_rep <- paste(abcover_vegcover_long_vegonly$site, abcover_vegcover_long_vegonly$rep, sep="_") # combine site and rep form to one column

# code from --> http://www.sthda.com/english/wiki/kruskal-wallis-test-in-r
kruskal.test(percentcover ~ standtype, data = abcover_vegcover_long_vegonly)
# 	Kruskal-Wallis rank sum test
# 
# data:  percentcover by standtype
# Kruskal-Wallis chi-squared = 3.0521, df = 2, p-value = 0.2174 <-- not significantly different

pairwise.wilcox.test(abcover_vegcover_long_vegonly$percentcover, abcover_vegcover_long_vegonly$standtype,
                 p.adjust.method = "BH")
#          intact matrix
# matrix   0.78   -     
# degraded 0.32   0.32  <-- nothing is significant

```

```{r mean sd of abcover by site, include=TRUE}
# min / max percent cover of veg only
min(abcover_vegcover_long_vegonly$percentcover)*100 # 92.68%
max(abcover_vegcover_long_vegonly$percentcover)*100 # 100%

# mean SD by stand type
abcover_vegcover_meanSD <- abcover_vegcover_long_vegonly %>%
  group_by(standtype) %>% # by site
  summarize(mean_cover = mean(percentcover),
            n = length((percentcover)),
            sd = sd(percentcover),
            se = ((sd(percentcover))/sqrt(length((percentcover)))))
print(abcover_vegcover_meanSD)
# standtype mean_cover  n   sd            se
# intact	  0.9674797   3	  0.028163428	  0.016260163
# matrix	  0.9756098	  6	  0.030851489	  0.012595068
# degraded	0.9959350	  6	  0.009957275	  0.004065041

```

```{r bar plot totalvegcover, include=TRUE}

# combine standtype and native/nonnative status to one column
abcover_vegcover$site_rep <- paste(abcover_vegcover$site, abcover_vegcover$rep, sep="_") 

#  column plot - by site_rep
abcover_vegcover_plot_2 <- ggplot(abcover_vegcover, aes(x = site_rep, y = percentcover_veg, fill = standtype)) +
  geom_col(position = "dodge", width = 0.8) +
  labs(
    title = "Total Vegetation Cover", 
    x = "Site", 
    y = "Percent Vegetation Cover (%)") + # title, axes titles
  scale_fill_manual(values = c(standcolors)) + # manual colors
  # scale_fill_manual(values = cal_palette('chaparral2')) +  # continuous colors
  #                  limits = c("intact", "matrix", "degraded"), # "limits" reorders the x-axis
  #                  labels = c("Intact", "Matrix", "Degraded")) + # "labels" changes the name
  theme_bw() #+
 # scale_x_discrete(
 #   limits=c("intact", "matrix", "degraded"),
 #   labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded")
 #   )
abcover_vegcover_plot_2

#  column plot - by SITE
abcover_vegcover_plot <- ggplot(abcover_vegcover_meanSD, aes(x = standtype, y = mean_cover, fill = standtype)) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(
    aes(ymin = mean_cover-se, ymax=mean_cover+se), # mean +- SE
                width=.2, position=position_dodge(.9)) +
  labs(
    title = "Percent Canopy Cover", 
    x = "Site", 
    y = "Average Percent Canopy Cover (%)") + # title, axes titles
  scale_fill_manual(values = c(standcolors)) + # manual colors
  # scale_fill_manual(values = cal_palette('chaparral2')) +  # continuous colors
  #                  limits = c("intact", "matrix", "degraded"), # "limits" reorders the x-axis
  #                  labels = c("Intact", "Matrix", "Degraded")) + # "labels" changes the name
  theme_bw() #+
 # scale_x_discrete(
 #   limits=c("intact", "matrix", "degraded"),
 #   labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded")
 #   )
abcover_vegcover_plot
```

# LIFEORM and STATUS

-   by fern, grass, forb, shrub

-   lifeform by native/nonnative status - there shouldn't be zeros in your df

```{r cover x status x lifeform - data prep, include = TRUE}
# line 933 from Ch1_Degradation_original.Rmd

# data prep
abcover_bylf_bystatus <- abcover_full_v_omitground %>% 
  group_by(standtype, lifeform, status, site, rep, site_rep) %>% 
  dplyr::summarize(
    count_per_transect = n_distinct(site_rep_dist), 
    percentcover = n_distinct(site_rep_dist)/41 # <-- calculate percent cover by transect, lifeform, and status
    )
# view(abcover_bylf_bystatus) # prints to new tab
#write.csv(abcover_bylf_bystatus,"processed/abcover_bylf_bystatus.csv")
# visualizing data

## histogram 
hist(abcover_bylf_bystatus$percentcover) 

## jitter - lifeform percent cover by site_rep
ggplot(data = abcover_bylf_bystatus, 
       aes(x = site_rep, 
           y = percentcover*100,
           color = lifeform)) + 
  geom_jitter()

# by lifeform - hillslope percent cover by fern, forb, grass, shrub
ggplot(data = abcover_bylf_bystatus, 
       aes(y = percentcover*100, x = lifeform, color = standtype)) + 
  geom_jitter()

# by standtype percent cover by status (native or non-native)
ggplot(data = abcover_bylf_bystatus, 
       aes(y = percentcover*100, 
           x = standtype, color = status)) + 
  geom_jitter()
```
```{r}
## boxplot
ggplot(data = abcover_bylf_bystatus, 
       aes(y = percentcover*100, x = standtype, fill = lifeform)) +
    geom_boxplot() # boxplots

## jitter - by standtype
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = lifeform)) + 
  geom_jitter()
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = status)) + 
  geom_jitter()
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, color = status)) + 
  geom_point()
## boxplot
ggplot(data = abcover_bylf_bystatus, aes(y = percentcover*100, x = standtype, fill = lifeform)) +
    geom_boxplot() # boxplots
```

# STATUS

-   Percent cover by native/nonnative status

```{r percent cover by status stats, include=TRUE}

# NATIVE and NON-NATIVE
# testing for normality by status 
shapiro.test(abcover_bylf_bystatus$percentcover) 
#W = 0.90228, p-12838.200536385179 value = 0.0001246 <-- not normally distributed


# NATIVE ONLY
abcover_bylf_bystatus_native <- abcover_bylf_bystatus %>%   # NATIVE ONLY
  filter(status =="native")

shapiro.test(abcover_bylf_bystatus_native$percentcover) 
# 	Shapiro-Wilk normality test
# 
# data:  abcover_bylf_bystatus_native$percentcover
# W = 0.89092, p-value = 0.002663 <-- not normally distributed

kruskal.test(percentcover ~ standtype, data = abcover_bylf_bystatus_native)
# Kruskal-Wallis rank sum test
# 
# data:  percentcover by standtype
# Kruskal-Wallis chi-squared = 4.1338, df = 2, p-value = 0.1266 <-- not sig different

pairwise.wilcox.test(abcover_bylf_bystatus_native$percentcover, abcover_bylf_bystatus_native$standtype,
                 p.adjust.method = "BH")
# data:  abcover_bylf_bystatus_native$percentcover and abcover_bylf_bystatus_native$standtype 
# 
#          intact matrix
# matrix   0.26   -     
# degraded 0.20   0.26  <-- no significant differences
# 
# P value adjustment method: BH 
# 
# --- ERROR MESSAGE ---
# Warning: cannot compute exact p-value with ties
# 
# From CHATGPT: The warning message you are seeing, "Warning: cannot compute exact p-value with ties," occurs when you are performing a statistical test that relies on exact p-values, such as the Mann-Whitney U test or the Kruskal-Wallis test, and there are tied values in your data. Tied values mean that there are two or more identical values in your dataset.

# When ties occur, the exact ranks of these tied values cannot be determined, leading to potential inaccuracies in the p-value calculation. Some statistical tests require exact ranks to compute p-values, so when ties are present, the software might issue a warning indicating that the p-value might not be exact.


# NON-NATVE
abcover_bylf_bystatus_nonnative <- abcover_bylf_bystatus %>%  # NON-NATIVE ONLY
  filter(status == "nonnative")
shapiro.test(abcover_bylf_bystatus_nonnative$percentcover) 
# 	Shapiro-Wilk normality test 
# 
# data:  abcover_bylf_bystatus_nonnative$percentcover
# W = 0.9056, p-value = 0.01551  <-- not normally distributed

kruskal.test(percentcover ~ standtype, data = abcover_bylf_bystatus_nonnative)
# Kruskal-Wallis rank sum test
# 
# data:  percentcover by standtype
# Kruskal-Wallis chi-squared = 11.254, df = 2, p-value = 0.0036 <-- significantly different 

pairwise.wilcox.test(abcover_bylf_bystatus_nonnative$percentcover, abcover_bylf_bystatus_nonnative$standtype,
                 p.adjust.method = "BH")
#          intact matrix
# matrix   0.078  -     
# degraded 0.013  0.039 <-- significantly different

```

```{r data prep for cover by status, include = TRUE}

abcover_nativecover <- abcover_full_v %>% 
  na.omit() %>%  
  filter(status == "native") %>% 
  group_by(standtype, site_rep) %>% 
  dplyr::summarize(count_per_transect = length(unique(distance)), 
                  percentcover_native = length(unique(distance))/41
                  )
head(abcover_nativecover)

abcover_nncover <- abcover_full_v %>% 
  na.omit() %>%  
  filter(status == "nonnative") %>% 
  group_by(standtype, site_rep) %>% 
  dplyr::summarize(count_per_transect = length(unique(distance)), 
                  percentcover_nonnative = length(unique(distance))/41
                  )
head(abcover_nncover)

abcover_bystatus <- abcover_nativecover %>% 
  left_join(abcover_nncover, by = 'site_rep')
head(abcover_bystatus)

# copy/paste data, edited in Excel, saved as csv in 2022b folder
abcover_bystatus_edited <- read.csv("abcover_bystatus.csv", header = TRUE, na.strings=c("","NA"))
print(abcover_bystatus_edited)
  
```

```{r}

ggplot(abcover_bystatus_edited, aes(fill = status, y=percentcover*100, x=site_rep)) + 
    geom_bar(position="stack", stat="identity") +
    theme(axis.text.x.bottom = element_text(angle = 90)) +
  labs(x = "Transect ID", 
       y = "Percent cover (%)", 
       title = "Percent cover by vegetation status per Trasect")
```

```{r scatterplot native cover by nn grass cover, include=TRUE}

cover_statuslf_matrix <- read.csv("percentcover_bystatus_bylifeform_matrix.csv", header = TRUE) %>% 
  mutate(lifeform = case_when(lifeform == "herb" ~ "forb", 
                              TRUE ~ lifeform))
cover_statuslf_matrix <- cover_statuslf_matrix %>% 
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded"))

#from chunk: SHRUB scatterplot 
cover_statuslf_matrix$status_lifeform <- paste(cover_statuslf_matrix$status, cover_statuslf_matrix$lifeform, sep="_") # combine status and life form to one column
cover_statuslf_matrix_long <- cover_statuslf_matrix %>%
 dplyr::select(standtype, site_rep, percentcover, status_lifeform)
head(cover_statuslf_matrix_long)

cover_statuslf_matrix_wide1 <- cover_statuslf_matrix_long %>%
  spread(status_lifeform, percentcover) %>% 
 mutate(site_rep = case_when(site_rep == "Intact_1_1" ~ "INT1_1", # old name ~ new name
                            site_rep ==  "Intact_2_2" ~ "INT2_2",
                            site_rep ==  "Intact_3_3" ~ "INT3_3",
                              TRUE ~ site_rep))
#write.csv(cover_statuslf_matrix_wide1,"processed/coverstatus.csv")

head(cover_statuslf_matrix_wide1)

abcover_nativecover_nngrasscover <- left_join(abcover_nativecover, # left join total native cover
                                              cover_statuslf_matrix_wide1, 
                                              by = c("site_rep", "standtype"))
view(abcover_nativecover_nngrasscover)

formula6 <- abcover_nativecover_nngrasscover$percentcover_native ~ abcover_nativecover_nngrasscover$nonnative_grass

native_by_nngrass_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = nonnative_grass*100, y = percentcover_native*100, shape = standtype, color = standtype)) + #shape = standtype.x, color = standtype.x
  geom_point(size = 3, alpha = 0.8) +
   scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
#  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native cover (%)", 
       title = "Total Native Cover by Non-native Grass Cover") +
  theme_bw() +  
  stat_poly_line() +
#  stat_poly_eq(use_label(c("eq", "R2")))
 stat_poly_eq(
    aes(label = paste(after_stat(eq.label), stat(adj.rr.label), sep = "~~~~")),
    formula = formula6, 
    parse=TRUE
 )
print(native_by_nngrass_regression)

#write.csv(abcover_nativecover_nngrasscover,"processed/abcover_nativecover_nngrasscover.csv")

```

```{r segmented scatterplot native shrub cover by nn grass cover, include=TRUE}

### SEGMENTED ###
p <- ggplot(abcover_nativecover_nngrasscover, aes(x = nonnative_grass, y = percentcover_native)) + geom_line()+
  geom_point()
p

#create a linear model <-- from https://rpubs.com/MarkusLoew/12164
my.lm <- lm(nonnative_grass ~ percentcover_native, data = abcover_nativecover_nngrasscover)
summary(my.lm)

# Extract the coefficients from the overall model
my.coef <- coef(my.lm)

# add the regression line to the graph
# setting the aesthetics to a constant - this provides a name that we can reference later when we add additional layers
p <- p + geom_abline(intercept = my.coef[1], 
                         slope = my.coef[2], 
                     aes(colour = "overall"))
p

# -------------------
# analyse breakpoints
# -------------------
# http://cran.r-project.org/doc/Rnews/Rnews_2008-1.pdf


# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(my.lm, 
                    seg.Z = ~ nonnative_grass,  # x-axis
                  # psi = .4, .7
                   psi = list(percentcover_native = c(.1219,.829, 0.3))
                    )

my.seg <- segmented(my.lm, seg.Z = ~ nonnative_grass, psi = list(percentcover_native = c(.1, .7)))

# When not providing estimates for the breakpoints "psi = NA" can be used.
# The number of breakpoints that will show up is not defined
#my.seg <- segmented(my.lm, 
#                    seg.Z = ~ DistanceMeters, 
#                    psi = NA)

# display the summary
summary(my.seg)

# get the breakpoints
my.seg$psi

# get the slopes
slope(my.seg)

```

```{r}


# get the slopes manually - excercise!!
my.slopes <- coef(my.seg)

# first line: 
#y = b0 + b1*x
#y = intercept1 + slope1 * x

# second line:
#y = c0 + c1*x
#y = intercept2 + slope2 * x

# third line
#y = d0 + d1 *x
#y = intercept3 + slope3 * x

# At the breakpoint (break1), the segments b and c intersect

#b0 + b1*x = c0 + c1*x

b0 <- coef(my.seg)[[1]]
b1 <- coef(my.seg)[[2]]

# Important:
# the coefficients are the differences in slope in comparison to the previous slope
c1 <- coef(my.seg)[[2]] + coef(my.seg)[[3]]
break1 <- my.seg$psi[[3]]

#Solve for c0 (intercept of second segment):
c0 <- b0 + b1 * break1 - c1 * break1


# At the breakpoint (break2), the two lines are the same again:
# the coefficients are the differences in slope in comparison to the previous slope
d1 <- coef(my.seg)[[4]] + c1
break2 <- my.seg$psi[[4]]

#Solve for d0 (intercept of third segment):
d0 <- c0 + c1 * break2 - d1 * break2

# adding lines to the graph

# line before first breakpoint
p1 <- p1 + geom_abline(intercept = b0, slope = b1, 
                     aes(colour = "first part"), show_guide = TRUE)
p1


# line after first breakpoint
p1 <- p1 + geom_abline(intercept = c0, slope = c1, 
                     aes(colour = "second part"), show_guide = TRUE)
p1


# line after second breakpoint -- if there is one
p1 <- p1 + geom_abline(intercept = d0, slope = d1, 
                     aes(colour = "third part"), show_guide = TRUE)
p1


# get the fitted data
my.fitted <- fitted(my.seg)
my.model <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover$nonnative_grass, TotalNonNativeCover = my.fitted)

# plot the fitted model
ggplot(my.model, aes(x = NonNativeGrassCover, y = TotalNonNativeCover)) + geom_line()


# add the fitted data to the exisiting plot
p1 + geom_line(data = my.model, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "tomato")

# add vertical lines to indicate the break locations
# second row of the psi-matrix
my.lines <- my.seg$psi[, 2]

p1 <- p1 + geom_vline(xintercept = my.lines, linetype = "dashed")
p1
```

```{r scatterplot native cover by native shrub cover, include=TRUE}

native_by_nativeshrub_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = native_shrub*100, y = percentcover_native*100, shape = standtype, color = standtype)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
   geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +  # Add 1:1 line
  scale_shape_manual(values = c(16, 17, 18)) + 
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Native cover (%)", 
       title = "Total Native Cover by Natie Shrub Cover") +
  theme_bw() #+  
  #stat_poly_line() #+
 # stat_poly_eq(use_label(c("eq", "R2")))
print(native_by_nativeshrub_regression)

```

```{r scatterplot native forb by native shrub cover, include=TRUE}

nativeforb_by_nativeshrub_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = native_shrub*100, y = native_forb*100, shape = standtype, color = standtype)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Native forb cover (%)", 
       title = "Native forb cover x native shrub cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

print(nativeforb_by_nativeshrub_regression)

```

```{r scatterplot native forb by nn grass cover, include=TRUE}

nativeforb_by_nngrass_regression <- ggplot(data = abcover_nativecover_nngrasscover, 
       aes(x = nonnative_grass*100, y = native_forb*100, shape = standtype, color = standtype)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native forb cover (%)", 
       title = "Native forb cover x non-native grass cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nativeforb_by_nngrass_regression)

```

#### NATIVE/NONNATIVE PERCENT COVER HERE!

```{r scatterplot nonnative cover by nn grass cover, include=TRUE}

abcover_nonnative_cover <- abcover_full_v %>% 
  na.omit() %>%  
  filter(status == "nonnative") %>% 
  group_by(standtype, site_rep) %>% 
  dplyr::summarize(count_per_transect = length(unique(distance)), 
                  percentcover_nonnative = length(unique(distance))/41
                  )
view(abcover_nonnative_cover)

abcover_nonnativecover_nngrasscover <- left_join(abcover_nonnative_cover, abcover_nativecover_nngrasscover, 
                                                 by = c("site_rep", "standtype")) # <-- native and non-native percent cover here! 


view(abcover_nonnativecover_nngrasscover)
write.csv(abcover_nonnativecover_nngrasscover, "processed/abcover_nonnativecover_nngrasscover.csv")

nnnative_by_nngrass_regression <- ggplot(data = abcover_nonnativecover_nngrasscover, 
       aes(x = nonnative_grass*100, y = percentcover_nonnative*100, shape = standtype, color = standtype)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
   geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +  # Add 1:1 line
   scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Non-native cover (%)", 
       title = "Total Native Cover by Non-native Grass Cover") +
  theme_bw() #+  
 # stat_poly_line() +
 # stat_poly_eq(use_label(c("eq", "R2")))
print(nnnative_by_nngrass_regression)

```

```{r scatterplot nonnative cover by native shrub cover, include=TRUE}

nncover_nativeshrub <- ggplot(data = abcover_nonnativecover_nngrasscover, 
       aes(x = native_shrub*100, y = percentcover_nonnative*100, shape = standtype, color = standtype)) + #shape = standtype.x, color = standtype.x
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Total non-native cover (%)", 
       title = "Total non-native cover x native shrub cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nncover_nativeshrub)

```

### shrub cover by leaf type x non-native grass

```{r data prep adding leaf type and percent native/nn cover to  shrub species percent cover}
# # percent cover by shrub species df
# shrubspp <- abcover_full_v_omitground %>% 
#   filter(lifeform == "shrub") 
# sort(unique(shrubspp$species))
# # [1] "Artemisia californica"         <-- 1
# #   "Baccharis pilularis"             2
# #   "Eriodictyon crassifolium"       3
# #  [4] "Heteromeles arbutifolia"      4  
# #   "Heteromeles arbutifolia dead"    
# #   "Malacothamnus fasciculatus"     5
# #  [7] "Malacothamnus fasciculatus dead" 
# #  "Rhamnus ilicifolia"             6
# #   "Rhus ovata"                     7
# # [10] "Salvia leucophylla"           8 unique species 
# #   "Salvia leucophylla dead"  <-- 3 dead shrub species
# 
# # Read the Excel file into R
# shrub_leaftype <- read_excel("shrub_leaftype.xlsx")
# sort(unique(shrub_leaftype$species))
# # [1] "Artemisia californica"           "Baccharis pilularis"             "Eriodictyon crassifolium"       
# #  [4] "Heteromeles arbutifolia"         "Heteromeles arbutifolia dead"    "Malacothamnus fasciculatus"     
# #  [7] "Malacothamnus fasciculatus dead" "Rhamnus ilicifolia"              "Rhus ovata"                     
# # [10] "Salvia leucophylla"              "Salvia leucophylla dead"      
# 
# shrubspp_leaftype <- shrubspp %>%  
#   left_join(shrub_leaftype, by = "species") # left join leaf type
# 
# shrubspp_leaftype_cover_write <- shrubspp_leaftype %>% 
#     filter(!grepl("dead", species, ignore.case = TRUE)) %>%  # Filter out species containing "dead"
#   group_by(standtype, site, rep, site_rep, species, leaftype,) %>% 
#   dplyr::summarize(
#     count_per_transect = n_distinct(site_rep_dist), 
#     percentcover = (n_distinct(site_rep_dist)/41)*100 # <-- calculate percent cover 
#     ) %>% 
#   dplyr::select(!c(count_per_transect)) %>% 
#   group_by(standtype, site, site_rep, leaftype) %>% 
#    dplyr::summarize(sum_leaftype_cover = sum(percentcover), 
#                     num_species = (length(species))
#    ) %>%
#   left_join(abcover_nonnativecover_nngrasscover, # left join non-native grass cover (and all cover)
#               by = c("standtype", "site_rep")) %>% 
#    dplyr::select(!c(count_per_transect.x, count_per_transect.y)) %>% 
#    mutate(standtype = fct_relevel(standtype, 
#             "intact", "matrix", "degraded")) %>% 
#   mutate(leaftype = fct_relevel(leaftype, 
#             "native_shrub", "sclerophyllous", "nonsclero"))
# 
# view(shrubspp_leaftype_cover_write)
# write.csv(shrubspp_leaftype_cover_write,"processed/shrubspp_leaftype_cover.csv")

shrubspp_leaftype_cover <- read.csv("processed/shrubspp_leaftype_cover_zeros.csv") %>%
  mutate(standtype = fct_relevel(standtype, 
             "intact", "matrix", "degraded")) %>% 
   mutate(site = fct_relevel(site, 
             "INT1", "INT2", "INT3", "ENH1", "ENH2", "DEG1", "DEG2")) %>% 
  mutate(leaftype = fct_relevel(leaftype, 
            "sclerophyllous", "nonsclero"))
  
```

```{r leaftype data visualization}

#scatterplot
ggplot(data = shrubspp_leaftype_cover, 
       aes(y = sum_leaftype_cover, x = site, color = leaftype)) +
    geom_point(size = 5)
```

```{r leaf type stats - SCL}
shrubspp_leaftype_SCLcover <- shrubspp_leaftype_cover %>% 
  filter(leaftype == "sclerophyllous")

histogram(shrubspp_leaftype_SCLcover$sum_leaftype_cover)

shapiro.test(shrubspp_leaftype_SCLcover$sum_leaftype_cover)
# Shapiro-Wilk normality test
# 
# data:  shrubspp_leaftype_SCLcover$sum_leaftype_cover
# W = 0.54976, p-value = 9.124e-06 <-- not normally distributed

### by standtype
kruskal.test(sum_leaftype_cover ~ standtype, data = shrubspp_leaftype_SCLcover)
# Kruskal-Wallis rank sum test
# 
# data:  sum_leaftype_cover by standtype
# Kruskal-Wallis chi-squared = 11.365, df = 2, p-value = 0.003406 <-- sig diff

pairwise.wilcox.test(shrubspp_leaftype_SCLcover$sum_leaftype_cover, shrubspp_leaftype_SCLcover$standtype,
                 p.adjust.method = "BH")
#         intact matrix
# matrix   0.024  -     
# degraded 0.024  0.405 <-- intact is sig different than matrix and degraded

### by hillslope
kruskal.test(sum_leaftype_cover ~ site, data = shrubspp_leaftype_SCLcover)
# Kruskal-Wallis rank sum test
# data:  sum_leaftype_cover by site
# Kruskal-Wallis chi-squared = 12.024, df = 6, p-value = 0.06145

pairwise.wilcox.test(shrubspp_leaftype_SCLcover$sum_leaftype_cover, shrubspp_leaftype_SCLcover$site,
                 p.adjust.method = "BH")
# 
# 
#      INT1 INT2 INT3 ENH1 ENH2 DEG1
# INT2 1.00 -    -    -    -    -   
# INT3 1.00 1.00 -    -    -    -   
# ENH1 0.52 0.52 0.52 -    -    -   
# ENH2 0.50 0.50 0.50 0.61 -    -   
# DEG1 0.50 0.50 0.50 0.61 -    -   
# DEG2 0.50 0.50 0.50 0.61 -    - 
```

```{r leaf type stats - NON SCL}
shrubspp_leaftype_NONSCLcover <- shrubspp_leaftype_cover %>% 
  filter(leaftype == "nonsclero")

histogram(shrubspp_leaftype_NONSCLcover$sum_leaftype_cover)

shapiro.test(shrubspp_leaftype_NONSCLcover$sum_leaftype_cover)
# 	Shapiro-Wilk normality test
# 
# data:  shrubspp_leaftype_NONSCLcover$sum_leaftype_cover
# W = 0.90197, p-value = 0.102 <-- normally distributed

summary(aov(sum_leaftype_cover ~ standtype, data = shrubspp_leaftype_NONSCLcover))
#             Df Sum Sq Mean Sq F value Pr(>F)
# standtype    2   2511  1255.5   2.623  0.113 <-- no diff in sage scrub canopy cover between stands
# Residuals   12   5744   478.6 

TukeyHSD((aov(sum_leaftype_cover ~ standtype, data = shrubspp_leaftype_NONSCLcover)))
# $standtype
#                      diff       lwr       upr     p adj
# matrix-intact    16.66667 -24.60484 57.938170 0.5452095
# degraded-intact -12.19512 -53.46663 29.076382 0.7169657
# degraded-matrix -28.86179 -62.55983  4.836253 0.0967824


summary(aov(sum_leaftype_cover ~ site, data = shrubspp_leaftype_NONSCLcover))
#             Df Sum Sq Mean Sq F value Pr(>F)  
# site         6   5812   968.6   3.172 0.0673 . <-- no diff by hillslope
# Residuals    8   2443   305.4 

TukeyHSD((aov(sum_leaftype_cover ~ site, data = shrubspp_leaftype_NONSCLcover)))
# Fit: aov(formula = sum_leaftype_cover ~ site, data = shrubspp_leaftype_NONSCLcover)
# 
# $site
#                 diff        lwr       upr     p adj
# DEG2-DEG1 -11.382114  -65.85474  43.09051 0.9786122
# ENH1-DEG1  39.024390  -15.44823  93.49701 0.2032746
# ENH2-DEG1   7.317073  -47.15555  61.78970 0.9978115
# INT1-DEG1 -19.512195  -96.54812  57.52373 0.9483739
# INT2-DEG1  36.585366  -40.45056 113.62129 0.5737545
# INT3-DEG1   2.439024  -74.59690  79.47495 0.9999995
# ENH1-DEG2  50.406504   -4.06612 104.87913 0.0724026
# ENH2-DEG2  18.699187  -35.77344  73.17181 0.8306002
# INT1-DEG2  -8.130081  -85.16600  68.90584 0.9994274
# INT2-DEG2  47.967480  -29.06844 125.00340 0.3149369
# INT3-DEG2  13.821138  -63.21478  90.85706 0.9899234
# ENH2-ENH1 -31.707317  -86.17994  22.76531 0.3764956
# INT1-ENH1 -58.536585 -135.57251  18.49934 0.1646056
# INT2-ENH1  -2.439024  -79.47495  74.59690 0.9999995
# INT3-ENH1 -36.585366 -113.62129  40.45056 0.5737545
# INT1-ENH2 -26.829268 -103.86519  50.20665 0.8220705
# INT2-ENH2  29.268293  -47.76763 106.30422 0.7644413
# INT3-ENH2  -4.878049  -81.91397  72.15787 0.9999701
# INT2-INT1  56.097561  -38.25179 150.44691 0.3566797
# INT3-INT1  21.951220  -72.39813 116.30057 0.9646390
# INT3-INT2 -34.146341 -128.49569  60.20301 0.7979319
```

### nngrass stats x standtype

```{r nonnative grass by stand type and hillslope stats}

abcover_nngrass <- abcover_bylf_bystatus %>% 
  filter(lifeform == "grass") %>% 
  filter(status == "nonnative")

histogram(abcover_nngrass$percentcover)

shapiro.test(abcover_nngrass$percentcover)
# Shapiro-Wilk normality test
# 
# data:  abcover_nngrass$percentcover
# W = 0.80794, p-value = 0.004657 <-- not normally distributed


### by standtype
kruskal.test(percentcover ~ standtype, data = abcover_nngrass)
# Kruskal-Wallis rank sum test
# 
# data:  percentcover by standtype
# Kruskal-Wallis chi-squared = 12.282, df = 2, p-value = 0.002153

pairwise.wilcox.test(abcover_nngrass$percentcover, abcover_nngrass$standtype,
                 p.adjust.method = "BH")
# data:  abcover_nngrass$percentcover and abcover_nngrass$standtype 
# 
#          intact matrix
# matrix   0.028  -     
# degraded 0.028  0.014 <-- all are sig diff by stand type

### by hillslope
kruskal.test(percentcover ~ site, data = abcover_nngrass)
# Kruskal-Wallis rank sum test
# 
# data:  percentcover by site
# Kruskal-Wallis chi-squared = 13.099, df = 6, p-value = 0.0415 <-- sig by hillslope

pairwise.wilcox.test(abcover_nngrass$percentcover, abcover_nngrass$site,
                 p.adjust.method = "BH")
# data:  abcover_nngrass$percentcover and abcover_nngrass$site 
# 
#      DEG1 DEG2 ENH1 ENH2 INT1 INT2
# DEG2 0.95 -    -    -    -    -   
# ENH1 0.42 0.40 -    -    -    -   
# ENH2 0.40 0.40 0.40 -    -    -   
# INT1 0.62 0.62 0.62 0.62 -    -   
# INT2 0.62 0.62 0.62 0.62 1.00 -   
# INT3 0.62 0.62 0.62 0.62 1.00 1.00
```

```{r leaf type Figure}

leaftype_nngrass_figure <- ggplot(data = shrubspp_leaftype_cover, 
       aes(x = nonnative_grass*100, y = sum_leaftype_cover, 
           color = leaftype)) +
  geom_point(size = 3, alpha = 0.8) +
  # geom_point(data = shrubspp_leaftype_cover, 
  #            aes(x = nonnative_grass*100, y = percentcover_native*100, shape = standtype), 
  #            size = 3, alpha = 0.8, color = "red") +  # Add second set of data
  #scale_shape_manual(values = c(16, 17, 18)) +
    labs(title = "Shrub cover by leaf type over non-native grass cover",
         x = "Non-native grass cover (%)",
       y = "Percent cover (%)",
       ) +
  scale_color_manual(values = c("darkgreen", "purple"),
                     name = "Leaf Type",
                     labels = c("nonsclero" = "non-sclerophyllous", #rename leaf types
                                "sclerophyllous" = "sclerophyllous")
                     ) +
  ylim(0, 110)+
  xlim(0,100) +
  #geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  theme_bw() +
   stat_poly_line() +
   stat_poly_eq(use_label(c("eq", "R2")))
print(leaftype_nngrass_figure)
```

```{r  leaf type Figure another version}
leaftype_nativenn_cover <- read_excel("processed/leaftype_nativenn_cover.xlsx", sheet = "shrubspp_leaftype_cover", range = "A1:F35") %>%
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded")) %>% 
  mutate(leaftype = fct_relevel(leaftype, 
            "native_shrub", "sclerophyllous", "nonsclero"))

ggplot(data = leaftype_nativenn_cover, 
       aes(x = nonnative_grass*100, y = percentcover*100, color = leaftype)) + #shape = standtype
  geom_point(size = 3, alpha = 0.8) +
  labs(title = "Shrub cover by leaf type by non-native grass cover", 
       x = "Non-native grass cover (%)",
       y = "Percent cover (%)"
       ) +
  scale_shape_manual(values = c(16, 17, 18), 
                     name = "Stand Type", 
                     labels = c("intact" = "shrub dominated",
                                "matrix" = "matrix",
                                "degraded" = "grass dominated")
                     ) +
#  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c("gray", "darkgreen", "purple"),
                     name = "Percent Cover Type",
                     labels = c("nonsclero" = "non-sclerophyllous",
                                "sclerophyllous" = "sclerophyllous",
                                "native_shrub" = "total native shrub")) + #rename standtypes labels
  ylim(0, 110)+
  xlim(0,100) +
  theme_bw() 

```

```{r shrub cover by leaf type x nn grass cover, include=TRUE}


shrubleaftype_nngrass <- ggplot(data = abcover_nonnativecover_nngrasscover, 
       aes(x = native_shrub*100, y = percentcover_nonnative*100, shape = standtype, color = standtype)) + #shape = standtype.x, color = standtype.x
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Total non-native cover (%)", 
       title = "Total non-native cover x native shrub cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nncover_nativeshrub)

```

```{r scatterplot nonnative grass cover by native shrub cover, include=TRUE}

nngrass_nativeshrub <- ggplot(data = abcover_nonnativecover_nngrasscover, 
       aes(x = native_shrub*100, y = nonnative_grass*100, shape = standtype.x, color = standtype.x)) + #shape = standtype.x, color = standtype.x
  geom_point(size = 3, alpha = 0.8) +
  scale_shape_manual(values = c(16, 17, 18)) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Native shrub cover (%)", 
       y = "Non-native grass cover (%)", 
       title = "Non-native grass cover x native shrub cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))
print(nngrass_nativeshrub)

```

# Breakpoints

```{r segmented scatterplot nonnative cover by nn grass cover, include=TRUE}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]

### SEGMENTED ###

p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) + geom_line()+
  geom_point()

p2 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) + geom_line()+
  geom_point()
p1

#create a linear model <-- from https://rpubs.com/MarkusLoew/12164
my.lm.nnnative_by_nngrass_regression <- lm(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2)
summary(my.lm.nnnative_by_nngrass_regression)

# Extract the coefficients from the overall model
my.coef.my.lm.nnnative_by_nngrass_regression <- coef(my.lm.nnnative_by_nngrass_regression)

# add the regression line to the graph
# setting the aesthetics to a constant - this provides a name that we can reference later when we add additional layers
p1 + geom_abline(intercept = my.coef.my.lm.nnnative_by_nngrass_regression[1], 
                         slope = my.coef.my.lm.nnnative_by_nngrass_regression[2], 
                     aes(colour = "overall"))
#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(my.lm.nnnative_by_nngrass_regression, 
                    seg.Z = ~ nonnative_grass,  # x-axis
                    psi = c(.3, .8)
                    )
 
# # display the summary
# summary(my.seg)
# 
# # get the breakpoints
# my.seg$psi
# 
# # get the slopes
# slope(my.seg)
# 
#   b0 <- coef(my.seg)[[1]]
#   b1 <- coef(my.seg)[[2]]
# 
# # Important:
# # the coefficients are the differences in slope in comparison to the previous slope
#   c1 <- coef(my.seg)[[2]] + coef(my.seg)[[3]]
#   break1 <- my.seg$psi[[3]]
# 
# #Solve for c0 (intercept of second segment):
#   c0 <- b0 + b1 * break1 - c1 * break1
# 
# 
# # At the breakpoint (break2), the two lines are the same again:
# # the coefficients are the differences in slope in comparison to the previous slope
#  d1 <- coef(my.seg)[[4]] + c1
#  break2 <- my.seg$psi[[4]]
# 
# #Solve for d0 (intercept of third segment): 
#  d0 <- c0 + c1 * break2 - d1 * break2
# 
# # adding lines to the graph
# 
# # line before first breakpoint
# p1 + geom_abline(intercept = b0, slope = b1, color = "red", show_guide = TRUE) + geom_abline(intercept = c0, slope = c1, color = "blue", show_guide = TRUE) + geom_abline(intercept = d0, slope = d1, color = "green", show_guide = TRUE)
# p1

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail(abcover_nonnativecover_nngrasscover2$percentcover_nonnative, n = 1))

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- my.seg$psi[, 2]

modelgraph <- p2 + 
  geom_vline(xintercept = my.lines, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE)

p2
```

```{r segmented nonnative grass/all}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]
tail <- tail(abcover_nonnativecover_nngrasscover2$percentcover_nonnative, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative))
model <- lm(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,  # x-axis
                    psi = c(.3, .8)
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass

```

```{r segmented nonnative grass/native}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$percentcover_native, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(x = nonnative_grass, y = percentcover_native))
model <- lm(percentcover_native ~ nonnative_grass, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,
                    npsi = 2
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.y, color = standtype.y)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented nonnative forb/nn grass}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_forb , decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(x = nonnative_grass, y = nonnative_forb)) +
  geom_point()
model <- lm(nonnative_forb ~ nonnative_grass, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model,
                    npsi = 2)

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented native forb/nn grass}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_forb , decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(x = nonnative_grass, y = native_forb))
model <- lm(native_forb ~ nonnative_grass, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,
                    npsi =  1
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented native shrub/nn grass}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_shrub, decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(x = nonnative_grass, y = native_shrub))
model <- lm(native_shrub ~ nonnative_grass, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass,
                    npsi = 2
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented nn grass/n shrub}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_shrub, decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$native_shrub, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = native_shrub))
model <- lm(nonnative_grass~ native_shrub, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ native_shrub,
                    npsi = 1
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE) +
  ylim(0,1) +
  xlim(0,1)

modelgraph_nngrass
```

```{r segmented native shrub/nn cover}
abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$native_shrub, decreasing = TRUE),]
tail <- max(abcover_nonnativecover_nngrasscover2$native_shrub, n = 1)
p1 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = percentcover_nonnative, x = native_shrub))
model <- lm(percentcover_nonnative ~ native_shrub, data = abcover_nonnativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, npsi = 2)

plot(fitted(my.seg))

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented native cover/n shrub}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$percentcover_native, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$percentcover_native, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(y = percentcover_native, x = native_shrub)) +
  geom_point()
model <- lm(percentcover_native ~ native_shrub, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ native_shrub,
                    npsi = 2
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- min(abcover_nativecover_nngrasscover2$percentcover_native, n = 1)
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nnngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nnngrass
```

```{r segmented native forbes/n shrub}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$native_forb, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$native_forb, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(y = native_forb, x = native_shrub)) 
model <- lm(native_forb ~ native_shrub, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, npsi = 2)

plot(fitted(my.seg))

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- min(abcover_nativecover_nngrasscover2$percentcover_native, n = 1)
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.x, color = standtype.x)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

```{r segmented nnforb /n shrub}

# KIT - can you let me know if I ran this and the next chunck correctly - and why my shapes aren't showing up for this figure? Thank you!

abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$nonnative_forb, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$native_shrub, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(y = nonnative_forb, x = native_shrub))
model <- lm(nonnative_forb ~ native_shrub, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ native_shrub,
                    npsi = 1 #this is where you change number of thresholds?
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) { 
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0 #min(abcover_nativecover_nngrasscover2$nonnative_forb, n = 1)
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nnngrass <- p1 + 
  geom_point(aes(shape = standtype.y, color = standtype.y)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nnngrass
```

```{r segmented nonnative grass/native grass}
abcover_nativecover_nngrasscover2 <- abcover_nativecover_nngrasscover[order(abcover_nativecover_nngrasscover$native_grass, decreasing = TRUE),]
tail <- max(abcover_nativecover_nngrasscover2$nonnative_grass, n = 1)
p1 <- ggplot(abcover_nativecover_nngrasscover2, aes(x = nonnative_grass, y = native_grass))
model <- lm(native_grass ~ nonnative_grass, data = abcover_nativecover_nngrasscover2)

#analyze breakpoints
# have to provide estimates for breakpoints.
# after looking a the data, 
my.seg <- segmented(model, 
                    seg.Z = ~ nonnative_grass
                    )

bp <- as.data.frame(my.seg$psi)
bp <- as.list(bp$Est.)
bpcount <- length(bp) + 1
bpcount1 <- length(bp) - 1

modelxbeg <- rep(NaN, times = bpcount)
modelxend <- rep(NaN, times = bpcount)
modelybeg <- rep(NaN, times = bpcount)
modelyend <- rep(NaN, times = bpcount)
intercept <- rep(NaN, times = bpcount)
slope1 <- rep(NaN, times = bpcount)
break1 <- rep(NaN, times = bpcount)

for (i in 1:bpcount) {
  break1[i] <- my.seg$psi[[i+bpcount1]]
  if (i == 1) {
    slope1[i] <- coef(my.seg)[[2]] 
    intercept[i] <- coef(my.seg)[[1]]
    break1[i] <- 0
  }
  else {
    slope1[i] <- slope1[i-1] + coef(my.seg)[[i+1]]
    intercept[i] <- (intercept[i-1] + slope1[i-1]*break1[i]) - (slope1[i]*break1[i])
  }
}

modelxend <- c(tail(break1, n = length(break1)-1), tail)

for (i in 1:bpcount) {
  modelybeg[i] <- slope1[i]*break1[i] + intercept[i] 
  modelyend[i] <- slope1[i]*modelxend[i] + intercept[i] 
}

segment_data = data.frame(
    x = break1,
    xend = modelxend,
    y = modelybeg,
    yend = modelyend)

# second row of the psi-matrix
my.lines <- data.frame(psi = my.seg$psi[, 2], label = round(my.seg$psi[, 2], digits = 3))
r2 <- round(summary(my.seg)$adj.r.squared, digits = 4)

modelgraph_nngrass <- p1 + 
  geom_point(aes(shape = standtype.y, color = standtype.y)) + 
  scale_color_manual(values = c("salmon2", "green4", "lightblue3"),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) +
  geom_vline(xintercept = my.lines$psi, linetype = "dashed") +
  geom_segment(
    data = segment_data, 
    mapping = aes(x=x, y=y, xend=xend, yend=yend), 
    inherit.aes = FALSE) +
  geom_text(data = my.lines,
              mapping = aes(x = psi, y = rep(0.85, length(my.lines$psi)), label = label),
              inherit.aes = FALSE,
              hjust = 1) +
  geom_text(mapping = aes(x = 0.3, y = 0.8, hjust = 1, label=paste("Adjusted R Squared:", "\n", r2)), inherit.aes = FALSE)

modelgraph_nngrass
```

#end

```{r}


abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]

bp <- breakpoints(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2, h = 1)
summary(bp)

plot(bp, breaks = 4)
plot(nonnative_grass ~ percentcover_native, data = abcover_nativecover_nngrasscover2, pch = 19)
lines(fitted(bp, breaks = 1) ~ abcover_nativecover_nngrasscover2$percentcover_native, col = 4, lwd = 1.5)

#breakpoints to fitted data
my.fitted1 <- fitted(bp, breaks = 2)
my.model1 <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover2$percentcover_nonnative, TotalNonNativeCover = my.fitted1)

p3 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) +
  geom_point()
p3 <- p3 + geom_line(data = my.model1, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "green4")
p3

# #deep fit
# my.fitted2 <- fitted(bp, breaks = 2)
# my.model2 <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover2$percentcover_nonnative, TotalNonNativeCover = my.fitted2)
# 
# p4 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) +
#   geom_point()
# p4 <- p4 + geom_line(data = my.model2, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "tomato")
# p4

abcover_nonnativecover_nngrasscover2 <- abcover_nonnativecover_nngrasscover[order(abcover_nonnativecover_nngrasscover$nonnative_grass),]

bp <- breakpoints(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2, h = 3)
summary(bp)

plot(bp, breaks = 3)
plot(nonnative_grass ~ percentcover_nonnative, data = abcover_nonnativecover_nngrasscover2, pch = 19)
lines(fitted(bp, breaks = 1) ~ abcover_nonnativecover_nngrasscover2$percentcover_nonnative, col = 4, lwd = 1.5)

#breakpoints to fitted data
my.fitted1 <- fitted(bp, breaks = 1)
my.model1 <- data.frame(NonNativeGrassCover = abcover_nonnativecover_nngrasscover2$percentcover_nonnative, TotalNonNativeCover = my.fitted1)

p3 <- ggplot(abcover_nonnativecover_nngrasscover2, aes(y = nonnative_grass, x = percentcover_nonnative)) +
  geom_point()
p3 <- p3 + geom_line(data = my.model1, aes(x = NonNativeGrassCover, y = TotalNonNativeCover), colour = "green4")
p3
```

```{r }

#write.csv(abcover_bylf_bystatus,"processed/percentcover_bystatus_bylifeform.csv")
# GET RID OF ZEROS in df
cover_statuslf_matrix <- read.csv("percentcover_bystatus_bylifeform_matrix.csv", header = TRUE) %>% mutate(lifeform = case_when(lifeform == "herb" ~ "forb", TRUE ~ lifeform))
cover_statuslf_matrix <- cover_statuslf_matrix %>% 
  mutate(standtype = fct_relevel(standtype, 
            "intact", "matrix", "degraded"))
```

### STACKED proportion of Family by Transect

```{r proportion cover by family, include=TRUE}


# data prep
abcover_byfamily <- abcover_full_v_omitground %>% 
  group_by(standtype, site, rep, site_rep, family, status) %>% 
  #group_by(standtype, site, rep, site_rep, family, lifeform, status) %>% 
  dplyr::summarize(
    count_per_transect = n_distinct(site_rep_dist))

# view(abcover_byfamily) # prints to new tab

abcover_transect_count <- abcover_byfamily %>%
  group_by(site_rep) %>%
  dplyr::summarize(total_by_transect = sum(count_per_transect))

abcover_byfamily_percent <- abcover_byfamily %>%
  left_join(abcover_transect_count, by = c("site_rep")) %>%
  mutate(percent_cover = (count_per_transect/total_by_transect)*100) %>%
  dplyr::select(!c(total_by_transect, count_per_transect))

# view(abcover_byfamily_percent) # prints to new tab

#this is with just the counts
ggplot(abcover_byfamily, aes(fill=family, y=count_per_transect, x=site_rep)) + 
  geom_bar(position="fill", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#this is the percents we calculated
ggplot(abcover_byfamily_percent %>% 
         dplyr::filter(status == "native" | status == "nonnative"),
       aes(fill=family, y=percent_cover, x=site_rep)) + 
  geom_bar(position="stack", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~ status)

#this is the percents we calculated - native
ggplot(abcover_byfamily_percent %>% 
         dplyr::filter(status == "native"),
       aes(fill=family, y=percent_cover, x=site_rep)) + 
  geom_bar(position="stack", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

#this is the percents we calculated - nonnative
ggplot(abcover_byfamily_percent %>% 
         dplyr::filter(status == "nonnative"),
       aes(fill=family, y=percent_cover, x=site_rep)) + 
  geom_bar(position="stack", stat="identity") +
  ggtitle("Relative Percent Cover by Count") +
  labs(x="Transect", y="Percent Cover") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

### SEGMENTATION

```{r segmentation internet info, include = FALSE}
# Install and load the segmented package if you haven't already
#install.packages("segmented")
#library(segmented)

# Generate some example data
set.seed(123)
x <- 1:100
y <- c(2 * x[1:50] + rnorm(50, mean = 0, sd = 10),
       5 * x[51:100] + rnorm(50, mean = 0, sd = 10))

# Fit segmented regression model with one breakpoint
seg_model <- segmented(lm(y ~ x), seg.Z = ~ x, psi = c(80))
seg_model2 <- segmented(lm(y ~ x), seg.Z = ~ x, psi = c(50))
# Plot the segmented regression line
plot(x, y, col = "blue", pch = 16, main = "Segmented Regression Example")
lines(x, predict(seg_model), col = "red", lwd = 2)
lines(x, predict(seg_model2), col = "green", lwd = 2)

#https://cran.r-project.org/web/packages/segmented/segmented.pdf
#page 37: Segmented relationships in regression models
set.seed(12)
xx<-1:100
zz<-runif(100)
yy<-2+1.5*pmax(xx-35,0)-1.5*pmax(xx-70,0)+15*pmax(zz-.5,0)+rnorm(100,0,2)
dati<-data.frame(x=xx,y=yy,z=zz)
out.lm<-lm(y~x,data=dati)

#the simplest example: the starting model includes just 1 covariate
#.. and 1 breakpoint has to be estimated for that
o<-segmented(out.lm) #1 breakpoint for x

#the single segmented variable is not in the starting model, and thus..
#... you need to specify it via seg.Z, but no starting value for psi
o<-segmented(out.lm, seg.Z=~z)
#note the leftmost slope is constrained to be zero (since out.lm does not include z)

#2 segmented variables, 1 breakpoint each (again no need to specify npsi or psi)
o<-segmented(out.lm,seg.Z=~z+x)

#1 segmented variable, but 2 breakpoints: you have to specify starting values (vector) for psi:
o<-segmented(out.lm,seg.Z=~x,psi=c(30,60), control=seg.control(display=FALSE))

#.. or you can specify just the *number* of breakpoints
#o<-segmented(out.lm,seg.Z=~x, npsi=2, control=seg.control(display=FALSE))

slope(o) #the slopes of the segmented relationship

#2 segmented variables: starting values requested via a named list
out.lm<-lm(y~z,data=dati)
o1<-update(o,seg.Z=~x+z,psi=list(x=c(30,60),z=.3))
#..or by specifying just the *number* of breakpoints
#o1<-update(o,seg.Z=~x+z, npsi=c(x=2,z=1))

#the default method leads to the same results (but it is slower)
#o1<-segmented.default(out.lm,seg.Z=~x+z,psi=list(x=c(30,60),z=.3))
#o1<-segmented.default(out.lm,seg.Z=~x+z,psi=list(x=c(30,60),z=.3),
# control=seg.control(fn.obj="sum(x$residuals^2)"))

#automatic procedure to estimate breakpoints in the covariate x (starting from K quantiles)
# Hint: increases number of iterations. Notice: bootstrap restart is not allowed!
#o<-segmented.lm(out.lm,seg.Z=~x+z,psi=list(x=NA,z=.3),
# control=seg.control(fix.npsi=FALSE, n.boot=0, tol=1e-7, it.max = 50, K=5, display=TRUE))

#assess the progress of the breakpoint estimates throughout the iterations
## Not run:
par(mfrow=c(1,2))
draw.history(o, "x")
draw.history(o, "z")
## End(Not run)
#try to increase the number of iterations and re-assess the
#convergence diagnostics
# A simple segmented model with continuous responses and no linear covariates
# No need to fit the starting lm model:
segmented(yy, npsi=2) #NOTE: subsetting the vector works ( segmented(yy[-1],..) )
#if seg.Z is unspecified, the segmented variable is taken as 1:n/n
# An example using the Arima method:
## Not run:
n<-50
idt <-1:n #the time index
mu<-50-idt +1.5*pmax(idt-30,0)
set.seed(6969)
y<-mu+arima.sim(list(ar=.5),n)*3.5
o<-arima(y, c(1,0,0), xreg=idt)
os1<-segmented(o, ~idt, control=seg.control(display=TRUE))
#note using the .coef argument is mandatory!
slope(os1, .coef=os1$coef)
plot(y)
plot(os1, add=TRUE, .coef=os1$coef, col=2)
## End(Not run)

######Three examples using the default method:
#==> 1. Cox regression with a segmented relationship
## Not run:
library(survival)
data(stanford2)
o<-coxph(Surv(time, status)~age, data=stanford2)
os<-segmented(o, ~age, psi=40) #estimate the breakpoint in the age effect
summary(os) #actually it means summary.coxph(os)
plot(os) #it does not work
plot.segmented(os) #call explicitly plot.segmented() to plot the fitted piecewise lines

# ==> 2. Linear mixed model via the nlme package
dati$g<-gl(10,10) #the cluster 'id' variable
library(nlme)
o<-lme(y~x+z, random=~1|g, data=dati)
os<-segmented.default(o, ~x+z, npsi=list(x=2, z=1))

#summarizing results (note the '.coef' argument)
slope(os, .coef=fixef(os))
plot.segmented(os, "x", .coef=fixef(os), conf.level=.95)
confint.segmented(os, "x", .coef=fixef(os))
dd<-data.frame(x=c(20,50),z=c(.2,.6), g=1:2)
predict.segmented(os, newdata=dd, .coef=fixef(os))


# ==> 3. segmented quantile regression via the quantreg package
library(quantreg)
data(Mammals)
y<-with(Mammals, log(speed))
x<-with(Mammals, log(weight))
o<-rq(y~x, tau=.9)
os<-segmented.default(o, ~x) #it does NOT work. It cannot compute the vcov matrix..

#Let's define the vcov.rq function.. (I don't know if it is the best option..)
vcov.rq<-function(x,...) {
V<-summary(x,cov=TRUE,se="nid",...)$cov
rownames(V)<-colnames(V)<-names(x$coef)
V}

os<-segmented.default(o, ~x) #now it does work
plot.segmented(os, res=TRUE, col=2, conf.level=.95)

## End(Not run)
```

```{r segmentation }

```

### - SHRUB

```{r cover by lf by status - stats, include=TRUE}
# SHRUB
# highlight all and run as one command
cover_statuslf_matrix_shrub <- cover_statuslf_matrix %>% 
  filter(lifeform == "shrub" & status == "native")

shapiro.test(cover_statuslf_matrix_shrub$percentcover)
# 	Shapiro-Wilk normality test
# data:  cover_statuslf_matrix_shrub$percentcover
# W = 0.94384, p-value = 0.4331 <-- normally distributed

summary(aov(percentcover ~ standtype, data = cover_statuslf_matrix_shrub))
# Df Sum Sq Mean Sq F value   Pr(>F)    
# standtype    2 0.5516 0.27581    13.9 0.000752 *** <-- significantly different
# Residuals   12 0.2382 0.01985     

TukeyHSD(aov(percentcover ~ standtype, data = cover_statuslf_matrix_shrub))
# Fit: aov(formula = percentcover ~ standtype, data = cover_statuslf_matrix_shrub)
# 
# $standtype
#                       diff        lwr         upr     p adj
# matrix-intact   -0.2723577 -0.5381149 -0.00660053 0.0444896 <-- MAT-INT
# degraded-intact -0.5162602 -0.7820174 -0.25050297 0.0006178 <-- DEG-INT
# degraded-matrix -0.2439024 -0.4608923 -0.02691260 0.0277839 <-- DEG-MAT
                
```

```{r figure shrub, include=TRUE}

# Reorder the levels of the standtype variable
cover_statuslf_matrix$site_rep <- factor(cover_statuslf_matrix$site_rep, 
                                          levels = c("Intact_1_1"
, "Intact_2_2" , "Intact_3_3", "ENH1_1" ,    "ENH1_2"   ,  "ENH1_3" ,    "ENH2_4" ,    "ENH2_5"    ,"ENH2_6", "DEG1_1",     "DEG1_2"  ,   "DEG1_3"   ,  "DEG2_4" ,    "DEG2_5"   ,  "DEG2_6"))


ggplot(data = cover_statuslf_matrix %>% filter((lifeform == 'shrub')) %>% filter((status == 'native')), 
     aes(x = site_rep, y = percentcover*100, fill = standtype)) +
   geom_col(color = "black") +
  scale_fill_manual(values = standcolors) +
  labs(x = "Transect", y = "Shrub Cover (%)", title = "Shrub Cover by Transect") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate x-axis labels by 45 degrees

```

```{r SHRUB scatterplot, include = TRUE}
# The arguments to spread():
# - data: Data object
# - key: Name of column containing the new column names
# - value: Name of column containing values
cover_statuslf_matrix$status_lifeform <- paste(cover_statuslf_matrix$status, cover_statuslf_matrix$lifeform, sep="_") # combine status and life form to one column
cover_statuslf_matrix_long <- cover_statuslf_matrix %>%
 dplyr::select(standtype, site_rep, percentcover, status_lifeform)
view(cover_statuslf_matrix_long)



# scatterplot - shrub x nn grass
shub_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1, 
       aes(x = nonnative_grass*100, y = native_shrub*100)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native shrub cover (%)", 
       title = "Native Shrub Cover by Non-native Grass Cover") +
  theme_bw() +  
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

shub_grass_scatter_print <- shub_grass_scatter+ theme(legend.position = c(0.15, 0.2))

ggsave("Ch1_Degradation_figures/shub_grass_scatter_print.png", shub_grass_scatter_print, width = 8, height = 6)

```

### - FORB

```{r forb native percent cover by site_rep, include=TRUE}

# FORB
cover_statuslf_matrix %>% 
  filter(lifeform == 'forb') %>% 
  group_by(site_rep, status) 

cover_statuslf_matrix %>% 
  filter(lifeform == 'forb' & status == "native") %>% 
  group_by(site_rep) 

cover_statuslf_matrix %>% 
  filter(lifeform == 'forb' & status == "nonnative") %>% 
  group_by(site_rep) 
```

```{r scatterplot forb native percent cover, include = TRUE}
# scatterplot - forb x nn grass
natforb_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1,
              aes(x = nonnative_grass*100, y = native_forb*100)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native forb cover (%)", 
       title = "Native forb cover by non-native grass cover") +
  theme_bw() +
   stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

# scatterplot - nnforb x nn grass
nnforb_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1,
              aes(x = nonnative_grass*100, y = nonnative_forb*100)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm, gam
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Non-native forb cover (%)", 
       title = "Non-native forb cover by non-native grass cover") +
  theme_bw() +
   stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

natforb_grass_scatter_print <- natforb_grass_scatter + theme(legend.position = c(0.15, 0.8))
nnforb_grass_scatter_print <- nnforb_grass_scatter+ theme(legend.position = c(0.15, 0.8))

# print the plots into a single figure
grid.arrange(natforb_grass_scatter_print, nnforb_grass_scatter_print, ncol = 1, nrow = 2)

ggsave("Ch1_Degradation_figures/natforb_grass_scatter.png", natforb_grass_scatter_print, width = 8, height = 6)
ggsave("Ch1_Degradation_figures/nnforb_grass_scatter.png", nnforb_grass_scatter_print, width = 8, height = 6)
```

```{r forb stats percent cover by site}

# FORB
abcover_bylf_bystatus_aov_forb <- aov(percentcover ~ standtype * status, data = cover_statuslf_matrix %>% filter((lifeform == 'forb')))

print(summary(abcover_bylf_bystatus_aov_forb))

print(TukeyHSD(abcover_bylf_bystatus_aov_forb))
## forb - native
abcover_bylf_bystatus_aov_forbnat <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'forb')) %>% filter((status == 'native')))
print(summary(abcover_bylf_bystatus_aov_forbnat))
# Df  Sum Sq  Mean Sq F value Pr(>F)
#standtype    2 0.00512 0.002558   0.905   0.43
#Residuals   12 0.03391 0.002826  
print(TukeyHSD(abcover_bylf_bystatus_aov_forbnat))
#$standtype
#                      diff         lwr       upr     p adj
#intact-degraded 0.02845528 -0.07182408 0.1287347 0.7352620
#matrix-degraded 0.04065041 -0.04122735 0.1225282 0.4091252
#matrix-intact   0.01219512 -0.08808424 0.1124745 0.9438944 
# NO SIG differences
# forb - nonnative
abcover_bylf_bystatus_aov_forbnn <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'forb')) %>% filter((status == 'nonnative')))
print(summary(abcover_bylf_bystatus_aov_forbnn))
#    Df Sum Sq Mean Sq F value   Pr(>F)    
#standtype    2 0.6180 0.30901    13.3 0.000904 ***
#Residuals   12 0.2789 0.02324    
print(TukeyHSD(abcover_bylf_bystatus_aov_forbnn))
#$standtype
#                      diff        lwr        upr     p adj
#intact-degraded -0.5081301 -0.7957264 -0.2205337 0.0013474 <-- Int - Deg
#matrix-degraded -0.3373984 -0.5722198 -0.1025769 0.0062271 <-- Mat - Deg
#matrix-intact    0.1707317 -0.1168647  0.4583281 0.2896736

```

### - GRASS

```{r grass}
# GRASS
abcover_bylf_bystatus_aov_grass <- aov(percentcover ~ standtype * status, data = cover_statuslf_matrix %>% 
                                   filter((lifeform == 'grass')))
print(summary(abcover_bylf_bystatus_aov_grass))
print(TukeyHSD(abcover_bylf_bystatus_aov_grass))
## grass - native
abcover_bylf_bystatus_aov_grassnat <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'grass')) %>% filter((status == 'native')))
print(summary(abcover_bylf_bystatus_aov_grassnat))
# print(summary(abcover_bylf_bystatus_aov_grassnat))
#            Df Sum Sq Mean Sq F value   Pr(>F)    
#standtype    2 0.6728  0.3364   30.36 2.02e-05 ***
#Residuals   12 0.1330  0.0111  
print(TukeyHSD(abcover_bylf_bystatus_aov_grassnat))
#$standtype
#                       diff         lwr        upr     p adj
#intact-degraded  0.56097561  0.36240594  0.7595453 0.0000191 <-- Int - Deg
#matrix-degraded  0.07723577 -0.08489569  0.2393672 0.4370582
#matrix-intact   -0.48373984 -0.68230951 -0.2851702 0.0000808 <-- Int - Mat
# SIG MORE native grass at Intact
# nonnative
abcover_bylf_bystatus_aov_grassnn <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'grass')) %>% filter((status == 'nonnative')))
print(summary(abcover_bylf_bystatus_aov_grassnn))
#            Df Sum Sq Mean Sq F value   Pr(>F)    
#standtype    2 1.3178  0.6589   55.46 8.66e-07 ***
#Residuals   12 0.1426  0.0119 
print(TukeyHSD(abcover_bylf_bystatus_aov_grassnn))
#$standtype
#                      diff        lwr         upr     p adj
#intact-degraded -0.8089431 -1.0145691 -0.60331712 0.0000006 <-- 
#matrix-degraded -0.2195122 -0.3874051 -0.05161929 0.0115409 <--
#matrix-intact    0.5894309  0.3838049  0.79505687 0.0000165 <-- 
# SIG different non-native grass among sites



# scatterplot - nnforb x nn grass
natgrass_grass_scatter <- ggplot(data = cover_statuslf_matrix_wide1,
              aes(x = nonnative_grass*100, y = native_grass*100, color = standtype)) + #color = standtype
  geom_point(size = 3, alpha = 0.8) +
  ylim(0, 100)+
  xlim(0,100) +
  geom_smooth(method = "lm", se = FALSE, linetype = "solid", color = "black") +  # lm, loess, glm, gam
  scale_color_manual(values = c(standcolors),
                     name = "Stand Type",
                     labels = c("intact" = "shrub dominated", 
                                "matrix" = "matrix", 
                                "degraded" = "grass dominated")) + #rename standtypes labels
  labs(x = "Non-native grass cover (%)", 
       y = "Native grass cover (%)", 
       title = "Native grass cover by non-native grass cover") +
  theme_bw()

natgrass_grass_scatter_print <- natgrass_grass_scatter + theme(legend.position = c(0.8, 0.8))

ggsave("Ch1_Degradation_figures/natgrass_grass_scatter_print.png", natgrass_grass_scatter_print, width = 8, height = 6)

```

```{r fern}
# FERN
abcover_bylf_bystatus_aov_fern <- aov(percentcover ~ standtype * status, data = cover_statuslf_matrix %>% 
                                   filter((lifeform == 'fern')))
print(summary(abcover_bylf_bystatus_aov_fern))
print(TukeyHSD(abcover_bylf_bystatus_aov_fern))
## fern - native
abcover_bylf_bystatus_aov_fernnat <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'fern')) %>% filter((status == 'native')))
print(summary(abcover_bylf_bystatus_aov_fernnat))
print(TukeyHSD(abcover_bylf_bystatus_aov_fernnat))
#$standtype <-- can't really do stats on only one occurrence
#                         diff          lwr         upr   p adj
#intact-degraded  8.130081e-03 -0.002714893 0.018975056 0.15458 
#matrix-degraded  1.662443e-18 -0.008854884 0.008854884 1.00000
#matrix-intact   -8.130081e-03 -0.018975056 0.002714893 0.15458
# nonnative
abcover_bylf_bystatus_aov_fernnn <- aov(percentcover ~ standtype, data = cover_statuslf_matrix %>% filter((lifeform == 'fern')) %>% filter((status == 'nonnative')))
print(summary(abcover_bylf_bystatus_aov_fernnn))
print(TukeyHSD(abcover_bylf_bystatus_aov_fernnn))

abcover_bylf_bystatus_meanSD <- cover_statuslf_matrix %>%  
  group_by(lifeform, status, standtype) %>% 
  summarize(avg_cover = mean(percentcover), 
            sd = sd(percentcover),
            N = length(percentcover), 
            se = ((sd(percentcover))/sqrt(length((percentcover)))))

abcover_bylf_bystatus_meanSD$status_lifeform <- paste(abcover_bylf_bystatus_meanSD$status, abcover_bylf_bystatus_meanSD$lifeform, sep="_") # combine status and life form to one column
print(abcover_bylf_bystatus_meanSD) 
```

```{r percent cover x nn grass combine, include = TRUE}

# print the plots into a single figure
nncover_combined <- grid.arrange(shub_grass_scatter_print, natgrass_grass_scatter_print, natforb_grass_scatter_print, nnforb_grass_scatter_print, ncol = 2, nrow = 2,
  heights = c(1, 1),  # Adjust the height ratios between rows
  widths = c(1, 1)     # Adjust the width ratios between columns
)

ggsave("Ch1_Degradation_figures/nncover_combined.png", nncover_combined, width = 15, height = 10)
```

### - STATS

```{r plot abcover_bylf_meanSD, include = TRUE}
# line 965 in Ch1_Degradation_original.Rmd

#  column plot, 2 x 2 by lifeform
abcover_bylf_bystatus_meanSD_plot_wrap <- ggplot(abcover_bylf_bystatus_meanSD, aes(x = status, y = avg_cover, fill = standtype )) +
  facet_wrap(~ lifeform) +
  geom_col(position = "dodge", width = 0.8) +
  geom_errorbar(aes(ymin=avg_cover-se, ymax=avg_cover+se), width=.2,
                 position=position_dodge(.9)) +
  labs(title = "Percent Cover by status and standtype", x = "Status", y = "Average Percent Cover (%)") +
  scale_fill_manual(values = c(standcolors)) + # manual colors
#   scale_fill_manual(values = cal_palette('chaparral3')) + # continuous colors
                       theme_bw()

abcover_bylf_bystatus_meanSD_plot_wrap + scale_x_discrete(limits=c("intact", "matrix", "degraded"),
                                         labels=c("intact" = "Intact", "matrix" = "Matrix", "degraded" = "Degraded"))


```
