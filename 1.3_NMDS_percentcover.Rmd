---
title: "canopy_NMDS"
author: "Stephanie Ma Lucero"
date: "2024-02-18"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### library
```{r install libraries, message=FALSE}

library(tidyverse) # includes ggplot2 - data visulization, dplyr, tidyr, readr, purr, tibble, stringr, forcats
library(ggpubr) # customize ggplot2 for publication
library(broom)
library(AICcmodavg)
library(vegan)
library(readxl) # for .xls and .xlsx sheets
library(janitor)
library(calecopal) 
library(multcompView)
library(plotly)
if (!require(devtools)) {
  install.packages("devtools")
}
devtools::install_github("gavinsimpson/ggvegan")
library(here)
library(ggpmisc)
```

# colors
```{r colors, include=TRUE}
devtools::install_github("an-bui/calecopal")

library(calecopal)
# names(cal_palettes) 
### chaparral1, chaparral2, chaparral3

cal_palette(name = "chaparral3", n = 3, type = "continuous") 
# site colors
site1 <- "#DCC27A" 
site2 <-  "#D98A63"
intact <- "#92A587" 

# group_3 colors
cal_palette(name = "grassdry", n = 5, type = "continuous") 
grass <- "#E1BC8D" 
css <- "#66512A" 
chap <- "#4C5454"

# 
# #species colors
# HEAR <- "#D3E3CA"
# RHOV <- "#92A587"
# RHIL <- "#2F3525"
# 
# MAFA <- "gray60"
# SALE <- "gray40"
# ARCA <- "gray20"
# 
# scl <- 16
# css <- 17
# 
# colors_scl <- c(HEAR, RHOV, RHIL)
# colors_css <- c(MAFA, SALE, ARCA)
# 
# # Lifeform colors: shrub, grass, forb
# shrub <- "green4"
# grass <- "yellow2"
# forb <- "purple2"
# fern <- "black"
# colors_lifeform <- c(shrub, grass, forb, fern)
# 
# # Status colors: native, exotic 
# native <- "black"
# nonnative <- "maroon"
# unknown <- "lightblue"
# colors_status <- c(native, nonnative, unknown)

# "orange", "lightblue", "limegreen", "deeppink","mediumpurple2", "darkgreen"
```

_Useful code_
- names() = column titles
- head()
- tail()
- sort(unique(df$column))
- class() = tibble or data.frame?
_ _italics_
- __bold__ 


# Load data
- Cleaned transect data was completed  in 1_transect_continuous.Rmd, ~line 1-300
- In the 2019 data, I renamed "Bromus spp." to unique Bromus species based on the surrounding Bromus species - aug 10, 2024 SML

```{r load clean point intercept transect data from csv, include=TRUE}
abcover_charateristics_load <- read.csv("processed/ab_specieslistwithcharateristics_08102024.csv", header = TRUE, na.strings=c("","NA")) %>% 
  select(!c(X)) 

# view(abcover_charateristics_load)
# sort(unique(abcover_charateristics_load$site_rep))

length(unique(abcover_charateristics_load$site_rep))
str(abcover_charateristics_load)
sort(unique(abcover_charateristics_load$species))

groups_load <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022/chaparraldegradation_2022/Extracted_Elevation_Slope_Aspect_Hillshade_20m.csv", header = TRUE, na.strings=c("","NA")) 

groups <- groups_load %>% 
  dplyr::select(!c(system.index, ID, aspect, elevation, hillshade, slope, site, fire_history, southwestness, twi, .geo, lat, long)) %>% 
  rename(site_rep = system_ind) %>% 
  mutate(site_rep = case_when(site_rep == "INT1" ~ "INT1.1", # old name ~ new name
                              site_rep == "INT2" ~ "INT2.1",
                              site_rep == "INT3" ~ "INT3.1",
                              site_rep == "INT4" ~ "INT4.1",
                              site_rep == "INT5" ~ "INT5.1",
                                  TRUE ~ site_rep))   %>% 
  mutate(site_rep = case_when(site_rep == "1.1" ~ "1.10", # old ~ new
                                 site_rep == "2.1" ~ "2.10",
                                 site_rep == "2.2" ~ "2.20",
                                   TRUE ~ site_rep)) %>% 
   mutate(
      site_rep = as.character(site_rep),
      group_15 = as.character(group_15),
      group_3 = as.character(group_3),
      group_10 = as.character(group_10),
      group_6 = as.character(group_6),
      group_4 = as.character(group_4),
      group_2 = as.character(group_2)
      ) %>% 
  as_tibble()

# names(groups)
# length(groups$site_rep)     # n = 40
```

- omit "ground" to isolate vegetation species 
```{r omit groundcover, include=TRUE}
abcover_full_v_omitground <- abcover_charateristics_load %>% 
  filter(!(species %in% c("bare_ground", "moss", "rock", "litter", "thatch", "no_species"))) %>% 

  mutate(species = case_when( 
                      # replace "dead" to "alive" for perennial species
                             species == "Acmispon glaber dead" ~ "Acmispon glaber", # old name ~ new name
                             species == "Artemisia californica dead" ~ "Artemisia californica",
                             species == "Ceanothus oliganthus dead" ~ "Ceanothus oliganthus",
                             species == "Elymus condensatus dead" ~ "Elymus condensatus",
                             species == "Heteromeles arbutifolia dead" ~ "Heteromeles arbutifolia",
                             species == "Malacothamnus fasciculatus dead" ~ "Malacothamnus fasciculatus",
                             species == "Marah macrocarpa dead" ~ "Marah macrocarpa",
                             species == "Rhamnus ilicifolia dead" ~ "Rhamnus ilicifolia",
                             species == "Salvia leucophylla dead" ~ "Salvia leucophylla",
                             species == "Stipa lepida dead" ~ "Stipa lepida",
                      # combine Erodium to Erodium spp.          
                             species == "Erodium cicutarium" ~ "Erodium spp.", 
                      # keep Bromus species separate    
                             # species == "Bromus diandrus" ~ "Bromus spp.",
                             # species == "Bromus hordeaceus" ~ "Bromus spp.",
                             # species == "Bromus rubens" ~ "Bromus spp.",
                              TRUE ~ species))

# sort(unique(abcover_full_v_omitground$species))
# glimpse(abcover_full_v_omitground)
```

# Calculate percent cover of species by transect 
- identify the unique species at each site_rep_dist to get rid of duplicate species recordings. (e.g., Present at one distance = 1/41 to get percent cover) 
```{r calculate spp percent cover per transect, inclue = TRUE}

abcover_byspecies <- abcover_full_v_omitground %>% 
  group_by(site, site_rep, species) %>% 
  dplyr::summarize(
    count_per_transect = sum(n_distinct(site_rep_dist)), 
    percentcover = (count_per_transect/41)
    ) %>% 
  dplyr::select(!c(count_per_transect)) %>% 
  mutate(site_rep = gsub("_", ".", site_rep)) %>% 
  mutate(site_rep = case_when(site_rep == "1.1" ~ "1.01", # old name ~ new name
                        site_rep == "1.2" ~ "1.02",
                        site_rep == "1.3" ~ "1.03",
                        site_rep == "1.4" ~ "1.04",
                        site_rep == "1.5" ~ "1.05",
                        site_rep == "1.6" ~ "1.06",
                        site_rep == "1.7" ~ "1.07",
                        site_rep == "1.8" ~ "1.08",
                        site_rep == "1.9" ~ "1.09",
                        site_rep == "2.1" ~ "2.01",
                         site_rep == "2.2" ~ "2.02", 
                         site_rep == "2.3" ~ "2.03",
                         site_rep == "2.4" ~ "2.04",
                         site_rep == "2.5" ~ "2.05",
                         site_rep == "2.6" ~ "2.06",
                         site_rep == "2.7" ~ "2.07",
                         site_rep == "2.8" ~ "2.08",
                         site_rep == "2.9" ~ "2.09",
   TRUE ~ site_rep))

```

```{r left join percent cover and twinspan groups, include=TRUE}

abcover_byspecies_groups <- abcover_byspecies %>% 
  left_join(groups, by = "site_rep")

class(abcover_byspecies)
class(groups)

# view(abcover_byspecies_groups)
length(unique(abcover_byspecies_groups$site_rep))

```
```{r cover for group_15}
# cover_group15 <- abcover_byspecies_groups %>% 
#   dplyr::select(site, site_rep, species, percentcover, group_15)
```

# Prepare data for an NMDS
```{r transpose percent cover data by species, include=TRUE}

abcover_byspecies_nmdsprep <- abcover_byspecies_groups %>% 
  tidyr::spread(species, percentcover) %>% # transpose data so columns are species
  replace(is.na(.), 0) # replace NA with zeros

#glimpse(abcover_byspecies_nmdsprep)

abcover_byspecies_nmdsprep_num <- abcover_byspecies_nmdsprep %>% 
  # use the ungroup() function to take out grouping
  ungroup() %>% 
  dplyr::select(!c(site, site_rep, group_15, group_3, group_10, group_6, group_4, group_2)) 
         
# glimpse(abcover_byspecies_nmdsprep_num) # only numbers
```


# NMDS
```{r nmds by species percent cover}

# the AUTOTRANSFORM = F skips the automatic data transformations and uses the input data as is
# - when the raw data contains the information you need (e.g., abundance)
# - when you have a small number of samples or small number of variables
# - when you want to preserve the original scale of the data (e.g., interested in the absolute differences betwen two sets of measurements)

abcover_byspecies_NMDS <- metaMDS(abcover_byspecies_nmdsprep_num,
                                  autotransform = F, # or T
                                  distance = "bray",   # bray or "raup"
                  k = 2, #dimentions
                 try = 100, #runs
                 trymax = 100) # this is more appropriate for my data


# uses the RAUP-CRICK dissimilarity index to calculate pairwise dissimilarities
# - adjusts for spp richness
# - downweights importance of rare spp 
# - more useful when interested in community STRUCTURE rather than individual species
# - takes into account differences in species evenness
# abcover_byspecies_NMDS <- metaMDS(abcover_byspecies_nmdsprep_num, distance = "raup") 
abcover_byspecies_NMDS
```

### stress test
```{r stress tests nmds}
stressplot(abcover_byspecies_NMDS)
# if stress tests are really low ==> I may have insufficient data. :/

plot(abcover_byspecies_NMDS)
ordiplot(abcover_byspecies_NMDS, type = "p")
ordiplot(abcover_byspecies_NMDS, type = "t")
# ab_nmds.fort <- fortify(as.data.frame(abcover_byspecies_NMDS))
```

```{r scores nmds}

scores(abcover_byspecies_NMDS)

# plot_df <- scores(abcover_byspecies_NMDS, display = "sites") %>% # from An's code
#  as.data.frame() %>%
#  rownames_to_column("stand_core") %>%
#  full_join(seedbank_bysitecore, by = "stand_core")

nmds_above_df <- data.frame(abcover_byspecies_NMDS$points, abcover_byspecies_nmdsprep) %>%  # join NMDS scores and percent cover by species, including columns: site, site_rep, and count_per_transect
    mutate(group_3 = factor(
     group_3, levels = c("chaparral", "css", "grass")
    )
  ) %>% 
  mutate(group_2 = factor(
     group_2, levels = c("HEAR", "no HEAR")
    )
  ) %>% 
   mutate(group_4 = factor(
     group_4, levels = c("HEAR+CEOL", "HEAR", "SALE+MAFA+ARCA", "PHHU")
    )
  ) %>% 
   mutate(group_6 = factor(
     group_6, levels = c("HEAR+CEOL", "HEAR", 
                         "SALE+MAFA+ARCA+STLE+CEME", 
                         "SALE+MAFA+ARCA+HIIN",
                         "PHHU", "PHHU+RARU")
    )
  ) %>% 
     mutate(group_10 = factor(
     group_10, levels = c("HEAR+CEOL", "HEAR", 
                         "SALE+MAFA+ARCA+STLE+CEME+BRDI",
                         "SALE+MAFA+ARCA+STLE+CEME+Erodium_spp.",
                         "SALE+MAFA+ARCA+HIIN+BRHO+CEME",
                         "SALE+MAFA+ARCA+HIIN+Erodium_spp.",
                         "PHHU",
                         "PHHU+BRDI",
                         "PHHU+ARCA",
                         "PHHU+RARU")
    )
  ) %>% 
     mutate(group_15 = factor(
     group_15, levels = c("1", "2", 
                         "3",
                         "4",
                         "5",
                         "6",
                         "7",
                         "8",
                         "9",
                         "10", "11", "12", "13", "14", "15")
    )
  ) 
  
head(nmds_above_df)
```

# figure 
### - nmds x group_15
```{r ggplot percent cover by species}

nmds_ab_group15_points <- ggplot(nmds_above_df, 
                                  aes(x = MDS1, y = MDS2, color = group_15, shape = group_3)) +
  geom_point(size = 5, alpha = 0.8) +
  theme_bw() +
  labs(title = "NMDS of species percent cover grouped by twinspan groups (n = 15) ", color = "Group_15")
nmds_ab_group15_points
# ggsave("Ch1_Degradation_figures/nmds_group15_points.png", nmds_ab_group15_points, width = 8, height = 6)


nmds_ab_group15_ellipses <- ggplot(nmds_above_df, 
                                  aes(x = MDS1, y = MDS2, color = group_15, shape = group_3)) +
  geom_point(size = 5, alpha = 0.8) +
  # scale_shape_manual(values = c(16, 17, 1, 2, 3, 4, 5)) + 
  #scale_color_manual(values = c(chap, chap, css, css, css, css, css, css, css, css, css, grass, grass, grass,grass,grass)) + # in bw
  theme_bw() +
 # theme(legend.position = c(0.1, 0.85)) + # x, y left corner: 0,0
  stat_ellipse(level = .95, linetype = 2, linewidth = 1) +
  labs(title = "NMDS of species percent cover grouped by twinspan groups (n = 15) ", color = "Group_15")
nmds_ab_group15_ellipses
 # 9 groups don't have enough data points to run ellipses on
 # 6 groups have enough data points --> 6 ellipses! --> Groups: chap = 2, css = 5, 8, 9, grass = 11, 13
# ggsave("Ch1_Degradation_figures/nmds_group15_ellipses.png", nmds_ab_group15_ellipses, width = 8, height = 6)

nmds_ab_group15_scale <- ggplot(nmds_above_df, 
                                  aes(x = MDS1, y = MDS2, color = group_15, shape = group_3)) +
  geom_point(size = 5, alpha = 0.8) +
  theme_bw() +
   scale_color_manual(values = c("gray1", "green", "gray10", "gray15", "maroon4", "gray25", "gray30","deeppink2", "pink", "gray50", "thistle2", "gray70", "goldenrod", "gray90", "gray95")) +
  stat_ellipse(level = .95, linetype = 2, linewidth = 1) +
  labs(title = "NMDS of species percent cover grouped by twinspan groups (n = 15) ", color = "Group_15")
nmds_ab_group15_scale





```


### p values
```{r nmds color and vectors with envfit function}
# code from An Bui: https://rpubs.com/an-bui/vegan-cheat-sheet 

abcover_byspecies_nmdsprep <- abcover_byspecies_nmdsprep %>%  
  mutate(standtype_ID = 1) # create a new column named standtype_ID
abcover_byspecies_nmdsprep$standtype_ID <- 1:40 # populate the standtype_ID column with numnbers 1-40

plot_above_df <- scores(abcover_byspecies_NMDS, display = "sites") %>% 
  as.data.frame() %>% 
 rownames_to_column("standtype_ID") %>% 
  mutate_at(c('standtype_ID'), as.numeric) %>% 
  full_join(abcover_byspecies_nmdsprep, by = "standtype_ID") %>% 
  dplyr::select(!c(standtype_ID)) %>% 
    mutate(group_3 = factor(
     group_3, levels = c("chaparral", "css", "grass")
    )
  ) %>% 
  mutate(group_2 = factor(
     group_2, levels = c("HEAR", "no HEAR")
    )
  ) %>% 
   mutate(group_4 = factor(
     group_4, levels = c("HEAR+CEOL", "HEAR", "SALE+MAFA+ARCA", "PHHU")
    )
  ) %>% 
   mutate(group_6 = factor(
     group_6, levels = c("HEAR+CEOL", "HEAR", 
                         "SALE+MAFA+ARCA+STLE+CEME", 
                         "SALE+MAFA+ARCA+HIIN",
                         "PHHU", "PHHU+RARU")
    )
  ) %>% 
     mutate(group_10 = factor(
     group_10, levels = c("HEAR+CEOL", "HEAR", 
                         "SALE+MAFA+ARCA+STLE+CEME+BRDI",
                         "SALE+MAFA+ARCA+STLE+CEME+Erodium_spp.",
                         "SALE+MAFA+ARCA+HIIN+BRHO+CEME",
                         "SALE+MAFA+ARCA+HIIN+Erodium_spp.",
                         "PHHU",
                         "PHHU+BRDI",
                         "PHHU+ARCA",
                         "PHHU+RARU")
    )
  ) %>% 
     mutate(group_15 = factor(
     group_15, levels = c("1", "2", 
                         "3",
                         "4",
                         "5",
                         "6",
                         "7",
                         "8",
                         "9",
                         "10", "11", "12", "13", "14", "15")
    )
  ) 
  

# view(plot_above_df)

# envfit() takes the output of metaMDS() and the species matrix you created
fit_above <- envfit(abcover_byspecies_NMDS, abcover_byspecies_nmdsprep, perm = 999) # pvalues for spp and stand, site, stand_core

# extract p-values for each species
fit_above_pvals <- fit_above$vectors$pvals %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  dplyr::rename("pvals" = ".") %>% 
  filter(!c(species == "standtype_ID"))
#view(fit_above_pvals)

# extract coordinates for species, only keep species with p-val = 0.05
fit_above_spp <- fit_above %>% 
  scores(., display = "vectors") %>% 
  as.data.frame() %>% 
  rownames_to_column("species") %>% 
  full_join(., fit_above_pvals, by = "species") %>% 
  filter(pvals <= 0.001) %>%  # <-- p-value 
  filter(!species == 'standtype_ID')
length(fit_above_spp$species) #  <- limited number for visual clarity

fit_above_spp_p005 <- fit_above %>%
  scores(., display = "vectors") %>%
  as.data.frame() %>%
  rownames_to_column("species") %>%
  full_join(., fit_above_pvals, by = "species") %>%
   filter(pvals <= 0.05) %>%
  filter(!species == 'standtype_ID') #%>%
  # left_join((abcover_charateristics %>%
  #               distinct(species, .keep_all = TRUE) %>%
  #              dplyr::select(species, lifeform, status, lifecycle, family)
  #            ), by = "species")
# write.csv(fit_above_spp_p005, "~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022/chaparraldegradation_2022/processed/percentcover_nmds_pvalues.csv")
```

### - nmds x transect w/ species
```{r nmds by transect with species percent cover}

nmdsabove_plot_site_rep <- ggplot(plot_above_df, 
                                  aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  #xlim(-1.5,1.5) +
 # ylim(-1.5,1.5) +
  geom_point(aes(color = Hillslope, shape = Hillslope), size = 3, alpha = 0.8) +
  #stat_ellipse(aes(color = site_rep)) +
  scale_color_manual(values = c( "lightblue", "cornflowerblue", "blue","green", "darkgreen", "orange", "brown")) + #"gray0",
   scale_shape_manual(values = c(17, 17, 17, 15, 15, 16,16)) + 
  # labs(name = "Hillslope",
  #                    labels = c("DEG1" = "Shrub dominated", 
  #                               "DEG2" = "Matrix", 
  #                               "ENH1" = "Grass dominated", 
  #                               "ENH2" = "Shrub dominated", 
  #                               "INT1" = "Matrix", 
  #                               "INT2" = "Grass dominated", 
  #                               "INT3" = "SH3")) + #rename standtypes labels
  geom_segment(data = fit_above_spp, 
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = fit_above_spp, aes(label = species),  
            position = position_jitter(width = 0.0, height = 0.0)) +
  theme_bw()


nmds.1 <- ggplot(plot_above_df, aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  geom_point(aes(color = group_15, shape = group_3), size = 3, alpha = 0.8) + 
  stat_ellipse(aes(color = group_15), level = 0.95, linetype = 1, linewidth = 0.5) +
  geom_segment(data = fit_above_spp, # <- p values
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = fit_above_spp, aes(label = species),  
            position = position_jitter(width = 0.1, height = 0.1)
            ) +
  theme_bw() +
  labs(title = "NMDS of species percent cover grouped by twinspan groups (n = 15) ", color = "Group_15")
#+
  # theme(legend.position = c(0.125, 0.825))
nmds.1
nmds.1
nmds.1
nmds.1
nmds.1
nmds.1
nmds.1
# ggsave("Ch1_Degradation_figures/nmds_transectbyspecies.png", nmds.1, width = 8, height = 6)
# ggsave("Ch1_Degradation_figures/nmds_transectbyspecies_simplified.png", nmds.1, width = 8, height = 6)
```

# EXTRA CODE BELOW 

```{r}
# nmds - by site_rep (aka. hillslope)
nmdsabove_plot_site_rep <- ggplot(plot_above_df, 
                                  aes(x = NMDS1, y = NMDS2)) +
  coord_fixed() +
  #xlim(-1.5,1.5) +
 # ylim(-1.5,1.5) +
  geom_point(aes(color = Hillslope, shape = Hillslope), size = 3, alpha = 0.8) +
  #stat_ellipse(aes(color = site_rep)) +
  scale_color_manual(values = c( "lightblue", "cornflowerblue", "blue","green", "darkgreen", "orange", "brown")) + #"gray0",
   scale_shape_manual(values = c(17, 17, 17, 15, 15, 16,16)) + 
  # labs(name = "Hillslope",
  #                    labels = c("DEG1" = "Shrub dominated", 
  #                               "DEG2" = "Matrix", 
  #                               "ENH1" = "Grass dominated", 
  #                               "ENH2" = "Shrub dominated", 
  #                               "INT1" = "Matrix", 
  #                               "INT2" = "Grass dominated", 
  #                               "INT3" = "SH3")) + #rename standtypes labels
  geom_segment(data = fit_above_spp, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")),
               col = "black") +
  geom_text(data = fit_above_spp, aes(label = species),  
            position = position_jitter(width = 0.0, height = 0.0)) +
  theme_bw()
nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
# nmdsabove_plot_site_rep
ggsave("Ch1_Degradation_figures/nmds_above_vectors.png", nmdsabove_plot_site_rep, width = 8, height = 6)
```





```{r byplot - ggplot vectors and measurments, include = FALSE}

#this makes a dataframe that gives a lot of control graphically 
abcover_byspecies_NMDS_fort <- fortify(abcover_byspecies_NMDS)

# vectors AND measurments
abcover_byspecies_NMDS_fortplot <- ggplot() + 
  geom_point(data = subset(abcover_byspecies_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2, group = ""),
             color = 'black',
             size = 4,
             alpha = 1) +
  geom_segment(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1), 
            position = position_jitter(width = 0.2, height = 0.2)) +
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", linewidth = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
abcover_byspecies_NMDS_fortplot

#only vectors shown
abcover_byspecies_NMDS_fortplot1 <- ggplot() + 
  geom_point(data = subset(abcover_byspecies_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0) +
  geom_segment(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1),
            position = position_jitter(width = 0.9, height = 0.9)) +
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
abcover_byspecies_NMDS_fortplot1

#only measurements shown
abcover_byspecies_NMDS_fortplot2 <- ggplot() + 
  geom_point(data = subset(abcover_byspecies_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0.5) +
  geom_segment(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               size = 0.8,
               alpha = 0) +
  geom_text(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1),
            position = position_jitter(width = 0.2, height = 0.2),
            alpha = 0)+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", size = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
abcover_byspecies_NMDS_fortplot2

#interactive plots that I like
ggplotly(abcover_byspecies_NMDS_fortplot)

#show both plots 
hi_above <- ggarrange(nmds_above_df_plotcolor, abcover_byspecies_NMDS_fortplot, ncol = 1)
hi_above

```



NMDS
NMDS
NMDS by Plots! to determine which species are driving transect disimiliarity. 

(5) Identify the unique species at each site_rep_dist to get rid of duplicate species recordings. (e.g., Present at one distance = 1/41 to get percent cover) 
```{r ab percent cover unby species, inclue = TRUE}

abcover_byplot_groups <- abcover_full_v_omitground %>% 
  select(c(standtype, site, site_rep, species))
head(abcover_byplot_groups)

abcover_byplot_prep <- abcover_full_v_omitground %>% 
  group_by(standtype, site, site_rep, species) %>% 
  filter(site_rep != "Intact4_4") %>% #omit Intact 4 from data
  filter(!is.na(species)) %>% # omit blank cells in species 
  dplyr::summarize(count_per_dist = n_distinct(site_rep_dist), percentcover = n_distinct(site_rep_dist)/41) 
  
view(abcover_byplot_prep) # prints to new tab

abcover_byplot <- abcover_byplot_prep %>% 
  select(c(site_rep, species, percentcover))

write.csv(abcover_byplot, "~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/processed/abcover_byplot.csv")

abcover_byplot_load <- read.csv("~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/processed/abcover_byplot_onlysite_repsppcover.csv", header = TRUE, na.strings=c("","NA"))
```


(6) Prepare data for an NMDS (percent cover x species x standtype)
```{r transpose percent cover data by species, include=TRUE}

# use this for GROUPS: abcover_byplot_nmdsprep

head(abcover_byplot_load)

abcover_byplot_nmdsprep <- abcover_byplot_load %>% 
  tidyr::spread(site_rep, percentcover) %>% # transpose data so columns are species
  replace(is.na(.), 0) # replace NA with zeros
view(abcover_byplot_nmdsprep)
dim(abcover_byplot_nmdsprep)

abcover_byplot_nmdsprep_num <- abcover_byplot_nmdsprep %>% 
  # use the ungroup() function to take out grouping
  ungroup() %>% 
  select(!c(species))
# 33 species (rows) by 15 sites (columns)
# DEG 1-6, ENH 1-6, INT 1-3 = 15 transects
dim(abcover_byplot_nmdsprep_num)
```

```{r write nmds to csv}
view(abcover_byplot_nmdsprep_num) # only numbers
write.csv(abcover_byplot_nmdsprep_num, "~/Dropbox/GRADSCHOOL/Dissertation/R_dissertation/chaparraldegradation_2022b/processed/nmds_aboveground.csv")
```

(7) NMDS 
```{r stress tests}
# USE THIS ONE!

# str(seedbank_bysitecore_nmdsprep_num)
# stand_core_depth -->  tibble [89 × 52]

# stress test, will run 20 times
seedbank_byplot_nmds <- metaMDS(abcover_byplot_nmdsprep_num, distance = "raup")

# stress test, will run 20 times
seedbank_byplot_nmds <- metaMDS(abcover_byplot_nmdsprep_num, autotransform = F)
```

```{r scores nmds}

scores(seedbank_byplot_nmds)

```


```{r stress test}

stressplot(seedbank_byplot_nmds)
# if stress tests are really low ==> I may have insufficient data. :/

#plot_df <- scores(seedbank_bysitecore_nmds, display = "sites") %>% # from An's code
#  as.data.frame() %>% 
#  rownames_to_column("stand_core") %>% 
#  full_join(seedbank_bysitecore, by = "stand_core")

nmds_df <- data.frame(seedbank_byplot_nmds$points, # unnamed column is species n = 33
                      abcover_byplot_nmdsprep) # from chatgpt
view(nmds_df)
```

```{r ggplot bw}
ggplot(nmds_df, aes(x = MDS1, y = MDS2, color = stand, shape = stand)) +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_manual(values = c("gray0", "gray30", "gray60")) +
  theme_bw() +
  stat_ellipse(linetype = 2, size = 1) +
  labs(title = "NMDS: by seed bank germination counts", color = "Stand type", shape = "Stand type")
```

```{r with vectors}

#this makes a dataframe that gives a lot of control graphically 
seedbank_byplot_nmds_fort <- fortify(seedbank_byplot_nmds)

# vectors AND measurments
seedbank_byplot_nmdsfortplot <- ggplot() + 
  geom_point(data = subset(seedbank_byplot_nmds_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0.5) +
  geom_segment(data = subset(seedbank_byplot_nmds_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(seedbank_byplot_nmds_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", linewidth = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#only vectors shown
seedbank_byplot_nmds_fortplot1 <- ggplot() + 
  geom_point(data = subset(seedbank_byplot_nmds_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0) +
  geom_segment(data = subset(seedbank_byplot_nmds_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(seedbank_byplot_nmds_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
seedbank_byplot_nmds_fortplot1
```
```{r plot measurements only }
#only measurements shown
seedbank_byplot_nmds_fortplot2 <- ggplot() + 
  geom_point(data = subset(seedbank_byplot_nmds_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0.5) +
  geom_segment(data = subset(seedbank_byplot_nmds_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               size = 0.8,
               alpha = 0) +
  geom_text(data = subset(seedbank_byplot_nmds_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1),
            alpha = 0)+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", size = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#interactive plots that I like
ggplotly(seedbank_bysitecore_nmds_fortplot)

#show both plots 
hi <- ggarrange(seedbank_bysitecore_nmds_fortplot1, seedbank_bysitecore_nmds_fortplot2, ncol = 1)
hi

```


```{r}

ggplot(nmds_df, aes(x = MDS1, y = MDS2)) +
  geom_point()+
  theme_bw() +
  stat_ellipse(linetype = 2, size = 1) +
  labs(title = "NMDS: by seed bank germination counts", color = "Stand type", shape = "Stand type")

#
ggplot(nmds_df, aes(x = MDS1, y = MDS2, color = stand, shape = stand)) +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_manual(values = c("gray0", "gray30", "gray60")) +
  theme_bw() +
  stat_ellipse(linetype = 2, size = 1) +
  labs(title = "NMDS: by seed bank germination counts", color = "Stand type", shape = "Stand type")
```

```{r ggplot color}
ggplot(nmds_df, aes(x = MDS1, y = MDS2, color = stand, shape = stand)) +
  geom_point(size = 3, alpha = 0.8) +
  scale_color_manual(values = c("darkgreen", "darkmagenta", "darkgoldenrod1")) +
  theme_bw() +
  #stat_ellipse(level = .95, linetype = 2, size = 1) +
  stat_ellipse(linetype = 2, size = 1) +
  labs(title = "NMDS: by seed bank germination counts", color = "Stand type", shape = "Stand type")


```



```{r}
# useful code on how to color code NMDS from YouTube: https://www.youtube.com/watch?v=h7OrVmT7Ja8&t=446s
# and how to group NMDS values: https://www.youtube.com/watch?v=Y0GI34S-ZMI

scores(abcover_byspecies_NMDS) # structure of the file, look at the points to get the matrix of numbers and columns (2 columns)
abcover_byspecies_NMDS$points # to get the points/values of MDS1 and MDS2
scores(abcover_byspecies_NMDS) # scores of your variables
plot(abcover_byspecies_NMDS)

abcover_byspecies_NMDS_centroid <- scores(abcover_byspecies_NMDS$species) %>% 
  as_tibble(rownames="species") %>% 
  inner_join(., abcover_byspecies_nmdsprep, by="species") %>% 
  group_by(standtype) %>% 
 summarize(axis1 = mean(MDS1),
            axis2 = mean(MDS2))

scores(abcover_byspecies_NMDS$species) %>% 
  as_tibble(rownames="species") %>% 
  inner_join(., abcover_bysite_nmdsprep, by="species") %>% 
  ggplot(aes(x=MDS1, y=MDS2, color=standtype)) +
  geom_point() +
  geom_point(data=abcover_byspecies_NMDS_centroid, aes(x=axis1, y=axis2, color=standtype),
             shape = 15, size = 5)

# How can I make interactive data points with call outs when I hover over them?
```

```{r FROM KIT - nmds by species percent cover using code from KIT}
# USE THIS ONE!

# stress test, will run 20 times
abcover_byspecies_NMDS <- metaMDS(abcover_byspecies_nmdsprep_num, 
                                  autotransform = F)
# stress tests are really low ==> I may have insufficient data. :/

stressplot(seedbank_byplot_nmds)
plot(seedbank_byplot_nmds)

#basic normal plot
ordiplot(abcover_byspecies_NMDS) # without point labels
ordiplot(abcover_byspecies_NMDS, type = "t") # with point labels

#ggvegan to make a quick nice plot
autoplot(abcover_byspecies_NMDS) # NMDS1 x NMDS2, Key = "Score": sites, species



#this makes a dataframe that gives a lot of control graphically 
abcover_byspecies_NMDS_fort <- fortify(abcover_byspecies_NMDS)

abcover_byspecies_NMDS_fortplot <- ggplot() + 
  geom_point(data = subset(abcover_byspecies_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0.5) +
  geom_segment(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", linewidth = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#only vectors shown
abcover_byspecies_NMDS_fortplot1 <- ggplot() + 
  geom_point(data = subset(abcover_byspecies_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0) +
  geom_segment(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#only measurements shown
abcover_byspecies_NMDS_fortplot2 <- ggplot() + 
  geom_point(data = subset(abcover_byspecies_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0.5) +
  geom_segment(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               size = 0.8,
               alpha = 0) +
  geom_text(data = subset(abcover_byspecies_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1),
            alpha = 0)+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", size = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#interactive plots that I like
ggplotly(abcover_byspecies_NMDS_fortplot)

#show both plots 
hi <- ggarrange(abcover_byspecies_NMDS_fortplot1, abcover_byspecies_NMDS_fortplot2, ncol = 1)
hi


ordiplot(abcover_byspecies_NMDS,type="n")
orditorp(abcover_byspecies_NMDS,display="species",col="red",air=0.01)
orditorp(abcover_byspecies_NMDS,display="sites",cex=1.25,air=0.01)

str(abcover_byspecies_nmdsprep_num)
#tibble [125 × 34] (S3: tbl_df/tbl/data.frame)
treat=c(rep("treatment1",50),rep("treatment2",50), rep("treatment3",25)) 
ordiplot(abcover_byspecies_NMDS,type="n")
ordihull(abcover_byspecies_NMDS,groups=treat,draw="polygon",col="grey90",
         label=FALSE)
orditorp(abcover_byspecies_NMDS,display="species",col="red",air=0.01)
orditorp(abcover_byspecies_NMDS,display="sites",col=c(rep("green",50),rep("blue",50),re("orange",25)),
         air=0.01,cex=1.25)


```


(7) NMDS by site (e.g., Intact_1)
```{r transpose site percent cover data}

abcover_bysite_nmdsprep <- abcover_byspecies %>% 
  tidyr::spread(site_rep, percentcover) %>% # transpose data so columns are site_rep
  replace(is.na(.), 0) # replace NA with zeros
view(abcover_bysite_nmdsprep)

abcover_bysite_nmdsprep_num <- abcover_bysite_nmdsprep %>% 
  # use the ungroup() function to take out grouping
  ungroup() %>% 
  select(!c(standtype, site, species, status, lifeform, lifecycle, count_per_dist))
         
view(abcover_bysite_nmdsprep_num) # only numbers
```


```{r FROM KIT - nmds by site percent cover}

# stress test with DISTANCE, runs 20 times
# abcover_bysite_NMDS <- metaMDS(abcover_bysite_nmdsprep_num, distance = "raup") 
#In metaMDS(abcover_bysite_nmdsprep_num, distance = "raup") :
#  stress is (nearly) zero: you may have insufficient data

# stress test with AUTOTRANSFORM, runs 20 times
abcover_bysite_NMDS <- metaMDS(abcover_bysite_nmdsprep_num, autotransform = F) 
#In metaMDS(abcover_bysite_nmdsprep_num, autotransform = F) :
#  stress is (nearly) zero: you may have insufficient data

stressplot(abcover_bysite_NMDS)

plot(abcover_bysite_NMDS) 

#basic normal plot
ordiplot(abcover_bysite_NMDS) # without point labels
ordiplot(abcover_bysite_NMDS, type = "t") # with point labels

#ggvegan to make a quick nice plot
autoplot(abcover_bysite_NMDS) # NMDS1 x NMDS2, Key = "Score": sites, species



#this makes a dataframe that gives a lot of control graphically 
abcover_bysite_NMDS_fort <- fortify(abcover_bysite_NMDS)

abcover_bysite_NMDS_fortplot <- ggplot() + 
  geom_point(data = subset(abcover_bysite_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0.5) +
  geom_segment(data = subset(abcover_bysite_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(abcover_bysite_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", linewidth = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#only vectors shown
abcover_bysite_NMDS_fortplot1 <- ggplot() + 
  geom_point(data = subset(abcover_bysite_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0) +
  geom_segment(data = subset(abcover_bysite_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               linewidth = 0.8) +
  geom_text(data = subset(abcover_bysite_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1))+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", linewidth = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#only measurements shown
abcover_bysite_NMDS_fortplot2 <- ggplot() + 
  geom_point(data = subset(abcover_bysite_NMDS_fort, Score == 'sites'),
             mapping = aes(x = NMDS1, y = NMDS2),
             color = 'black',
             alpha = 0.5) +
  geom_segment(data = subset(abcover_bysite_NMDS_fort, Score == 'species'),
               mapping = aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.015, "npc"),
                             type = 'closed'),
               color = 'darkgrey',
               size = 0.8,
               alpha = 0) +
  geom_text(data = subset(abcover_bysite_NMDS_fort, Score == 'species'),
            mapping = aes(label = Label, x = NMDS1*1.1, y = NMDS2*1.1),
            alpha = 0)+
  geom_abline(intercept = 0,slope = 0,linetype = "dashed", size = 0.8,colour = "gray")+
  geom_vline(aes(xintercept = 0), linetype = "dashed", size = 0.8, colour = "gray")+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))

#interactive plots that I like
ggplotly(abcover_bysite_NMDS_fortplot)

#show both plots 
hi_site <- ggarrange(abcover_bysite_NMDS_fortplot1, abcover_bysite_NMDS_fortplot2, ncol = 1)
hi_site


ordiplot(abcover_bysite_NMDS,type="n")
orditorp(abcover_bysite_NMDS,display="species",col="red",air=0.01)
orditorp(abcover_bysite_NMDS,display="sites",cex=1.25,air=0.01)

str()
#tibble [125 × 34] (S3: tbl_df/tbl/data.frame)
treat=c(rep("treatment1",3),rep("treatment2",3), rep("treatment3",3)) 
ordiplot(abcover_bysite_NMDS,type="n")
ordihull(abcover_bysite_NMDS,groups=treat,draw="polygon",col="grey90",
         label=FALSE)
orditorp(abcover_bysite_NMDS,display="species",col="red",air=0.01)
orditorp(abcover_bysite_NMDS,display="sites",col=c(rep("green",6),rep("blue",6),re("orange",3)),
         air=0.01,cex=1.25)




```





```{r set seed }
# *** No convergence -- monoMDS stopping criteria:
#    15: no. of iterations >= maxit
#     1: stress < smin
#     4: scale factor of the gradient < sfgrmin

# set.seed(100)
abcover_bysite_NMDS <- metaMDS(abcover_bysite_nmdsprep_num, distance = "raup") # Runs with stress and a number

str(abcover_bysite_NMDS) # structure of the file, look at the points to get the matrix of numbers and columns (2 columns)
abcover_bysite_NMDS$points # to get the points/values of MDS1 and MDS2
scores(abcover_bysite_NMDS) # scores of your variables
plot(abcover_bysite_NMDS)
```




```{r sandbox nmds}

plot(abcover_bysite_NMDS, type = "n") #displays empty ordination space

points(abcover_bysite_NMDS, display = "sites", pch = c(16, 8, 17, 11) [as.numeric(abcover_bysite_nmdsprep$status)], col = c("blue", "orange", "black") [as.numeric(abcover_bysite_nmdsprep$count_per_dist)]) # displays site points where symbols (pch) are different management options and colour (col) are different land uses

# points(abcover_bysite_NMDS, display = "site_rep", 
#       pch = c(16, 8, 17, 11) [as.numeric(abcover_bysite_nmdsprep_num$site_rep)], 
#       col = c("blue", "orange", "black", "green", "pink", "red", "purple", "teal", #"magenta", "cyan", "yellow", "brown", "light blue", "peach", "lime"),
#       [as.numeric(abcover_bysite_nmdsprep_num$Use)]) # displays site points where #symbols (pch) are different management options and colour (col) are different land uses

legend("topright", legend = c(levels(abcover_bysite_nmdsprep_num$site_rep),
                              levels(abcover_bysite_nmdsprep_num$percent)), 
       pch = c(16, 8, 17, 11, 16, 16, 16), 
       col = c("black","black","black","black","blue", "orange", "black"), 
       bty = "n", cex = 1) # displays symbol and colour legend

legend("topleft", "stress = 0.118", bty = "n", cex = 1) # displays legend text of stress value 

nmds <- ordiplot(abcover_bysite_NMDS, type = "none")
ordipointlabel(abcover_bysite_NMDS,display = "sites",add=TRUE)
```


